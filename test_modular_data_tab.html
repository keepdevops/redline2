<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modular Data Tab - REDLINE</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .test-pass { background-color: #d4edda; color: #155724; }
        .test-fail { background-color: #f8d7da; color: #721c24; }
        .test-info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-cogs me-2"></i>Modular Data Tab Test</h1>
        <p class="text-muted">Testing the modular JavaScript approach for the data tab</p>

        <!-- Test Results -->
        <div id="testResults">
            <h3>Test Results</h3>
            <div id="resultsContainer">
                <!-- Test results will appear here -->
            </div>
        </div>

        <!-- Module Tests -->
        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h4>File Loader Test</h4>
                    <button class="btn btn-primary" onclick="testFileLoader()">Test File Loading</button>
                    <div id="fileLoaderResult"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="test-section">
                    <h4>Data Loader Test</h4>
                    <button class="btn btn-primary" onclick="testDataLoader()">Test Data Loading</button>
                    <div id="dataLoaderResult"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="test-section">
                    <h4>File Selector Test</h4>
                    <select id="testFileSelect" class="form-select mb-2">
                        <option value="">Select a file...</option>
                    </select>
                    <button class="btn btn-primary" onclick="testFileSelector()">Test File Selection</button>
                    <div id="fileSelectorResult"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="test-section">
                    <h4>Data Display Test</h4>
                    <button class="btn btn-primary" onclick="testDataDisplay()">Test Data Display</button>
                    <div id="dataDisplayResult"></div>
                </div>
            </div>
        </div>

        <!-- Controller Test -->
        <div class="test-section">
            <h4>Data Tab Controller Test</h4>
            <button class="btn btn-success" onclick="testController()">Test Full Controller</button>
            <div id="controllerResult"></div>
        </div>

        <!-- Live Data Test -->
        <div class="test-section">
            <h4>Live Data Test</h4>
            <button class="btn btn-info" onclick="testLiveData()">Test with Live Data</button>
            <div id="liveDataResult"></div>
            <div id="liveDataDisplay" class="mt-3"></div>
        </div>
    </div>

    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Load modular JavaScript -->
    <script src="http://localhost:5000/static/js/modules/file-loader.js"></script>
    <script src="http://localhost:5000/static/js/modules/data-loader.js"></script>
    <script src="http://localhost:5000/static/js/modules/file-selector.js"></script>
    <script src="http://localhost:5000/static/js/modules/data-display.js"></script>
    <script src="http://localhost:5000/static/js/modules/button-handler.js"></script>
    <script src="http://localhost:5000/static/js/modules/data-tab-controller.js"></script>

    <script>
        let testResults = [];
        
        function addTestResult(testName, success, message, details = null) {
            const result = {
                name: testName,
                success: success,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.success ? 'test-pass' : 'test-fail'}`;
                div.innerHTML = `
                    <strong>${result.name}:</strong> ${result.success ? 'PASS' : 'FAIL'}<br>
                    <small>${result.message}</small>
                    ${result.details ? `<br><small>Details: ${JSON.stringify(result.details)}</small>` : ''}
                `;
                container.appendChild(div);
            });
        }

        async function testFileLoader() {
            try {
                addTestResult('FileLoader Module Load', typeof FileLoader !== 'undefined', 'FileLoader class available');
                
                const fileLoader = new FileLoader('');
                addTestResult('FileLoader Instance', fileLoader !== null, 'FileLoader instance created');
                
                // Test file loading
                const files = await fileLoader.loadFiles();
                addTestResult('FileLoader API Call', Array.isArray(files), `Loaded ${files.length} files`, { fileCount: files.length });
                
                document.getElementById('fileLoaderResult').innerHTML = `
                    <div class="test-result test-pass">
                        ✓ FileLoader working: ${files.length} files loaded
                    </div>
                `;
                
            } catch (error) {
                addTestResult('FileLoader Test', false, `Error: ${error.message}`);
                document.getElementById('fileLoaderResult').innerHTML = `
                    <div class="test-result test-fail">
                        ✗ FileLoader error: ${error.message}
                    </div>
                `;
            }
        }

        async function testDataLoader() {
            try {
                addTestResult('DataLoader Module Load', typeof DataLoader !== 'undefined', 'DataLoader class available');
                
                const dataLoader = new DataLoader('');
                addTestResult('DataLoader Instance', dataLoader !== null, 'DataLoader instance created');
                
                // Test with a sample file
                const testFile = 'AAPL_yahoo_2024-10-20_to_2025-10-20.csv';
                const data = await dataLoader.loadData(testFile);
                
                addTestResult('DataLoader API Call', data !== null, `Loaded data for ${testFile}`, { 
                    rows: data.total_rows, 
                    columns: data.columns.length 
                });
                
                document.getElementById('dataLoaderResult').innerHTML = `
                    <div class="test-result test-pass">
                        ✓ DataLoader working: ${data.total_rows} rows, ${data.columns.length} columns
                    </div>
                `;
                
            } catch (error) {
                addTestResult('DataLoader Test', false, `Error: ${error.message}`);
                document.getElementById('dataLoaderResult').innerHTML = `
                    <div class="test-result test-fail">
                        ✗ DataLoader error: ${error.message}
                    </div>
                `;
            }
        }

        function testFileSelector() {
            try {
                addTestResult('FileSelector Module Load', typeof FileSelector !== 'undefined', 'FileSelector class available');
                
                const fileSelector = new FileSelector('testFileSelect');
                addTestResult('FileSelector Instance', fileSelector !== null, 'FileSelector instance created');
                
                // Test with sample files
                const sampleFiles = [
                    { name: 'test1.csv', size: 1000 },
                    { name: 'test2.csv', size: 2000 }
                ];
                fileSelector.populateFiles(sampleFiles);
                
                addTestResult('FileSelector Population', true, 'Files populated in selector', { fileCount: sampleFiles.length });
                
                document.getElementById('fileSelectorResult').innerHTML = `
                    <div class="test-result test-pass">
                        ✓ FileSelector working: ${sampleFiles.length} files populated
                    </div>
                `;
                
            } catch (error) {
                addTestResult('FileSelector Test', false, `Error: ${error.message}`);
                document.getElementById('fileSelectorResult').innerHTML = `
                    <div class="test-result test-fail">
                        ✗ FileSelector error: ${error.message}
                    </div>
                `;
            }
        }

        function testDataDisplay() {
            try {
                addTestResult('DataDisplay Module Load', typeof DataDisplay !== 'undefined', 'DataDisplay class available');
                
                const dataDisplay = new DataDisplay('liveDataDisplay');
                addTestResult('DataDisplay Instance', dataDisplay !== null, 'DataDisplay instance created');
                
                // Test with sample data
                const sampleData = [
                    { col1: 'value1', col2: 'value2' },
                    { col1: 'value3', col2: 'value4' }
                ];
                dataDisplay.displayData(sampleData);
                
                addTestResult('DataDisplay Rendering', true, 'Sample data rendered', { rowCount: sampleData.length });
                
                document.getElementById('dataDisplayResult').innerHTML = `
                    <div class="test-result test-pass">
                        ✓ DataDisplay working: ${sampleData.length} rows rendered
                    </div>
                `;
                
            } catch (error) {
                addTestResult('DataDisplay Test', false, `Error: ${error.message}`);
                document.getElementById('dataDisplayResult').innerHTML = `
                    <div class="test-result test-fail">
                        ✗ DataDisplay error: ${error.message}
                    </div>
                `;
            }
        }

        function testController() {
            try {
                addTestResult('DataTabController Module Load', typeof DataTabController !== 'undefined', 'DataTabController class available');
                
                const controller = new DataTabController({
                    apiBaseUrl: '',
                    fileSelectId: 'testFileSelect',
                    loadButtonId: 'testLoadBtn',
                    refreshButtonId: 'testRefreshBtn',
                    dataContainerId: 'liveDataDisplay'
                });
                
                addTestResult('DataTabController Instance', controller !== null, 'DataTabController instance created');
                
                const state = controller.getState();
                addTestResult('Controller State', state !== null, 'Controller state accessible', state);
                
                document.getElementById('controllerResult').innerHTML = `
                    <div class="test-result test-pass">
                        ✓ DataTabController working: State accessible
                    </div>
                `;
                
            } catch (error) {
                addTestResult('DataTabController Test', false, `Error: ${error.message}`);
                document.getElementById('controllerResult').innerHTML = `
                    <div class="test-result test-fail">
                        ✗ DataTabController error: ${error.message}
                    </div>
                `;
            }
        }

        async function testLiveData() {
            try {
                addTestResult('Live Data Test Start', true, 'Starting live data test');
                
                // Test file loading
                const fileLoader = new FileLoader('');
                const files = await fileLoader.loadFiles();
                
                if (files.length > 0) {
                    const firstFile = files[0];
                    addTestResult('Live File Loading', true, `Loaded ${files.length} files`, { firstFile: firstFile.name });
                    
                    // Test data loading
                    const dataLoader = new DataLoader('');
                    const data = await dataLoader.loadData(firstFile.name);
                    
                    addTestResult('Live Data Loading', true, `Loaded ${data.total_rows} rows`, { 
                        filename: firstFile.name,
                        rows: data.total_rows,
                        columns: data.columns.length
                    });
                    
                    // Test data display
                    const dataDisplay = new DataDisplay('liveDataDisplay');
                    dataDisplay.displayData(data.data.slice(0, 10)); // Show first 10 rows
                    
                    addTestResult('Live Data Display', true, 'Data displayed successfully');
                    
                    document.getElementById('liveDataResult').innerHTML = `
                        <div class="test-result test-pass">
                            ✓ Live data test successful: ${data.total_rows} rows from ${firstFile.name}
                        </div>
                    `;
                    
                } else {
                    addTestResult('Live Data Test', false, 'No files available for testing');
                }
                
            } catch (error) {
                addTestResult('Live Data Test', false, `Error: ${error.message}`);
                document.getElementById('liveDataResult').innerHTML = `
                    <div class="test-result test-fail">
                        ✗ Live data test failed: ${error.message}
                    </div>
                `;
            }
        }

        // Run basic tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Modular Data Tab Test Page Loaded');
            
            // Check if all modules are loaded
            const modules = ['FileLoader', 'DataLoader', 'FileSelector', 'DataDisplay', 'DataTabController'];
            modules.forEach(moduleName => {
                const loaded = typeof window[moduleName] !== 'undefined';
                addTestResult(`${moduleName} Module Check`, loaded, loaded ? 'Module loaded successfully' : 'Module not found');
            });
        });
    </script>
</body>
</html>

# License Key Generation and Key Setup Guide

## Overview

This guide covers:
1. How license key generation works in REDLINE
2. What keys/secrets to generate for Render
3. What keys/secrets to generate for Cloudflare R2

## Part 1: License Key Generation in REDLINE

### How It Works

License keys are generated by the **License Server** using:
- Customer email
- Company name
- Timestamp
- **LICENSE_SECRET_KEY** (HMAC-SHA256)

**Format**: `RL-XXXXXXXX-YYYYYYYY-ZZZZZZZZ`

### Running License Server Locally

**Requirements:**
- Python 3.11+
- Flask
- flask-cors

**Start License Server:**
```bash
cd licensing/server
pip install flask flask-cors
python license_server.py
```

Server runs on: `http://localhost:5001`

### Generate License Keys

**Method 1: Via Registration Page (User-Friendly)**
1. Go to `http://localhost:8080/register` (or your deployed URL)
2. Fill out registration form
3. License key is generated automatically
4. Key is displayed immediately

**Method 2: Via API (For Administrators)**
```bash
curl -X POST http://localhost:5001/api/licenses \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john@example.com",
    "company": "Acme Corp",
    "type": "standard",
    "duration_days": 365,
    "hours": 0
  }'
```

**Method 3: Via Main App Proxy**
```bash
curl -X POST https://your-app.onrender.com/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "email": "john@example.com",
    "company": "Acme Corp",
    "type": "standard"
  }'
```

### License Server Requirements

**Environment Variables:**
- `LICENSE_SECRET_KEY` - Secret key for generating license keys (REQUIRED)
- `PORT` - Port to run on (default: 5001)

**Storage:**
- Stores licenses in `licenses.json` file
- File is created automatically
- Persists across restarts

---

## Part 2: Keys/Secrets for Render

### Required Keys to Generate

#### 1. Flask Secret Key

**Purpose**: Encrypts sessions, CSRF tokens, etc.

**Generate:**
```bash
openssl rand -hex 32
```

**Example Output:**
```
a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
```

**Add to Render:**
- **Key**: `SECRET_KEY`
- **Value**: `<generated-key>`

#### 2. License Server Secret Key

**Purpose**: Used to generate and validate license keys

**Generate:**
```bash
openssl rand -hex 32
```

**Example Output:**
```
f9e8d7c6b5a4f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a0f9e8
```

**Add to Render:**
- **Key**: `LICENSE_SECRET_KEY`
- **Value**: `<generated-key>`

**Important**: Use the **SAME** key in both:
- Main REDLINE service (for validation)
- License server service (for generation)

#### 3. Stripe Keys (Get from Stripe Dashboard)

**Get Production Keys:**
1. Go to https://dashboard.stripe.com
2. Toggle to **"Live mode"** (top right)
3. Go to **Developers** → **API keys**
4. Copy:
   - **Secret key** (starts with `sk_live_`)
   - **Publishable key** (starts with `pk_live_`)

**Add to Render:**
- **Key**: `STRIPE_SECRET_KEY`
- **Value**: `sk_live_<your-key>`

- **Key**: `STRIPE_PUBLISHABLE_KEY`
- **Value**: `pk_live_<your-key>`

**Get Webhook Secret:**
1. Go to **Developers** → **Webhooks**
2. Create endpoint: `https://app.redfindat.com/payments/webhook`
3. Copy **Signing secret** (starts with `whsec_`)

**Add to Render:**
- **Key**: `STRIPE_WEBHOOK_SECRET`
- **Value**: `whsec_<your-secret>`

---

## Part 3: Keys/Secrets for Cloudflare R2

### R2 API Tokens

**Purpose**: Access Cloudflare R2 storage (S3-compatible)

**Get R2 Credentials:**

1. **Go to Cloudflare Dashboard**
   - https://dash.cloudflare.com
   - Select your account

2. **Navigate to R2**
   - Click **R2** in left sidebar
   - Or: **Workers & Pages** → **R2**

3. **Create R2 Bucket** (if not exists)
   - Click **"Create bucket"**
   - Name: `redline-data` (or your preferred name)
   - Click **"Create bucket"**

4. **Get API Tokens**
   - Click **"Manage R2 API Tokens"**
   - Click **"Create API token"**
   - **Token name**: `redline-storage` (or descriptive name)
   - **Permissions**: 
     - ✅ **Object Read & Write**
   - Click **"Create API Token"**

5. **Save Credentials** (shown only once!)
   - **Access Key ID**: Copy and save
   - **Secret Access Key**: Copy and save immediately
   - ⚠️ **Secret won't be shown again!**

6. **Get Account ID**
   - Go to Cloudflare Dashboard → **Overview**
   - Copy your **Account ID**

7. **Construct Endpoint URL**
   ```
   https://<account-id>.r2.cloudflarestorage.com
   ```
   
   Example:
   ```
   https://abc123def456.r2.cloudflarestorage.com
   ```

### Add R2 Keys to Render

**Add these environment variables:**

1. **Enable R2 Storage:**
   - **Key**: `USE_S3_STORAGE`
   - **Value**: `true`

2. **R2 Bucket Name:**
   - **Key**: `S3_BUCKET`
   - **Value**: `redline-data` (or your bucket name)

3. **R2 Access Key ID:**
   - **Key**: `S3_ACCESS_KEY`
   - **Value**: `<R2_ACCESS_KEY_ID>` (from step 4)

4. **R2 Secret Access Key:**
   - **Key**: `S3_SECRET_KEY`
   - **Value**: `<R2_SECRET_ACCESS_KEY>` (from step 4)

5. **R2 Region:**
   - **Key**: `S3_REGION`
   - **Value**: `auto` (R2 doesn't use regions like AWS)

6. **R2 Endpoint URL:**
   - **Key**: `S3_ENDPOINT_URL`
   - **Value**: `https://<account-id>.r2.cloudflarestorage.com`

---

## Complete Setup Checklist

### Step 1: Generate Secret Keys

```bash
# Generate Flask secret key
openssl rand -hex 32

# Generate License server secret key
openssl rand -hex 32
```

**Save both keys securely!**

### Step 2: Get Stripe Keys

1. Go to https://dashboard.stripe.com
2. Switch to **Live mode**
3. Get:
   - Secret key (`sk_live_...`)
   - Publishable key (`pk_live_...`)
   - Webhook secret (`whsec_...`)

### Step 3: Get Cloudflare R2 Keys

1. Go to https://dash.cloudflare.com
2. Create R2 bucket
3. Create API token
4. Get:
   - Access Key ID
   - Secret Access Key
   - Account ID (for endpoint URL)

### Step 4: Add All Keys to Render

**Main REDLINE Service:**

```bash
# Application
FLASK_ENV=production
GUNICORN_WORKERS=1
GUNICORN_THREADS=4

# Security Keys (generated)
SECRET_KEY=<openssl-generated-key>
LICENSE_SECRET_KEY=<openssl-generated-key>

# Stripe (from Stripe Dashboard)
STRIPE_SECRET_KEY=sk_live_<your-key>
STRIPE_PUBLISHABLE_KEY=pk_live_<your-key>
STRIPE_WEBHOOK_SECRET=whsec_<your-secret>
HOURS_PER_DOLLAR=0.2
PAYMENT_CURRENCY=usd

# Cloudflare R2 (from Cloudflare Dashboard)
USE_S3_STORAGE=true
S3_BUCKET=redline-data
S3_ACCESS_KEY=<R2_ACCESS_KEY_ID>
S3_SECRET_KEY=<R2_SECRET_ACCESS_KEY>
S3_REGION=auto
S3_ENDPOINT_URL=https://<account-id>.r2.cloudflarestorage.com

# License Server
LICENSE_SERVER_URL=https://license-server-xxxx.onrender.com
REQUIRE_LICENSE_SERVER=false
```

**License Server Service (if deployed separately):**

```bash
# License Server Secret (SAME as main service)
LICENSE_SECRET_KEY=<same-key-as-main-service>

# Port
PORT=5001
```

---

## Quick Reference

### Generate Keys Command

```bash
# Generate all secret keys at once
echo "SECRET_KEY:"
openssl rand -hex 32
echo ""
echo "LICENSE_SECRET_KEY:"
openssl rand -hex 32
```

### Key Locations

| Key | Where to Get | Where to Add |
|-----|--------------|--------------|
| `SECRET_KEY` | Generate with `openssl rand -hex 32` | Render: Main service |
| `LICENSE_SECRET_KEY` | Generate with `openssl rand -hex 32` | Render: Main + License server |
| `STRIPE_SECRET_KEY` | Stripe Dashboard → API keys | Render: Main service |
| `STRIPE_PUBLISHABLE_KEY` | Stripe Dashboard → API keys | Render: Main service |
| `STRIPE_WEBHOOK_SECRET` | Stripe Dashboard → Webhooks | Render: Main service |
| `S3_ACCESS_KEY` | Cloudflare R2 → API Tokens | Render: Main service |
| `S3_SECRET_KEY` | Cloudflare R2 → API Tokens | Render: Main service |
| `S3_ENDPOINT_URL` | Cloudflare Dashboard → Account ID | Render: Main service |

### Testing License Generation

**Local Test:**
```bash
# Start license server
cd licensing/server
python license_server.py

# In another terminal, create license
curl -X POST http://localhost:5001/api/licenses \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "test@example.com",
    "company": "Test Company",
    "type": "standard",
    "hours": 0
  }'
```

**Production Test:**
```bash
# Via registration page
https://app.redfindat.com/register

# Or via API
curl -X POST https://app.redfindat.com/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "email": "test@example.com",
    "company": "Test Company"
  }'
```

---

## Troubleshooting

### License Keys Not Generating

1. **Check LICENSE_SECRET_KEY is set** in license server
2. **Verify license server is running** (check logs)
3. **Check LICENSE_SERVER_URL** is correct in main service

### R2 Storage Not Working

1. **Verify API tokens** are correct
2. **Check endpoint URL** format (must include account ID)
3. **Verify bucket exists** in Cloudflare R2 dashboard
4. **Check permissions** on API token (needs Read & Write)

### Stripe Not Working

1. **Verify keys are production keys** (`sk_live_`, not `sk_test_`)
2. **Check webhook secret** matches Stripe Dashboard
3. **Verify webhook endpoint** is accessible

---

## Security Best Practices

1. **Never commit keys to git**
2. **Use different keys for test/production**
3. **Rotate keys periodically**
4. **Store keys securely** (password manager)
5. **Use environment variables** (not hardcoded)
6. **Limit API token permissions** (least privilege)

---

**See Also:**
- `PRODUCTION_ENV_TEMPLATE.md` - Complete environment variables
- `RENDER_DEPLOYMENT_GUIDE.md` - Render setup
- `CLOUDFLARE_R2_SETUP.md` - R2 detailed setup
- `STRIPE_WEBHOOK_PRODUCTION.md` - Stripe webhook setup


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Tab - REDLINE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .card { margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Data View & Management</h2>
            
            <!-- File List -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-folder-open me-2"></i>Available Data Files</h5>
                </div>
                <div class="card-body">
                    <div id="file-list">
                        <p>Loading files...</p>
                    </div>
                </div>
            </div>
            
            <!-- File Details -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table me-2"></i>File Details</h5>
                </div>
                <div class="card-body">
                    <div id="file-details">
                        <p class="text-muted">Select a file to view details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Basic data tab loaded');
    loadFiles();
});

function loadFiles() {
    console.log('Loading files...');
    
    fetch('/api/files')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Files loaded successfully:', data);
            displayFiles(data.files || []);
        })
        .catch(error => {
            console.error('Error loading files:', error);
            document.getElementById('file-list').innerHTML = `
                <div class="alert alert-danger">
                    <h6>Error Loading Files</h6>
                    <p>Could not load file list. Please check the server connection.</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                </div>
            `;
        });
}

function displayFiles(files) {
    const container = document.getElementById('file-list');
    
    if (files.length === 0) {
        container.innerHTML = '<p class="text-muted">No data files found.</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    
    files.forEach(file => {
        const fileSize = formatFileSize(file.size || 0);
        const modifiedDate = new Date(file.modified * 1000).toLocaleDateString();
        
        html += `
            <div class="list-group-item list-group-item-action" onclick="loadFile('${file.name}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${file.name}</h6>
                    <small class="text-muted">${fileSize}</small>
                </div>
                <small class="text-muted">Modified: ${modifiedDate}</small>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function loadFile(filename) {
    console.log('Loading file:', filename);
    
    const detailsContainer = document.getElementById('file-details');
    detailsContainer.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading ${filename}...</p>
        </div>
    `;
    
    fetch('/data/load', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ filename: filename })
    })
    .then(response => {
        console.log('Load response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('File loaded successfully:', data);
        displayFileData(data);
    })
    .catch(error => {
        console.error('Error loading file:', error);
        detailsContainer.innerHTML = `
            <div class="alert alert-danger">
                <h6>Error Loading File</h6>
                <p>Could not load file: ${filename}</p>
                <p><strong>Error:</strong> ${error.message}</p>
            </div>
        `;
    });
}

function displayFileData(data) {
    console.log('displayFileData called with:', data);
    const container = document.getElementById('file-details');
    
    if (!container) {
        console.error('Container element not found!');
        return;
    }
    
    let html = `
        <div class="alert alert-success">
            <h6>ðŸ“„ ${data.filename}</h6>
            <p><strong>Rows:</strong> ${data.total_rows} | <strong>Columns:</strong> ${data.columns ? data.columns.length : 0}</p>
        </div>
    `;
    
    if (data.columns && data.columns.length > 0) {
        html += '<h6>Columns:</h6>';
        html += '<div class="mb-3">';
        data.columns.forEach(col => {
            // Fix: Handle undefined/null column names
            const displayCol = (col !== null && col !== undefined && col !== '') ? col : 'Column';
            html += `<span class="badge bg-secondary me-1">${displayCol}</span>`;
        });
        html += '</div>';
    }
    
    if (data.data && data.data.length > 0) {
        html += '<h6>Data Preview (first 10 rows):</h6>';
        html += '<div class="table-responsive">';
        html += '<table class="table table-striped table-sm">';
        
        // Headers
        html += '<thead class="table-dark"><tr>';
        if (data.columns) {
            data.columns.forEach(col => {
                // Fix: Handle undefined/null column names
                const displayCol = (col !== null && col !== undefined && col !== '') ? col : 'Column';
                html += `<th>${displayCol}</th>`;
            });
        }
        html += '</tr></thead>';
        
        // Data rows
        html += '<tbody>';
        data.data.slice(0, 10).forEach(row => {
            html += '<tr>';
            if (data.columns) {
                data.columns.forEach(col => {
                    html += `<td>${row[col] || ''}</td>`;
                });
            }
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        
        if (data.data.length > 10) {
            html += `<p class="text-muted">Showing first 10 of ${data.data.length} rows</p>`;
        }
    } else {
        html += '<div class="alert alert-warning">No data found in file</div>';
    }
    
    container.innerHTML = html;
    console.log('Data display completed');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
</body>
</html>
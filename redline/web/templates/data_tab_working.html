{% extends "base.html" %}
<!-- FIXED TEMPLATE - Uses /api/files endpoint -->

{% block title %}Data Tab - REDLINE{% endblock %}

{% block page_title %}Data Viewing & Filtering{% endblock %}
{% block page_subtitle %}View, filter, and manage your financial data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- File Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>Select Data File
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <select id="fileSelect" class="form-select">
                            <option value="">Select a file to load...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="loadFileBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-upload me-2"></i>Load File
                        </button>
                        <button id="refreshFilesBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div id="dataTableSection" class="card" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>Data Preview
                    </h5>
                    <div class="btn-group">
                        <button id="exportBtn" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <button id="refreshDataBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="dataInfo" class="mb-3">
                    <!-- Data info will be displayed here -->
                </div>
                <div id="dataTableContainer">
                    <!-- Data table will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let currentData = null;

$(document).ready(function() {
    console.log('FIXED Data tab loaded - using /api/files endpoint');
    
    // Load file list immediately
    loadFileList();
    
    // Event handlers
    $('#fileSelect').on('change', function() {
        const selectedFile = $(this).val();
        $('#loadFileBtn').prop('disabled', !selectedFile);
        console.log('File selected:', selectedFile);
    });
    
    $('#loadFileBtn').on('click', function() {
        const selectedFile = $('#fileSelect').val();
        console.log('Load button clicked for file:', selectedFile);
        if (selectedFile) {
            loadData(selectedFile);
        }
    });
    
    $('#refreshFilesBtn').on('click', function() {
        console.log('Refresh button clicked');
        loadFileList();
    });
    
    $('#refreshDataBtn').on('click', function() {
        if (currentFile) {
            loadData(currentFile);
        }
    });
});

function loadFileList() {
    console.log('FIXED: Loading file list from /api/files');
    
    $.ajax({
        url: '/api/files',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log('FIXED: Files loaded successfully:', response.files.length, 'files');
            const select = $('#fileSelect');
            select.empty();
            select.append('<option value="">Select a file to load...</option>');
            
            if (response.files && response.files.length > 0) {
                response.files.forEach(file => {
                    const fileSize = formatFileSize(file.size || 0);
                    select.append(`<option value="${file.name}">${file.name} (${fileSize})</option>`);
                });
                console.log('FIXED: Files added to dropdown successfully');
            } else {
                select.append('<option value="">No files found</option>');
                console.log('FIXED: No files found');
            }
        },
        error: function(xhr, status, error) {
            console.error('FIXED: Error loading files:', error);
            console.error('FIXED: Response:', xhr.responseText);
            $('#fileSelect').empty().append('<option value="">Error loading files</option>');
        }
    });
}

function loadData(filename) {
    console.log('FIXED: Loading data for file:', filename);
    
    // Show loading message
    $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading data...</div>');
    
    // Use EXACT same data loading as tkinter GUI
    $.ajax({
        url: '/data/load',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ filename: filename }),
        dataType: 'json',
        success: function(response) {
            console.log('FIXED: Data loaded successfully:', response.total_rows, 'rows');
            currentFile = filename;
            currentData = response.data;
            
            // Show data table section
            $('#dataTableSection').show();
            
            // Display data in table
            displayDataInTable(response.data);
            
            // Update data info
            updateDataInfo({
                total_rows: response.total_rows,
                columns: response.columns,
                filename: response.filename
            });
        },
        error: function(xhr, status, error) {
            console.error('FIXED: Error loading data:', error);
            $('#dataTableContainer').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading data: ' + error + '</div>');
        }
    });
}

function displayDataInTable(data) {
    console.log('FIXED: Displaying data in table:', data.length, 'rows');
    
    if (!data || data.length === 0) {
        $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-info-circle me-2"></i>No data to display</div>');
        return;
    }
    
    // Create HTML table
    let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-dark"><tr>';
    
    // Add headers from first row
    const headers = Object.keys(data[0]);
    headers.forEach(header => {
        tableHtml += `<th>${header}</th>`;
    });
    tableHtml += '</tr></thead><tbody>';
    
    // Add data rows (limit to first 100 rows for performance)
    const maxRows = Math.min(data.length, 100);
    for (let i = 0; i < maxRows; i++) {
        tableHtml += '<tr>';
        headers.forEach(header => {
            const value = data[i][header];
            tableHtml += `<td>${value !== null && value !== undefined ? value : ''}</td>`;
        });
        tableHtml += '</tr>';
    }
    
    tableHtml += '</tbody></table></div>';
    
    if (data.length > 100) {
        tableHtml += `<div class="text-center p-2"><small class="text-muted">Showing first 100 of ${data.length} rows</small></div>`;
    }
    
    $('#dataTableContainer').html(tableHtml);
}

function updateDataInfo(data) {
    const infoHtml = `
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.total_rows || 0}</div>
                    <div class="stats-label">Total Rows</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.columns ? data.columns.length : 0}</div>
                    <div class="stats-label">Columns</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <div class="stats-label">File: ${data.filename || 'Unknown'}</div>
                </div>
            </div>
        </div>
    `;
    $('#dataInfo').html(infoHtml);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}





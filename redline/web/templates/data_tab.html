{% extends "base.html" %}
<!-- Updated: 2025-10-20 11:55:00 - CACHE BUST - Fixed JavaScript to use /api/files -->

{% block title %}Data Tab - REDLINE{% endblock %}

{% block extra_css %}
<style>
    /* Table headers use theme variables - same for all themes including dark */
    .table thead th,
    .table thead.table-dark th {
        background-color: var(--dark-color) !important;
        color: var(--text-white) !important;
        border-bottom: 2px solid var(--border-color) !important;
    }
    
    /* Ensure table headers are always visible */
    .table thead {
        display: table-header-group !important;
        visibility: visible !important;
    }
    
    .table thead th {
        display: table-cell !important;
        visibility: visible !important;
    }
</style>
{% endblock %}

{% block page_title %}Data Viewing & Filtering{% endblock %}
{% block page_subtitle %}View, filter, and manage your financial data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- File Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>Select Data File
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <select id="fileSelect" class="form-select">
                            <option value="">Select a file to load...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="loadFileBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-upload me-2"></i>Load File
                        </button>
                        <button id="refreshFilesBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div id="dataTableSection" class="card" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>Data Preview
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="input-group" style="width: auto;">
                            <label class="input-group-text" for="dateFormatSelect" style="margin-bottom: 0;">
                                <i class="fas fa-calendar-alt me-1"></i>Date Format:
                            </label>
                            <select id="dateFormatSelect" class="form-select" style="width: auto;">
                                <option value="auto">Auto (YYYY-MM-DD)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY/MM/DD">YYYY/MM/DD</option>
                                <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                <option value="MM-DD-YYYY">MM-DD-YYYY</option>
                                <option value="raw">Raw (No Formatting)</option>
                            </select>
                        </div>
                        <div class="btn-group">
                            <button id="exportBtn" class="btn btn-outline-primary">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                            <button id="refreshDataBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="dataInfo" class="mb-3">
                    <!-- Data info will be displayed here -->
                </div>
                <div id="dataTableContainer">
                    <!-- Data table will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let currentData = null;
let currentColumns = null;

$(document).ready(function() {
    console.log('Data tab loaded - using tkinter-style data loading');
    
    // Load saved date format preference
    const savedDateFormat = localStorage.getItem('redline-date-format') || 'auto';
    $('#dateFormatSelect').val(savedDateFormat);
    
    // Load file list on page load
    loadFileList();
    
    // Event handlers
    $('#fileSelect').on('change', function() {
        const selectedFile = $(this).val();
        $('#loadFileBtn').prop('disabled', !selectedFile);
    });
    
    $('#loadFileBtn').on('click', function() {
        const selectedFile = $('#fileSelect').val();
        if (selectedFile) {
            loadData(selectedFile);
        }
    });
    
    $('#refreshFilesBtn').on('click', function() {
        loadFileList();
    });
    
    $('#refreshDataBtn').on('click', function() {
        if (currentFile) {
            loadData(currentFile);
        }
    });
    
    // Date format change handler - re-render table with new format
    $('#dateFormatSelect').on('change', function() {
        const selectedFormat = $(this).val();
        localStorage.setItem('redline-date-format', selectedFormat);
        console.log('Date format changed to:', selectedFormat);
        
        // Re-render table if data is already loaded (pass columns to preserve headers)
        if (currentData && currentData.length > 0) {
            console.log('Re-rendering table with new date format, columns:', currentColumns);
            displayDataInTable(currentData, currentColumns);
        }
    });
});

function loadFileList() {
    console.log('CACHE BUST: Loading file list from /api/files - ' + new Date().toISOString());
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        $('#fileSelect').empty().append('<option value="">License key required - Please register</option>');
        return;
    }
    
    console.log('Loading files with license key:', licenseKey.substring(0, 20) + '...');
    
    // Use jQuery ajax - the override in base.html will automatically add the license key
    // But we also include it explicitly here as a backup
    // Don't set dataType to 'json' to avoid parsing errors on HTML responses
    $.ajax({
        url: '/api/files',
        method: 'GET',
        headers: {
            'X-License-Key': licenseKey,  // Explicit header (jQuery override will also add it)
            'Accept': 'application/json'  // Request JSON, but handle HTML gracefully
        },
        data: {
            license_key: licenseKey  // Also in query params as backup
        },
        // Don't set dataType - let jQuery auto-detect, but handle both JSON and HTML
        success: function(response, textStatus, xhr) {
            // Check if response is actually JSON
            if (typeof response === 'object' && response.files) {
                console.log('✅ Files loaded:', response.files.length);
                const select = $('#fileSelect');
                select.empty();
                select.append('<option value="">Select a file to load...</option>');
                
                if (response.files && response.files.length > 0) {
                    response.files.forEach(file => {
                        const fileSize = formatFileSize(file.size || 0);
                        select.append(`<option value="${file.name}">${file.name} (${fileSize})</option>`);
                    });
                } else {
                    select.append('<option value="">No files found</option>');
                }
            } else {
                // Response is not JSON, treat as error
                throw new Error('Invalid response format');
            }
        },
        error: function(xhr, status, error) {
            console.error('❌ Error loading files:', error);
            console.error('Status:', xhr.status);
            console.error('Response type:', xhr.getResponseHeader('Content-Type'));
            console.error('Response text (first 200 chars):', xhr.responseText ? xhr.responseText.substring(0, 200) : 'No response');
            
            let errorMsg = 'Error loading files';
            
            // Handle rate limiting (429)
            if (xhr.status === 429) {
                const retryAfter = xhr.getResponseHeader('Retry-After');
                if (retryAfter) {
                    const minutes = Math.ceil(parseInt(retryAfter) / 60);
                    errorMsg = `Too many requests - please wait ${minutes} minute(s)`;
                } else {
                    errorMsg = 'Too many requests - please wait a moment';
                }
            }
            // Check if response is HTML (error page) instead of JSON
            else if (xhr.responseText && (xhr.responseText.trim().startsWith('<!') || xhr.responseText.includes('<html'))) {
                // Response is HTML, not JSON
                if (xhr.status === 404) {
                    errorMsg = 'API endpoint not found';
                } else if (xhr.status >= 500) {
                    errorMsg = 'Server error - please try again later';
                } else if (xhr.status === 429) {
                    errorMsg = 'Too many requests - please wait';
                } else {
                    errorMsg = 'Error: ' + xhr.status + ' ' + (xhr.statusText || 'Unknown error');
                }
            }
            // Try to parse JSON error if available (jQuery might have parsed it)
            else {
                try {
                    const jsonResponse = typeof xhr.responseJSON !== 'undefined' ? xhr.responseJSON : JSON.parse(xhr.responseText);
                    if (jsonResponse && jsonResponse.error) {
                        errorMsg = jsonResponse.error;
                    }
                } catch (e) {
                    // Not JSON, use status-based message
                    if (xhr.status === 0) {
                        errorMsg = 'Network error - check connection';
                    } else if (status === 'parsererror') {
                        errorMsg = 'Invalid response from server';
                    }
                }
            }
            
            $('#fileSelect').empty().append(`<option value="">${errorMsg}</option>`);
        }
    });
}

function loadData(filename) {
    console.log('Loading data for file:', filename);
    
    // Show loading message
    $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading data...</div>');
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        $('#dataTableContainer').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>License key is required. Please register or enter your license key.</div>');
        return;
    }
    
    console.log('Using license key:', licenseKey.substring(0, 20) + '...');
    
    // Use jQuery ajax - the override in base.html will automatically add the license key
    // But we also include it explicitly here as a backup
    $.ajax({
        url: '/data/load',
        method: 'POST',
        contentType: 'application/json',
        headers: {
            'X-License-Key': licenseKey  // Explicit header (jQuery override will also add it)
        },
        data: JSON.stringify({ 
            filename: filename, 
            license_key: licenseKey  // Also in body as backup
        }),
        dataType: 'json',
        success: function(response) {
            console.log('✅ Data loaded successfully:', response.total_rows, 'rows');
            console.log('Response columns:', response.columns);
            console.log('Response data sample:', response.data ? response.data[0] : 'No data');
            currentFile = filename;
            currentData = response.data;
            currentColumns = response.columns;  // Store columns for date format changes
            
            // Show data table section
            $('#dataTableSection').show();
            
            // Display data in table (pass both data and columns)
            displayDataInTable(response.data, response.columns);
            
            // Update data info
            updateDataInfo({
                total_rows: response.total_rows,
                columns: response.columns,
                filename: response.filename
            });
        },
        error: function(xhr, status, error) {
            console.error('❌ Error loading data:', error);
            console.error('Response:', xhr.responseText);
            let errorMsg = error;
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            $('#dataTableContainer').html(
                '<div class="text-center p-4 text-danger">' +
                '<i class="fas fa-exclamation-triangle me-2"></i>' +
                'Error loading data: ' + errorMsg +
                '<br><small>Status: ' + xhr.status + '</small>' +
                '</div>'
            );
        }
    });
}

// formatDateValue() is now loaded from redline/web/static/js/date-formatter.js
// No need to define it here - it's available globally from base.html

function displayDataInTable(data, columns) {
    console.log('Displaying data in table:', data ? data.length : 0, 'rows');
    console.log('Columns provided:', columns);
    
    if (!data || data.length === 0) {
        $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-info-circle me-2"></i>No data to display</div>');
        return;
    }
    
    // Create HTML table
    let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-dark"><tr>';
    
    // Get headers - prefer provided columns, fallback to Object.keys
    let headers = [];
    if (columns && Array.isArray(columns) && columns.length > 0) {
        headers = columns;
        console.log('Using provided columns:', headers);
    } else if (data && data.length > 0 && data[0]) {
        headers = Object.keys(data[0]);
        console.log('Extracted headers from data:', headers);
    } else {
        console.error('No columns available and no data to extract from');
        $('#dataTableContainer').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>No column headers available</div>');
        return;
    }
    
    // Add headers to table
    headers.forEach((header, index) => {
        // Fix: Handle undefined/null headers
        const displayHeader = (header !== null && header !== undefined && header !== '') ? String(header) : `Column_${index + 1}`;
        tableHtml += `<th>${displayHeader}</th>`;
    });
    tableHtml += '</tr></thead><tbody>';
    
    // Add data rows (limit to first 100 rows for performance)
    const maxRows = Math.min(data.length, 100);
    for (let i = 0; i < maxRows; i++) {
        tableHtml += '<tr>';
        headers.forEach(header => {
            const value = data[i][header];
            // Format date values (YYYYMMDD -> YYYY-MM-DD)
            let formattedValue = formatDateValue(value, header);
            // Format time values (HHMMSS -> HH:MM:SS)
            // Use original value, not date-formatted value, for time formatting
            if (typeof formatTimeValue === 'function') {
                formattedValue = formatTimeValue(value, header);
            }
            tableHtml += `<td>${formattedValue !== null && formattedValue !== undefined ? formattedValue : ''}</td>`;
        });
        tableHtml += '</tr>';
    }
    
    tableHtml += '</tbody></table></div>';
    
    if (data.length > 100) {
        tableHtml += `<div class="text-center p-2"><small class="text-muted">Showing first 100 of ${data.length} rows</small></div>`;
    }
    
    $('#dataTableContainer').html(tableHtml);
}

function updateDataInfo(data) {
    const infoHtml = `
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.total_rows || 0}</div>
                    <div class="stats-label">Total Rows</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.columns ? data.columns.length : 0}</div>
                    <div class="stats-label">Columns</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <div class="stats-label">File: ${data.filename || 'Unknown'}</div>
                </div>
            </div>
        </div>
    `;
    $('#dataInfo').html(infoHtml);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}

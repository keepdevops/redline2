{% extends "base.html" %}
<!-- Updated: 2025-10-20 11:55:00 - CACHE BUST - Fixed JavaScript to use /api/files -->

{% block title %}Data Tab - REDLINE{% endblock %}

{% block page_title %}Data Viewing & Filtering{% endblock %}
{% block page_subtitle %}View, filter, and manage your financial data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- File Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>Select Data File
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <select id="fileSelect" class="form-select">
                            <option value="">Select a file to load...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="loadFileBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-upload me-2"></i>Load File
                        </button>
                        <button id="refreshFilesBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div id="dataTableSection" class="card" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>Data Preview
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="input-group" style="width: auto;">
                            <label class="input-group-text" for="dateFormatSelect" style="margin-bottom: 0;">
                                <i class="fas fa-calendar-alt me-1"></i>Date Format:
                            </label>
                            <select id="dateFormatSelect" class="form-select" style="width: auto;">
                                <option value="auto">Auto (YYYY-MM-DD)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY/MM/DD">YYYY/MM/DD</option>
                                <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                <option value="MM-DD-YYYY">MM-DD-YYYY</option>
                                <option value="raw">Raw (No Formatting)</option>
                            </select>
                        </div>
                        <div class="btn-group">
                            <button id="exportBtn" class="btn btn-outline-primary">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                            <button id="refreshDataBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="dataInfo" class="mb-3">
                    <!-- Data info will be displayed here -->
                </div>
                <div id="dataTableContainer">
                    <!-- Data table will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let currentData = null;

$(document).ready(function() {
    console.log('Data tab loaded - using tkinter-style data loading');
    
    // Load saved date format preference
    const savedDateFormat = localStorage.getItem('redline-date-format') || 'auto';
    $('#dateFormatSelect').val(savedDateFormat);
    
    // Load file list on page load
    loadFileList();
    
    // Event handlers
    $('#fileSelect').on('change', function() {
        const selectedFile = $(this).val();
        $('#loadFileBtn').prop('disabled', !selectedFile);
    });
    
    $('#loadFileBtn').on('click', function() {
        const selectedFile = $('#fileSelect').val();
        if (selectedFile) {
            loadData(selectedFile);
        }
    });
    
    $('#refreshFilesBtn').on('click', function() {
        loadFileList();
    });
    
    $('#refreshDataBtn').on('click', function() {
        if (currentFile) {
            loadData(currentFile);
        }
    });
    
    // Date format change handler - re-render table with new format
    $('#dateFormatSelect').on('change', function() {
        const selectedFormat = $(this).val();
        localStorage.setItem('redline-date-format', selectedFormat);
        
        // Re-render table if data is already loaded
        if (currentData && currentData.length > 0) {
            displayDataInTable(currentData);
        }
    });
});

function loadFileList() {
    console.log('CACHE BUST: Loading file list from /api/files - ' + new Date().toISOString());
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        $('#fileSelect').empty().append('<option value="">License key required - Please register</option>');
        return;
    }
    
    console.log('Loading files with license key:', licenseKey.substring(0, 20) + '...');
    
    // Use jQuery ajax - the override in base.html will automatically add the license key
    // But we also include it explicitly here as a backup
    $.ajax({
        url: '/api/files',
        method: 'GET',
        headers: {
            'X-License-Key': licenseKey  // Explicit header (jQuery override will also add it)
        },
        data: {
            license_key: licenseKey  // Also in query params as backup
        },
        dataType: 'json',
        success: function(response) {
            console.log('✅ Files loaded:', response.files.length);
            const select = $('#fileSelect');
            select.empty();
            select.append('<option value="">Select a file to load...</option>');
            
            if (response.files && response.files.length > 0) {
                response.files.forEach(file => {
                    const fileSize = formatFileSize(file.size || 0);
                    select.append(`<option value="${file.name}">${file.name} (${fileSize})</option>`);
                });
            } else {
                select.append('<option value="">No files found</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('❌ Error loading files:', error);
            console.error('Response:', xhr.responseText);
            let errorMsg = 'Error loading files';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            $('#fileSelect').empty().append(`<option value="">${errorMsg}</option>`);
        }
    });
}

function loadData(filename) {
    console.log('Loading data for file:', filename);
    
    // Show loading message
    $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading data...</div>');
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        $('#dataTableContainer').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>License key is required. Please register or enter your license key.</div>');
        return;
    }
    
    console.log('Using license key:', licenseKey.substring(0, 20) + '...');
    
    // Use jQuery ajax - the override in base.html will automatically add the license key
    // But we also include it explicitly here as a backup
    $.ajax({
        url: '/data/load',
        method: 'POST',
        contentType: 'application/json',
        headers: {
            'X-License-Key': licenseKey  // Explicit header (jQuery override will also add it)
        },
        data: JSON.stringify({ 
            filename: filename, 
            license_key: licenseKey  // Also in body as backup
        }),
        dataType: 'json',
        success: function(response) {
            console.log('✅ Data loaded successfully:', response.total_rows, 'rows');
            currentFile = filename;
            currentData = response.data;
            
            // Show data table section
            $('#dataTableSection').show();
            
            // Display data in table
            displayDataInTable(response.data);
            
            // Update data info
            updateDataInfo({
                total_rows: response.total_rows,
                columns: response.columns,
                filename: response.filename
            });
        },
        error: function(xhr, status, error) {
            console.error('❌ Error loading data:', error);
            console.error('Response:', xhr.responseText);
            let errorMsg = error;
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            $('#dataTableContainer').html(
                '<div class="text-center p-4 text-danger">' +
                '<i class="fas fa-exclamation-triangle me-2"></i>' +
                'Error loading data: ' + errorMsg +
                '<br><small>Status: ' + xhr.status + '</small>' +
                '</div>'
            );
        }
    });
}

// Helper function to format YYYYMMDD numeric dates to readable format
function formatDateValue(value, header) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    
    // Get selected date format (default to 'auto')
    const dateFormat = $('#dateFormatSelect').val() || localStorage.getItem('redline-date-format') || 'auto';
    
    // If format is 'raw', return original value
    if (dateFormat === 'raw') {
        return value;
    }
    
    // Convert to string and remove any commas (thousands separators)
    const strValue = String(value).replace(/,/g, '');
    
    // Check if it's a numeric value that could be YYYYMMDD format
    // YYYYMMDD format: 8 digits, between 19000101 and 21001231
    let year = null, month = null, day = null;
    let isValidDate = false;
    
    if (/^\d{8}$/.test(strValue)) {
        const numValue = parseInt(strValue, 10);
        if (numValue >= 19000101 && numValue <= 21001231) {
            // Extract year, month, day
            year = Math.floor(numValue / 10000);
            month = Math.floor((numValue % 10000) / 100);
            day = numValue % 100;
            
            // Validate month and day
            if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                // Check if the date is valid (e.g., not Feb 30)
                const dateObj = new Date(year, month - 1, day);
                if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                    isValidDate = true;
                }
            }
        }
    }
    
    // Also check for column names that suggest dates
    if (!isValidDate) {
        const headerLower = String(header || '').toLowerCase();
        if (headerLower.includes('date') || headerLower.includes('time') || headerLower.includes('timestamp')) {
            // Try to parse as YYYYMMDD
            if (/^\d{8}$/.test(strValue)) {
                const numValue = parseInt(strValue, 10);
                if (numValue >= 19000101 && numValue <= 21001231) {
                    year = Math.floor(numValue / 10000);
                    month = Math.floor((numValue % 10000) / 100);
                    day = numValue % 100;
                    if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                        const dateObj = new Date(year, month - 1, day);
                        if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                            isValidDate = true;
                        }
                    }
                }
            }
        }
    }
    
    // If we have a valid date, format it according to user preference
    if (isValidDate && year && month && day) {
        const monthStr = String(month).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        const yearStr = String(year);
        
        switch (dateFormat) {
            case 'YYYY-MM-DD':
            case 'auto':  // Default to YYYY-MM-DD
                return `${yearStr}-${monthStr}-${dayStr}`;
            case 'MM/DD/YYYY':
                return `${monthStr}/${dayStr}/${yearStr}`;
            case 'DD/MM/YYYY':
                return `${dayStr}/${monthStr}/${yearStr}`;
            case 'YYYY/MM/DD':
                return `${yearStr}/${monthStr}/${dayStr}`;
            case 'DD-MM-YYYY':
                return `${dayStr}-${monthStr}-${yearStr}`;
            case 'MM-DD-YYYY':
                return `${monthStr}-${dayStr}-${yearStr}`;
            default:
                return `${yearStr}-${monthStr}-${dayStr}`;
        }
    }
    
    // Return original value if not a date
    return value;
}

function displayDataInTable(data) {
    console.log('Displaying data in table:', data.length, 'rows');
    
    if (!data || data.length === 0) {
        $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-info-circle me-2"></i>No data to display</div>');
        return;
    }
    
    // Create HTML table
    let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-dark"><tr>';
    
    // Add headers from first row
    const headers = Object.keys(data[0]);
    headers.forEach(header => {
        // Fix: Handle undefined/null headers
        const displayHeader = (header !== null && header !== undefined && header !== '') ? header : 'Column';
        tableHtml += `<th>${displayHeader}</th>`;
    });
    tableHtml += '</tr></thead><tbody>';
    
    // Add data rows (limit to first 100 rows for performance)
    const maxRows = Math.min(data.length, 100);
    for (let i = 0; i < maxRows; i++) {
        tableHtml += '<tr>';
        headers.forEach(header => {
            const value = data[i][header];
            // Format date values (YYYYMMDD -> YYYY-MM-DD)
            const formattedValue = formatDateValue(value, header);
            tableHtml += `<td>${formattedValue !== null && formattedValue !== undefined ? formattedValue : ''}</td>`;
        });
        tableHtml += '</tr>';
    }
    
    tableHtml += '</tbody></table></div>';
    
    if (data.length > 100) {
        tableHtml += `<div class="text-center p-2"><small class="text-muted">Showing first 100 of ${data.length} rows</small></div>`;
    }
    
    $('#dataTableContainer').html(tableHtml);
}

function updateDataInfo(data) {
    const infoHtml = `
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.total_rows || 0}</div>
                    <div class="stats-label">Total Rows</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.columns ? data.columns.length : 0}</div>
                    <div class="stats-label">Columns</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <div class="stats-label">File: ${data.filename || 'Unknown'}</div>
                </div>
            </div>
        </div>
    `;
    $('#dataInfo').html(infoHtml);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Data Tab - REDLINE{% endblock %}

{% block page_title %}Data Viewing & Filtering{% endblock %}
{% block page_subtitle %}View, filter, and manage your financial data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- File Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>Select Data File
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <select id="fileSelect" class="form-select">
                            <option value="">Select a file to load...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="loadFileBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-upload me-2"></i>Load File
                        </button>
                        <button id="refreshFilesBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div id="filterSection" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Data Filters
                </h5>
            </div>
            <div class="card-body">
                <div id="filterContainer">
                    <!-- Filters will be dynamically added here -->
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button id="addFilterBtn" class="btn btn-outline-primary">
                            <i class="fas fa-plus me-2"></i>Add Filter
                        </button>
                        <button id="clearFiltersBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-trash me-2"></i>Clear All
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="applyFiltersBtn" class="btn btn-success">
                            <i class="fas fa-check me-2"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div id="dataTableSection" class="card" style="display: none;">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>Data Preview
                    </h5>
                    <div class="btn-group">
                        <button id="exportBtn" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <button id="refreshDataBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="dataInfo" class="mb-3">
                    <!-- Data info will be displayed here -->
                </div>
                <div id="dataTableContainer">
                    <!-- Virtual scrolling data table will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let currentData = null;
let currentFilters = {};
let virtualTable = null;

$(document).ready(function() {
    console.log('Document ready - jQuery version:', $.fn.jquery);
    console.log('REDLINE object available:', typeof REDLINE !== 'undefined');
    console.log('Data tab page loaded successfully');
    
    // Test if jQuery is working
    console.log('File select element found:', $('#fileSelect').length);
    
    
    // Add a small delay to ensure everything is loaded
    setTimeout(function() {
        console.log('Loading file list after timeout...');
        loadFileList();
    }, 100);
    
    // Event handlers
    $('#fileSelect').on('change', function() {
        const selectedFile = $(this).val();
        $('#loadFileBtn').prop('disabled', !selectedFile);
    });
    
    $('#loadFileBtn').on('click', function() {
        const selectedFile = $('#fileSelect').val();
        if (selectedFile) {
            loadData(selectedFile);
        }
    });
    
    $('#refreshFilesBtn').on('click', function() {
        console.log('Refresh button clicked');
        loadFileList();
    });
    
    $('#addFilterBtn').on('click', function() {
        addFilter();
    });
    
    $('#clearFiltersBtn').on('click', function() {
        clearFilters();
    });
    
    $('#applyFiltersBtn').on('click', function() {
        applyFilters();
    });
    
    $('#exportBtn').on('click', function() {
        exportData();
    });
    
    $('#refreshDataBtn').on('click', function() {
        if (currentFile) {
            loadData(currentFile);
        }
    });
});

function loadFileList() {
    console.log('loadFileList called - starting AJAX request to /data/files');
    
    try {
        // Use jQuery directly instead of REDLINE object
        $.ajax({
            url: '/data/files',
            method: 'GET',
            dataType: 'json',
            success: function(response) {
                console.log('API response:', response);
                const select = $('#fileSelect');
                select.empty();
                select.append('<option value="">Select a file to load...</option>');
                
                if (response.files && response.files.length > 0) {
                    console.log('Found', response.files.length, 'files');
                    response.files.forEach(file => {
                        const fileSize = (file.size || 0);
                        select.append(`<option value="${file.name}">${file.name} (${fileSize} bytes)</option>`);
                    });
                    console.log('Files added to dropdown successfully');
                } else {
                    console.log('No files found in response');
                    select.append('<option value="">No files found</option>');
                }
            },
            error: function(xhr, status, error) {
                console.error('API error:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                $('#fileSelect').empty().append('<option value="">Error loading files</option>');
            }
        });
    } catch (e) {
        console.error('Error in loadFileList:', e);
        $('#fileSelect').empty().append('<option value="">JavaScript error</option>');
    }
}

// Utility function for formatting file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function loadData(filename) {
    console.log('Loading data for file:', filename);
    
    // Show loading message
    $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading data...</div>');
    
    try {
        // Load data using direct AJAX call
        $.ajax({
            url: '/data/load',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ filename: filename }),
            dataType: 'json',
            success: function(response) {
                console.log('Data loaded successfully:', response);
                currentFile = filename;
                currentData = response.data;
                
                // Show filter section
                $('#filterSection').show();
                
                // Show data table section
                $('#dataTableSection').show();
                
                // Display data in simple table
                displayDataInTable(response.data);
                
                // Update data info
                updateDataInfo({
                    total_rows: response.total_rows,
                    columns: response.columns,
                    file_size: response.file_size,
                    filename: response.filename
                });
            },
            error: function(xhr, status, error) {
                console.error('Error loading data:', error);
                $('#dataTableContainer').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading data: ' + error + '</div>');
            }
        });
    } catch (e) {
        console.error('Error in loadData:', e);
        $('#dataTableContainer').html('<div class="text-center p-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>JavaScript error loading data</div>');
    }
}

function displayDataInTable(data) {
    console.log('Displaying data in table:', data.length, 'rows');
    
    if (!data || data.length === 0) {
        $('#dataTableContainer').html('<div class="text-center p-4"><i class="fas fa-info-circle me-2"></i>No data to display</div>');
        return;
    }
    
    // Create a simple HTML table
    let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-dark"><tr>';
    
    // Add headers from first row
    const headers = Object.keys(data[0]);
    headers.forEach(header => {
        tableHtml += `<th>${header}</th>`;
    });
    tableHtml += '</tr></thead><tbody>';
    
    // Add data rows (limit to first 100 rows for performance)
    const maxRows = Math.min(data.length, 100);
    for (let i = 0; i < maxRows; i++) {
        tableHtml += '<tr>';
        headers.forEach(header => {
            const value = data[i][header];
            tableHtml += `<td>${value !== null && value !== undefined ? value : ''}</td>`;
        });
        tableHtml += '</tr>';
    }
    
    tableHtml += '</tbody></table></div>';
    
    if (data.length > 100) {
        tableHtml += `<div class="text-center p-2"><small class="text-muted">Showing first 100 of ${data.length} rows</small></div>`;
    }
    
    $('#dataTableContainer').html(tableHtml);
}

function updateDataInfo(data) {
    const infoHtml = `
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.total_rows || 0}</div>
                    <div class="stats-label">Total Rows</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${data.columns.length}</div>
                    <div class="stats-label">Columns</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${currentFilters ? Object.keys(currentFilters).length : 0}</div>
                    <div class="stats-label">Active Filters</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">${formatFileSize(data.file_size || 0)}</div>
                    <div class="stats-label">File Size</div>
                </div>
            </div>
        </div>
    `;
    
    $('#dataInfo').html(infoHtml);
}

// createDataTable function removed - now using VirtualScrollTable

function createFilterOptions(columns) {
    const container = $('#filterContainer');
    container.empty();
    
    // Create filter options for each column
    columns.forEach(column => {
        const filterHtml = `
            <div class="row mb-3 filter-row" data-column="${column}">
                <div class="col-md-3">
                    <label class="form-label">Column</label>
                    <select class="form-select filter-column" disabled>
                        <option value="${column}">${column}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Filter Type</label>
                    <select class="form-select filter-type">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="greater_than">Greater Than</option>
                        <option value="less_than">Less Than</option>
                        <option value="date_range">Date Range</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-control filter-value" placeholder="Enter filter value...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-danger btn-sm remove-filter" style="display: block;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.append(filterHtml);
    });
    
    // Add event handlers for filter controls
    $('.remove-filter').on('click', function() {
        $(this).closest('.filter-row').remove();
    });
}

function addFilter() {
    if (!currentData || !currentData.columns) return;
    
    const container = $('#filterContainer');
    const newFilterHtml = `
        <div class="row mb-3 filter-row">
            <div class="col-md-3">
                <label class="form-label">Column</label>
                <select class="form-select filter-column">
                    <option value="">Select column...</option>
                    ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Filter Type</label>
                <select class="form-select filter-type">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                    <option value="date_range">Date Range</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Value</label>
                <input type="text" class="form-control filter-value" placeholder="Enter filter value...">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-danger btn-sm remove-filter" style="display: block;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.append(newFilterHtml);
    
    // Add event handler for remove button
    container.find('.remove-filter').last().on('click', function() {
        $(this).closest('.filter-row').remove();
    });
}

function clearFilters() {
    $('#filterContainer').empty();
    currentFilters = {};
    if (currentData) {
        displayDataInTable(currentData);
        updateDataInfo({
            total_rows: currentData.length,
            columns: currentData.length > 0 ? Object.keys(currentData[0]) : [],
            file_size: 0
        });
    }
}

function applyFilters() {
    if (!currentFile) return;
    
    const filters = {};
    $('.filter-row').each(function() {
        const column = $(this).find('.filter-column').val();
        const type = $(this).find('.filter-type').val();
        const value = $(this).find('.filter-value').val();
        
        if (column && type && value) {
            filters[column] = {
                type: type,
                value: value
            };
        }
    });
    
    // Simple filter implementation - just log for now
    console.log('Applying filters:', filters);
    currentFilters = filters;
    
    // Show success message
    alert('Filters applied successfully (simplified implementation)');
}

function exportData() {
    if (!currentFile) return;
    
    const format = prompt('Enter export format (csv, json, parquet, feather):', 'csv');
    if (!format) return;
    
    const filename = prompt('Enter export filename:', `${currentFile.replace(/\.[^/.]+$/, '')}_export.${format}`);
    if (!filename) return;
    
    // Simple export implementation - just log for now
    console.log('Exporting data:', { currentFile, format, filename, currentFilters });
    alert(`Data export requested: ${filename} (${format}) - simplified implementation`);
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Multi-File Data View - REDLINE{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/virtual-scroll.js') }}"></script>
{% endblock %}

{% block head %}
<style>
    .file-selector {
        background-color: var(--light-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        color: var(--text-primary);
    }
    
    .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--light-color);
        color: var(--text-primary);
        position: relative;
        z-index: 2;
    }
    
    .file-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .file-list::-webkit-scrollbar-track {
        background: var(--light-color);
        border-radius: 4px;
    }
    
    .file-list::-webkit-scrollbar-thumb {
        background: var(--secondary-color);
        border-radius: 4px;
    }
    
    .file-list::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }
    
    .file-item {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
        position: relative;
        z-index: 3;
        min-height: 50px;
    }
    
    .file-item:hover {
        background-color: var(--secondary-color);
        color: var(--text-white);
    }
    
    .file-item.selected {
        background-color: var(--info-color);
        color: var(--text-white);
        border-left: 4px solid var(--info-color);
    }
    
    .file-item input[type="checkbox"] {
        margin-right: 10px;
        flex-shrink: 0;
        z-index: 4;
    }
    
    .file-info {
        flex: 1;
        font-size: 14px;
        min-width: 0;
        overflow: hidden;
        position: relative;
        z-index: 3;
    }
    
    .file-name {
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        display: block;
        margin-bottom: 2px;
    }
    
    .file-size {
        color: var(--text-muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        display: block;
    }
    
    .data-display-area {
        background: var(--light-color);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        min-height: 500px;
    }
    
    .dataset-container {
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .dataset-header {
        background: var(--light-color);
        color: var(--text-primary);
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .dataset-title {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .dataset-info {
        color: var(--text-muted);
        font-size: 14px;
        margin: 0;
    }
    
    .dataset-content {
        padding: 0;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Virtual scrolling styles */
    .virtual-scroll-container {
        height: 500px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background-color: var(--light-color);
        margin-bottom: 20px;
    }
    
    .virtual-scroll-header, .virtual-scroll-footer {
        padding: 10px 15px;
        background-color: var(--dark-color);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--text-white);
    }
    
    .virtual-scroll-footer {
        border-top: 1px solid var(--border-color);
        border-bottom: none;
    }
    
    .virtual-scroll-viewport {
        flex-grow: 1;
        overflow-y: auto;
        position: relative;
    }
    
    .virtual-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }
    
    .virtual-table thead th {
        position: sticky;
        top: 0;
        background-color: var(--dark-color);
        color: var(--text-white);
        z-index: 1;
        padding: 0.75rem;
        font-weight: 600;
    }
    
    .pagination-info {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .table th {
        background-color: var(--dark-color) !important;
        color: var(--text-white) !important;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    /* Dark theme: use black background for headers */
    body.theme-dark .table th,
    body.theme-dark .table thead.table-dark th,
    body.theme-dark thead.table-dark th {
        background-color: #000000 !important;
        color: #ffffff !important;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .no-data-message {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
        font-style: italic;
    }
    
    .load-button {
        background: var(--primary-color);
        color: var(--text-white);
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    
    .load-button:hover {
        background: var(--primary-color);
    }
    
    .load-button:disabled {
        background: var(--secondary-color);
        cursor: not-allowed;
    }
    
    .clear-button {
        background: var(--danger-color);
        color: var(--text-white);
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
    }
    
    .clear-button:hover {
        background: var(--danger-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="/data/" class="btn btn-outline-primary">Single File View</a>
                <a href="/data/multi" class="btn btn-outline-primary active">Multi-File View</a>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- File Selector Panel -->
        <div class="col-md-4">
            <div class="file-selector">
                <h5 class="mb-3">üìÅ Select Files to Load</h5>
                <div class="mb-3">
                    <button id="loadSelectedBtn" class="load-button" disabled>
                        Load Selected Files
                    </button>
                    <button id="clearAllBtn" class="clear-button">
                        Clear All
                    </button>
                </div>
                
                <div class="file-list" id="fileList">
                    <div class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading files...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading file list...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Display Area -->
        <div class="col-md-8">
            <div class="data-display-area">
                <h5 class="mb-3">üìä Multi-File Data View</h5>
                <div id="dataDisplay">
                    <div class="no-data-message">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <h6>No files loaded</h6>
                        <p>Select files from the left panel and click "Load Selected Files" to view data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedFiles = new Set();
let loadedDatasets = new Map();

// Load file list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFileList();
    
    // Event listeners
    document.getElementById('loadSelectedBtn').addEventListener('click', loadSelectedFiles);
    document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
});

// Load file list from API
async function loadFileList() {
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    try {
        const response = await fetch('/api/files', {
            method: 'GET',
            headers: licenseKey ? { 'X-License-Key': licenseKey } : {}
        });
        const data = await response.json();
        
        if (data.files && data.files.length > 0) {
            displayFileList(data.files);
        } else {
            document.getElementById('fileList').innerHTML = 
                '<div class="text-center p-3 text-muted">No files found</div>';
        }
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('fileList').innerHTML = 
            '<div class="text-center p-3 text-danger">Error loading files</div>';
    }
}

// Display file list with checkboxes
function displayFileList(files) {
    const fileList = document.getElementById('fileList');
    
    fileList.innerHTML = files.map(file => `
        <div class="file-item" data-filename="${file.name}">
            <input type="checkbox" id="file-${file.name}" 
                   onchange="toggleFileSelection('${file.name}')">
            <div class="file-info">
                <div class="file-name">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)} ‚Ä¢ ${formatDate(file.modified)}</div>
            </div>
        </div>
    `).join('');
}

// Toggle file selection
function toggleFileSelection(filename) {
    const checkbox = document.getElementById(`file-${filename}`);
    const fileItem = document.querySelector(`[data-filename="${filename}"]`);
    
    if (checkbox.checked) {
        selectedFiles.add(filename);
        fileItem.classList.add('selected');
    } else {
        selectedFiles.delete(filename);
        fileItem.classList.remove('selected');
    }
    
    // Update load button state
    const loadBtn = document.getElementById('loadSelectedBtn');
    loadBtn.disabled = selectedFiles.size === 0;
}

// Load selected files
async function loadSelectedFiles() {
    if (selectedFiles.size === 0) return;
    
    const loadBtn = document.getElementById('loadSelectedBtn');
    loadBtn.disabled = true;
    loadBtn.textContent = 'Loading...';
    
    try {
        // Show loading states for all selected files
        const filenames = Array.from(selectedFiles);
        filenames.forEach(filename => showLoadingState(filename));
        
        // Get license key - use global function if available, otherwise fallback
        const licenseKey = (typeof window.getLicenseKey === 'function') 
            ? window.getLicenseKey() 
            : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
        
        if (!licenseKey) {
            alert('License key is required. Please register or enter your license key.');
            return;
        }
        
        // Load all files using batch endpoint
        const response = await fetch('/data/load-multiple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({ 
                filenames: filenames,
                license_key: licenseKey
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // Handle successful loads - ADD to existing datasets (don't overwrite)
        if (result.results && typeof result.results === 'object') {
            Object.entries(result.results).forEach(([filename, data]) => {
                // Only add if not already loaded, or update if it exists
                loadedDatasets.set(filename, data);
            });
        }
        
        // Handle errors - show error state but don't remove from loadedDatasets if it was already loaded
        if (result.errors && typeof result.errors === 'object') {
            Object.entries(result.errors).forEach(([filename, error]) => {
                // Only show error if file wasn't already successfully loaded
                if (!loadedDatasets.has(filename)) {
                    showErrorState(filename, error);
                } else {
                    console.warn(`[${filename}] Error loading but file already in loadedDatasets, keeping existing data`);
                }
            });
        }
        
        // Update display - this will show ALL loaded files (existing + new)
        updateDataDisplay();
        
        // Clear selection (but keep loadedDatasets intact)
        selectedFiles.clear();
        document.querySelectorAll('.file-item').forEach(item => {
            item.classList.remove('selected');
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
        });
        
        // Show summary
        if (result.error_count > 0) {
            alert(`Loaded ${result.success_count} files successfully. ${result.error_count} files had errors. Check console for details.`);
        }
        
    } catch (error) {
        console.error('Error loading files:', error);
        alert('Error loading files. Check console for details.');
    } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Load Selected Files';
    }
}

// Load data for a single file
async function loadFileData(filename) {
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        showErrorState(filename, 'License key is required');
        return;
    }
    
    try {
        // Show loading state for this file
        showLoadingState(filename);
        
        const response = await fetch('/data/load', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({ 
                filename: filename,
                license_key: licenseKey
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Store loaded data
        loadedDatasets.set(filename, data);
        
        // Update display
        updateDataDisplay();
        
    } catch (error) {
        console.error(`Error loading ${filename}:`, error);
        showErrorState(filename, error.message);
    }
}

// Show loading state for a file
function showLoadingState(filename) {
    const dataDisplay = document.getElementById('dataDisplay');
    
    // If this is the first file being loaded, clear the "no data" message
    if (loadedDatasets.size === 0) {
        dataDisplay.innerHTML = '';
    }
    
    // Add loading indicator for this file
    const loadingId = `loading-${filename}`;
    if (!document.getElementById(loadingId)) {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'dataset-container';
        loadingDiv.innerHTML = `
            <div class="dataset-header">
                <h6 class="dataset-title">üìÑ ${filename}</h6>
                <p class="dataset-info">Loading...</p>
            </div>
            <div class="dataset-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading ${filename}...</p>
                </div>
            </div>
        `;
        dataDisplay.appendChild(loadingDiv);
    }
}

// Show error state for a file
function showErrorState(filename, errorMessage) {
    const loadingId = `loading-${filename}`;
    const loadingDiv = document.getElementById(loadingId);
    
    if (loadingDiv) {
        loadingDiv.innerHTML = `
            <div class="dataset-header">
                <h6 class="dataset-title">‚ùå ${filename}</h6>
                <p class="dataset-info">Error loading file</p>
            </div>
            <div class="dataset-content">
                <div class="no-data-message">
                    <h6>Error loading ${filename}</h6>
                    <p class="text-danger">${errorMessage}</p>
                </div>
            </div>
        `;
    }
}

// Update the data display with all loaded datasets
function updateDataDisplay() {
    const dataDisplay = document.getElementById('dataDisplay');
    
    if (loadedDatasets.size === 0) {
        dataDisplay.innerHTML = `
            <div class="no-data-message">
                <i class="fas fa-database fa-3x mb-3"></i>
                <h6>No files loaded</h6>
                <p>Select files from the left panel and click "Load Selected Files" to view data</p>
            </div>
        `;
        return;
    }
    
    // Build a map of existing dataset containers to preserve them if data hasn't changed
    const existingContainers = new Map();
    document.querySelectorAll('.dataset-container[data-filename]').forEach(container => {
        const filename = container.getAttribute('data-filename');
        if (filename && loadedDatasets.has(filename)) {
            existingContainers.set(filename, container);
        }
    });
    
    // Clear only loading indicators (not existing datasets)
    document.querySelectorAll('[id^="loading-"]').forEach(el => {
        // Only remove if the file is now loaded (not still loading)
        const loadingId = el.id;
        const filename = loadingId.replace('loading-', '');
        if (loadedDatasets.has(filename)) {
            el.remove();
        }
    });
    
    // Display all loaded datasets - preserve existing containers when possible
    let html = '';
    const virtualScrollFiles = [];
    const processedFiles = new Set();
    
    loadedDatasets.forEach((data, filename) => {
        processedFiles.add(filename);
        
        // Check if we should preserve existing container
        const existingContainer = existingContainers.get(filename);
        if (existingContainer) {
            // File already displayed, check if we need to update it
            // Only update if data structure changed significantly
            const existingData = existingContainer.dataset.dataHash;
            const newDataHash = JSON.stringify(data.columns) + '_' + (data.total_rows || 0);
            
            if (existingData !== newDataHash) {
                // Data changed, need to re-render
                html += createDatasetHTML(data, filename);
            } else {
                // Data unchanged, preserve existing container
                // Don't add to html, it's already in the DOM
            }
        } else {
            // New file, add to display
            html += createDatasetHTML(data, filename);
        }
        
        // Track files that need virtual scrolling
        const totalRows = data.total_rows || (data.data ? data.data.length : 0);
        const isMergedFile = filename.toLowerCase().includes('merged');
        if (isMergedFile || totalRows > 10000) {
            virtualScrollFiles.push({ filename, data });
        }
    });
    
    // Remove containers for files that are no longer in loadedDatasets
    existingContainers.forEach((container, filename) => {
        if (!processedFiles.has(filename)) {
            container.remove();
        }
    });
    
    // Append new HTML (only for new or updated files)
    if (html) {
        // If there are existing containers, append after them
        const lastContainer = Array.from(document.querySelectorAll('.dataset-container[data-filename]')).pop();
        if (lastContainer && lastContainer.nextSibling) {
            lastContainer.insertAdjacentHTML('afterend', html);
        } else {
            // No existing containers or last one has no next sibling, append to dataDisplay
            dataDisplay.insertAdjacentHTML('beforeend', html);
        }
    }
    
    // Initialize virtual scrolling for large files (only new ones)
    virtualScrollFiles.forEach(({ filename, data }) => {
        const containerId = `virtual-scroll-${filename.replace(/[^a-zA-Z0-9]/g, '-')}`;
        const container = document.getElementById(containerId);
        if (container && !window[`virtualScroll_${containerId}`]) {
            setTimeout(() => initializeVirtualScrolling(filename, data), 100);
        }
    });
}

// Create HTML for a single dataset
function createDatasetHTML(data, filename) {
    // Determine columns to use
    let columnsToUse = [];
    if (data.columns && Array.isArray(data.columns) && data.columns.length > 0) {
        columnsToUse = data.columns;
        console.log(`[${filename}] Using columns from data.columns:`, columnsToUse);
    } else if (data.data && data.data.length > 0) {
        // Fallback: extract columns from first row
        columnsToUse = Object.keys(data.data[0]);
        console.log(`[${filename}] Extracted columns from first row:`, columnsToUse);
    } else {
        console.warn(`[${filename}] No columns found and no data to extract from`);
    }
    
    const totalRows = data.total_rows !== undefined ? data.total_rows : (data.data ? data.data.length : 0);
    const isMergedFile = filename.toLowerCase().includes('merged');
    const useVirtualScrolling = isMergedFile || totalRows > 10000;
    
    // Create a hash for change detection
    const dataHash = JSON.stringify(columnsToUse) + '_' + totalRows;
    
    let html = `
        <div class="dataset-container" data-filename="${filename}" data-data-hash="${dataHash}">
            <div class="dataset-header">
                <h6 class="dataset-title">üìÑ ${filename}</h6>
                <p class="dataset-info">Rows: ${totalRows} | Columns: ${columnsToUse.length} ${useVirtualScrolling ? '| <span class="text-info">Virtual Scrolling</span>' : ''}</p>
            </div>
            <div class="dataset-content">
    `;
    
    if (data.data && data.data.length > 0 && columnsToUse.length > 0) {
        if (useVirtualScrolling) {
            // Use virtual scrolling for merged files or large files
            const containerId = `virtual-scroll-${filename.replace(/[^a-zA-Z0-9]/g, '-')}`;
            html += `<div id="${containerId}" class="virtual-scroll-container"></div>`;
        } else {
            // Use pagination for regular files (<10k rows)
            const currentPage = 1;
            const pageSize = 500;
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, data.data.length);
            const pageData = data.data.slice(startIdx, endIdx);
            const totalPages = Math.ceil(totalRows / pageSize);
            
            html += '<div class="table-responsive" style="overflow-x: auto;">';
            html += '<table class="table table-striped table-hover table-sm" style="border-collapse: collapse; width: 100%;">';
            
            // HTML escape function
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Headers
            html += '<thead class="table-dark"><tr>';
            columnsToUse.forEach((col, index) => {
                const displayCol = (col !== null && col !== undefined && col !== '') ? String(col) : `Column_${index + 1}`;
                const escapedCol = escapeHtml(displayCol);
                html += `<th scope="col" style="background-color: var(--dark-color) !important; color: var(--text-white) !important; padding: 0.75rem !important; font-weight: 600 !important; border: 1px solid var(--border-color) !important;">${escapedCol}</th>`;
            });
            html += '</tr></thead>';
            
            // Data rows
            html += '<tbody>';
            pageData.forEach((row, index) => {
                html += '<tr>';
                columnsToUse.forEach(col => {
                    const value = row[col];
                    let displayValue = '';
                    if (value === null || value === undefined || value === '') {
                        displayValue = '';
                    } else if (typeof value === 'number') {
                        displayValue = Number(value).toLocaleString();
                    } else {
                        displayValue = String(value);
                    }
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            html += '</div>';
            
            // Pagination controls
            if (totalPages > 1) {
                html += `
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="pagination-info">
                            Showing ${startIdx + 1}-${endIdx} of ${totalRows} rows (Page ${currentPage} of ${totalPages})
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadPageForFile('${filename}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadPageForFile('${filename}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                        </div>
                    </div>
                `;
            }
        }
    } else {
        html += '<div class="no-data-message">No data found in file</div>';
    }
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

// Initialize virtual scrolling after HTML is inserted
function initializeVirtualScrolling(filename, data) {
    const containerId = `virtual-scroll-${filename.replace(/[^a-zA-Z0-9]/g, '-')}`;
    const container = document.getElementById(containerId);
    
    if (!container) return;
    
    // Check if VirtualScrollTable is available
    if (typeof VirtualScrollTable === 'undefined' && typeof window.VirtualScrollTable === 'undefined') {
        console.warn(`[${filename}] VirtualScrollTable not available, falling back to regular table`);
        return;
    }
    
    // Use jQuery if available, otherwise vanilla JS
    const $container = typeof $ !== 'undefined' ? $(container) : null;
    const scrollContainer = $container || container;
    
    // Destroy existing instance if any
    if (window[`virtualScroll_${containerId}`]) {
        window[`virtualScroll_${containerId}`].destroy();
    }
    
    // Initialize virtual scroll
    try {
        const VirtualScroll = window.VirtualScrollTable || VirtualScrollTable;
        window[`virtualScroll_${containerId}`] = new VirtualScroll(scrollContainer, {
            rowHeight: 30,
            visibleRows: 20,
            buffer: 5,
            pageSize: 500
        });
        
        // Load data from API
        const licenseKey = (typeof window.getLicenseKey === 'function') 
            ? window.getLicenseKey() 
            : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
        
        window[`virtualScroll_${containerId}`].loadDataFromAPI(`/data/load`, {
            filename: filename,
            license_key: licenseKey
        });
    } catch (error) {
        console.error(`[${filename}] Error initializing virtual scroll:`, error);
    }
}

// Load page for a specific file (pagination)
async function loadPageForFile(filename, page) {
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required');
        return;
    }
    
    try {
        const response = await fetch('/data/load', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({ 
                filename: filename,
                license_key: licenseKey,
                page: page,
                per_page: 500
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Update the dataset
        loadedDatasets.set(filename, data);
        
        // Re-render just this dataset
        const container = document.querySelector(`[data-filename="${filename}"]`);
        if (container) {
            const newHtml = createDatasetHTML(data, filename);
            container.outerHTML = newHtml;
            
            // Re-initialize virtual scrolling if needed
            const totalRows = data.total_rows || (data.data ? data.data.length : 0);
            const isMergedFile = filename.toLowerCase().includes('merged');
            if (isMergedFile || totalRows > 10000) {
                setTimeout(() => initializeVirtualScrolling(filename, data), 100);
            }
        }
    } catch (error) {
        console.error(`Error loading page ${page} for ${filename}:`, error);
        alert(`Error loading page: ${error.message}`);
    }
}

// Clear all loaded data
function clearAllData() {
    loadedDatasets.clear();
    selectedFiles.clear();
    
    // Clear checkboxes
    document.querySelectorAll('.file-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Clear selection styling
    document.querySelectorAll('.file-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Update load button
    document.getElementById('loadSelectedBtn').disabled = true;
    
    // Clear display
    updateDataDisplay();
}

// Utility functions
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(timestamp) {
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}
</script>
{% endblock %}

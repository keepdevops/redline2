<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}REDLINE - Financial Data Analyzer{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
        <!-- Custom CSS (use minified in production) -->
        {% if config.get('ENV') == 'production' %}
        <link href="{{ url_for('static', filename='css/main.min.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/themes.min.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/virtual-scroll.min.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/color-customizer.min.css') }}" rel="stylesheet">
        {% else %}
        <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/themes.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/virtual-scroll.css') }}" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/color-customizer.css') }}" rel="stylesheet">
        {% endif %}
    
    <style>
        /* Make filenames wrap properly in recent files panel */
        #recent-files .list-group-item h6 {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            white-space: normal;
            max-width: 100%;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="theme-default">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="fas fa-chart-line me-2"></i>REDLINE
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/data/">
                            <i class="fas fa-database me-1"></i>Data
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('analysis.analysis_tab') }}">
                            <i class="fas fa-chart-bar me-1"></i>Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/download/">
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/converter/">
                            <i class="fas fa-exchange-alt me-1"></i>Converter
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('api_keys.api_keys_page') }}">
                            <i class="fas fa-key me-1"></i>API Keys
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('payments.payment_tab') }}">
                            <i class="fas fa-credit-card me-1"></i>Payment
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('settings.settings_tab') }}">
                            <i class="fas fa-cog me-1"></i>Settings
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.register') }}">
                            <i class="fas fa-user-plus me-1"></i>Register
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-palette me-1"></i>Theme
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
                            <li><h6 class="dropdown-header">Color Schemes</h6></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-default">
                                <i class="fas fa-circle text-primary me-2"></i>Default
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-high-contrast">
                                <i class="fas fa-circle text-danger me-2"></i>High Contrast
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-ocean">
                                <i class="fas fa-circle text-info me-2"></i>Ocean
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-forest">
                                <i class="fas fa-circle text-success me-2"></i>Forest
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-sunset">
                                <i class="fas fa-circle text-warning me-2"></i>Sunset
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-monochrome">
                                <i class="fas fa-circle text-secondary me-2"></i>Monochrome
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-grayscale">
                                <i class="fas fa-adjust text-secondary me-2"></i>Grayscale
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-dark">
                                <i class="fas fa-moon text-dark me-2"></i>Dark
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.help_page') }}">
                            <i class="fas fa-question-circle me-1"></i>Help
                        </a>
                    </li>
                    <li class="nav-item">
                        <span id="dashboardLoadingIndicator" class="navbar-text" style="display: none;">
                            <i class="fas fa-spinner fa-spin me-1"></i><span id="dashboardLoadingText">Loading...</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <span class="navbar-text">
                            <i class="fas fa-circle text-success me-1"></i>Online
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <div class="sidebar-content">
                    {% block sidebar %}
                    <div class="sidebar-section">
                        <h6 class="sidebar-title">Quick Actions</h6>
                        <div class="list-group list-group-flush">
                            <a href="/download/" class="list-group-item list-group-item-action">
                                <i class="fas fa-download me-2"></i>Download Data
                            </a>
                            <a href="/data/" class="list-group-item list-group-item-action">
                                <i class="fas fa-eye me-2"></i>View Data
                            </a>
                            <a href="/converter/" class="list-group-item list-group-item-action">
                                <i class="fas fa-exchange-alt me-2"></i>Convert Format
                            </a>
                            <a href="{{ url_for('analysis.analysis_tab') }}" class="list-group-item list-group-item-action">
                                <i class="fas fa-chart-bar me-2"></i>Analyze Data
                            </a>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h6 class="sidebar-title">Recent Files</h6>
                        <div id="recent-files" class="list-group list-group-flush">
                            <!-- Recent files will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h6 class="sidebar-title">System Status</h6>
                        <div id="system-status">
                            <small class="text-muted">Loading...</small>
                        </div>
                    </div>
                    {% endblock %}
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="col-md-10 main-content">
                {% block content %}
                <div class="content-header">
                    <h1 class="content-title">{% block page_title %}Welcome to REDLINE{% endblock %}</h1>
                    <p class="content-subtitle">{% block page_subtitle %}Financial Data Analyzer & Management Tool{% endblock %}</p>
                </div>
                
                <div class="content-body">
                    <!-- Content will be loaded here -->
                </div>
                {% endblock %}
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loading-text mt-3">Processing...</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">REDLINE</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
            <!-- License Key Auto-Load Script (MUST BE BEFORE OTHER SCRIPTS) -->
            <script>
            // Auto-load license key from localStorage on all pages
            (function() {
                const LICENSE_KEY_STORAGE = 'redline_license_key';
                
                // Function to get license key (available immediately)
                function getLicenseKey() {
                    const key = localStorage.getItem(LICENSE_KEY_STORAGE) || window.REDLINE_LICENSE_KEY;
                    if (!key) {
                        console.warn('‚ö†Ô∏è No license key found in localStorage or window.REDLINE_LICENSE_KEY');
                    }
                    return key;
                }
                
                // Make getLicenseKey available globally immediately
                window.getLicenseKey = getLicenseKey;
                
                // Load saved key
                const savedKey = localStorage.getItem(LICENSE_KEY_STORAGE);
                if (savedKey) {
                    // Make license key available globally
                    window.REDLINE_LICENSE_KEY = savedKey;
                    console.log('‚úÖ License key loaded from localStorage:', savedKey.substring(0, 20) + '...');
                } else {
                    console.log('‚ÑπÔ∏è No license key found in localStorage. Register or enter license key.');
                }
                
                // Add diagnostic function
                window.checkLicenseKey = function() {
                    const key = getLicenseKey();
                    console.log('üîë License Key Check:');
                    console.log('  - localStorage:', localStorage.getItem(LICENSE_KEY_STORAGE) ? 'Found' : 'Not found');
                    console.log('  - window.REDLINE_LICENSE_KEY:', window.REDLINE_LICENSE_KEY ? 'Found' : 'Not found');
                    console.log('  - Current key:', key ? key.substring(0, 20) + '...' : 'None');
                    return key;
                };
                
                // Override global fetch to automatically include license key
                const originalFetch = window.fetch;
                window.fetch = function(url, options = {}) {
                    // Only add license key for same-origin requests (our API)
                    if (typeof url === 'string' && (url.startsWith('/') || url.startsWith(window.location.origin))) {
                        const licenseKey = getLicenseKey();
                        
                        if (licenseKey) {
                            // Ensure options object exists
                            if (!options) options = {};
                            if (!options.headers) options.headers = {};
                            
                            // Add license key header if not already present
                            if (!options.headers['X-License-Key'] && !options.headers['x-license-key']) {
                                options.headers['X-License-Key'] = licenseKey;
                            }
                        }
                    }
                    
                    return originalFetch.apply(this, arguments);
                };
                
                // Wait for jQuery to be ready, then override
                function setupJQueryOverride() {
                    if (typeof $ === 'undefined' || !$.ajax) {
                        // jQuery not loaded yet, try again
                        setTimeout(setupJQueryOverride, 50);
                        return;
                    }
                    
                    // Override jQuery ajax to automatically include license key
                    const originalAjax = $.ajax;
                    $.ajax = function(urlOrOptions, options) {
                        // Handle both $.ajax(url, options) and $.ajax(options) patterns
                        let opts, url;
                        
                        if (typeof urlOrOptions === 'string') {
                            // Called as $.ajax(url, options)
                            url = urlOrOptions;
                            opts = options || {};
                            opts.url = url;
                        } else {
                            // Called as $.ajax(options)
                            opts = urlOrOptions || {};
                            url = opts.url;
                        }
                        
                        // Only add license key for same-origin requests
                        if (url && (url.startsWith('/') || url.startsWith(window.location.origin))) {
                            const licenseKey = getLicenseKey();
                            
                            if (licenseKey) {
                                // Ensure headers object exists
                                if (!opts.headers) opts.headers = {};
                                
                                // Add license key header if not already present
                                if (!opts.headers['X-License-Key'] && !opts.headers['x-license-key']) {
                                    opts.headers['X-License-Key'] = licenseKey;
                                    console.log('‚úÖ Added license key to headers for:', url);
                                }
                                
                                // Also add to beforeSend if it exists (as backup)
                                const originalBeforeSend = opts.beforeSend;
                                opts.beforeSend = function(xhr) {
                                    const key = getLicenseKey();
                                    if (key) {
                                        // Set header (jqXHR has setRequestHeader method)
                                        try {
                                            xhr.setRequestHeader('X-License-Key', key);
                                        } catch (e) {
                                            // Header might already be set, ignore
                                        }
                                    }
                                    // Call original beforeSend if it exists
                                    if (originalBeforeSend) {
                                        return originalBeforeSend.apply(this, arguments);
                                    }
                                };
                                
                                // Handle data - could be object, string (JSON), FormData, etc.
                                if (opts.data) {
                                    // If data is a JSON string (common for POST with contentType: 'application/json')
                                    if (typeof opts.data === 'string' && opts.contentType && opts.contentType.includes('application/json')) {
                                        try {
                                            const dataObj = JSON.parse(opts.data);
                                            if (!dataObj.license_key) {
                                                dataObj.license_key = licenseKey;
                                                opts.data = JSON.stringify(dataObj);
                                                console.log('‚úÖ Added license key to JSON string data for:', url);
                                            }
                                        } catch (e) {
                                            // Not valid JSON, skip
                                        }
                                    }
                                    // If data is an object
                                    else if (typeof opts.data === 'object' && !Array.isArray(opts.data) && !(opts.data instanceof FormData)) {
                                        if (!opts.data.license_key) {
                                            opts.data.license_key = licenseKey;
                                            console.log('‚úÖ Added license key to object data for:', url);
                                        }
                                    }
                                    // If data is FormData
                                    else if (opts.data instanceof FormData) {
                                        if (!opts.data.has('license_key')) {
                                            opts.data.append('license_key', licenseKey);
                                            console.log('‚úÖ Added license key to FormData for:', url);
                                        }
                                    }
                                } else if (opts.type && opts.type.toUpperCase() === 'POST') {
                                    // For POST requests without data, add license_key as query param or create data object
                                    if (!opts.data) {
                                        opts.data = { license_key: licenseKey };
                                        console.log('‚úÖ Created data object with license key for POST:', url);
                                    }
                                }
                            } else {
                                console.warn('‚ö†Ô∏è No license key found in localStorage for request:', url);
                            }
                        }
                        
                        // Call original ajax with modified options
                        if (typeof urlOrOptions === 'string') {
                            return originalAjax.call(this, url, opts);
                        } else {
                            return originalAjax.call(this, opts);
                        }
                    };
                    
                    // Also override $.get and $.post
                    const originalGet = $.get;
                    $.get = function(url, data, success, dataType) {
                        const licenseKey = getLicenseKey();
                        const opts = {
                            url: url,
                            type: 'GET',
                            dataType: dataType
                        };
                        
                        if (licenseKey) {
                            if (!opts.headers) opts.headers = {};
                            opts.headers['X-License-Key'] = licenseKey;
                            
                            if (typeof data === 'object' && data !== null && !Array.isArray(data)) {
                                opts.data = Object.assign({}, data, { license_key: licenseKey });
                            } else if (typeof data === 'string') {
                                opts.url = url + (url.includes('?') ? '&' : '?') + 'license_key=' + encodeURIComponent(licenseKey);
                                opts.data = data;
                            } else {
                                opts.url = url + (url.includes('?') ? '&' : '?') + 'license_key=' + encodeURIComponent(licenseKey);
                                opts.data = data;
                            }
                        } else {
                            opts.data = data;
                        }
                        
                        if (success) opts.success = success;
                        
                        return originalAjax(opts);
                    };
                    
                    const originalPost = $.post;
                    $.post = function(url, data, success, dataType) {
                        const licenseKey = getLicenseKey();
                        const opts = {
                            url: url,
                            type: 'POST',
                            dataType: dataType
                        };
                        
                        if (licenseKey) {
                            if (!opts.headers) opts.headers = {};
                            opts.headers['X-License-Key'] = licenseKey;
                            
                            if (typeof data === 'object' && data !== null && !Array.isArray(data) && !(data instanceof FormData)) {
                                opts.data = Object.assign({}, data, { license_key: licenseKey });
                            } else if (data instanceof FormData) {
                                if (!data.has('license_key')) {
                                    data.append('license_key', licenseKey);
                                }
                                opts.data = data;
                            } else {
                                opts.data = data;
                            }
                        } else {
                            opts.data = data;
                        }
                        
                        if (success) opts.success = success;
                        
                        return originalAjax(opts);
                    };
                    
                    // Already logged in setupJQueryOverride
                }
                
                // Setup jQuery override when jQuery is ready
                // Try multiple times to ensure it's installed before other scripts
                function installOverride() {
                    if (typeof $ !== 'undefined' && $.ajax) {
                        setupJQueryOverride();
                        console.log('‚úÖ jQuery license key override installed');
                    } else {
                        // Try again after a short delay
                        setTimeout(installOverride, 50);
                    }
                }
                
                // Start installation immediately
                if (typeof $ !== 'undefined' && $.ajax) {
                    installOverride();
                } else {
                    // Wait for jQuery to load
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', installOverride);
                    } else {
                        // DOM already loaded, start immediately
                        installOverride();
                    }
                    // Also try immediately in case jQuery is already loaded
                    setTimeout(installOverride, 100);
                    setTimeout(installOverride, 500);
                }
                
                // Make license key available globally for all modules
                window.REDLINE = window.REDLINE || {};
                window.REDLINE.getLicenseKey = getLicenseKey;
                window.REDLINE.LICENSE_KEY_STORAGE = LICENSE_KEY_STORAGE;
            })();
            </script>
    
            <!-- Custom JS -->
            <script src="{{ url_for('static', filename='js/main.js') }}"></script>
            <script src="{{ url_for('static', filename='js/virtual-scroll.js') }}"></script>
            <script src="{{ url_for('static', filename='js/color-customizer.js') }}"></script>
            
            <!-- Global Balance Tracker (loads after license key script) -->
            <script src="{{ url_for('static', filename='js/balance_tracker.js') }}"></script>
    
    {% block extra_js %}{% endblock %}
    
    <script>
        // Initialize page
        $(document).ready(function() {
            loadRecentFiles();
            loadSystemStatus();
        });
        
        // Load recent files
        function loadRecentFiles() {
            // Get license key - use global function if available, otherwise fallback
            const licenseKey = (typeof window.getLicenseKey === 'function') 
                ? window.getLicenseKey() 
                : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
            
            $.ajax({
                url: '/api/files',
                method: 'GET',
                headers: licenseKey ? { 'X-License-Key': licenseKey } : {},
                data: licenseKey ? { license_key: licenseKey } : {}
            })
                .done(function(data) {
                    const container = $('#recent-files');
                    container.empty();
                    
                    if (data.files && data.files.length > 0) {
                        data.files.slice(0, 5).forEach(function(file) {
                            const item = $(`
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${file.name}</h6>
                                        <small>${formatFileSize(file.size)}</small>
                                    </div>
                                    <small class="text-muted">${formatDate(file.modified)}</small>
                                </div>
                            `);
                            container.append(item);
                        });
                    } else {
                        container.html('<small class="text-muted">No recent files</small>');
                    }
                })
                .fail(function() {
                    $('#recent-files').html('<small class="text-danger">Error loading files</small>');
                });
        }
        
        // Load system status
        function loadSystemStatus() {
            // Get license key - use global function if available, otherwise fallback
            const licenseKey = (typeof window.getLicenseKey === 'function') 
                ? window.getLicenseKey() 
                : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
            
            // Status endpoint doesn't require license key, but include it if available
            const url = '/status';
            const options = {
                url: url,
                method: 'GET',
                headers: licenseKey ? { 'X-License-Key': licenseKey } : {},
                timeout: 5000  // 5 second timeout
            };
            
            $.ajax(options)
                .done(function(data) {
                    const container = $('#system-status');
                    if (!container.length) {
                        console.warn('System status container not found');
                        return;
                    }
                    
                    const statusIcon = data.status === 'running' ? 'fas fa-circle text-success' : 'fas fa-circle text-danger';
                    
                    container.html(`
                        <div class="d-flex align-items-center mb-2">
                            <i class="${statusIcon} me-2"></i>
                            <span>${data.status || 'unknown'}</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-database me-2"></i>
                            <span>DB: ${data.database || 'unknown'}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt me-2"></i>
                            <span>${data.supported_formats ? data.supported_formats.length : 0} formats</span>
                        </div>
                    `);
                })
                .fail(function(xhr, status, error) {
                    const container = $('#system-status');
                    if (container.length) {
                        console.error('Failed to load system status:', status, error);
                        container.html(`
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-circle text-warning me-2"></i>
                                <span>Status unavailable</span>
                            </div>
                            <small class="text-muted">Unable to connect</small>
                        `);
                    }
                });
        }
        
        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDate(timestamp) {
            return new Date(timestamp * 1000).toLocaleDateString();
        }
        
        // Show loading overlay
        function showLoading(text = 'Processing...') {
            $('.loading-text').text(text);
            $('#loading-overlay').show();
        }
        
        // Hide loading overlay
        function hideLoading() {
            $('#loading-overlay').hide();
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = $('#toast');
            const icon = type === 'success' ? 'fas fa-check-circle text-success' : 
                        type === 'error' ? 'fas fa-exclamation-circle text-danger' : 
                        'fas fa-info-circle text-primary';
            
            toast.find('.toast-header i').attr('class', icon);
            toast.find('.toast-body').text(message);
            
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();
        }
    </script>
</body>
</html>

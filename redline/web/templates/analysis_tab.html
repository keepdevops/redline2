{% extends "base.html" %}

{% block title %}Analysis Tab - REDLINE{% endblock %}

{% block page_title %}Data Analysis{% endblock %}
{% block page_subtitle %}Perform statistical and financial analysis on your data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Analysis Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Select Data for Analysis
                </h5>
            </div>
            <div class="card-body">
                <form id="analysisForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisFile" class="form-label">Data File</label>
                                <select class="form-select" id="analysisFile" required>
                                    <option value="">Select data file...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="analysisType" class="form-label">Analysis Type</label>
                                <select class="form-select" id="analysisType" required>
                                    <option value="">Select analysis type...</option>
                                    <option value="basic">Basic Statistics</option>
                                    <option value="financial">Financial Analysis</option>
                                    <option value="statistical">Statistical Analysis</option>
                                    <option value="correlation">Correlation Analysis</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-chart-bar me-2"></i>Run Analysis
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisResults" class="card" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="resultsContent">
                    <!-- Results will be displayed here -->
                </div>
                
                <div class="mt-3">
                    <div class="btn-group me-2">
                        <button id="exportAnalysisBtn" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Export Analysis
                        </button>
                        <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu" id="exportFormatMenu">
                            <li><h6 class="dropdown-header">Export Format</h6></li>
                            <li><a class="dropdown-item" href="#" data-format="json"><i class="fas fa-file-code me-2"></i>JSON (.json)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="csv"><i class="fas fa-file-csv me-2"></i>CSV (.csv)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="parquet"><i class="fas fa-file me-2"></i>Parquet (.parquet)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="feather"><i class="fas fa-file me-2"></i>Feather (.feather)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="duckdb"><i class="fas fa-database me-2"></i>DuckDB (.duckdb)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="txt"><i class="fas fa-file-alt me-2"></i>TXT (.txt)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="npz"><i class="fas fa-file me-2"></i>NPZ/TensorFlow (.npz)</a></li>
                            <li><a class="dropdown-item" href="#" data-format="arrow"><i class="fas fa-file me-2"></i>Arrow (.arrow)</a></li>
                        </ul>
                    </div>
                    <button id="generateBackendChartBtn" class="btn btn-info me-2" style="display: none;">
                        <i class="fas fa-chart-area me-2"></i>Generate Backend Chart
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Analysis Types -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Analysis Types
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-chart-bar text-primary me-2"></i>Basic Statistics</h6>
                    <small class="text-muted">Descriptive statistics, data types, null counts, and basic information about your dataset.</small>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-chart-line text-success me-2"></i>Financial Analysis</h6>
                    <small class="text-muted">Price analysis, volume analysis, returns calculation, volatility, and Sharpe ratio.</small>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-chart-pie text-warning me-2"></i>Statistical Analysis</h6>
                    <small class="text-muted">Distribution analysis, outlier detection, skewness, kurtosis, and normality tests.</small>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-project-diagram text-info me-2"></i>Correlation Analysis</h6>
                    <small class="text-muted">Correlation matrix, strong correlations identification, and relationship analysis.</small>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>Quick Stats
                </h5>
            </div>
            <div class="card-body">
                <div id="quickStats">
                    <small class="text-muted">Select a file to view quick statistics</small>
                </div>
            </div>
        </div>
        
        <!-- Additional Features -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-magic me-2"></i>Additional Features
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6><i class="fas fa-chart-area text-primary me-2"></i>Backend Visualization</h6>
                    <small class="text-muted">Generate high-quality charts using matplotlib/seaborn. Available after running analysis.</small>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-brain text-warning me-2"></i>Machine Learning</h6>
                    <small class="text-muted">For ML operations (data preparation, outlier detection, clustering, predictions, feature scaling), use the <a href="/ml/">ML tab</a>.</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAnalysisData = null;

$(document).ready(function() {
    loadAvailableFiles();
    
    // Event handlers
    $('#analysisForm').on('submit', function(e) {
        e.preventDefault();
        runAnalysis();
    });
    
    $('#analysisFile').on('change', function() {
        const selectedFile = $(this).val();
        if (selectedFile) {
            loadQuickStats(selectedFile);
        }
    });
    
    // Export analysis with format selection
    $('#exportAnalysisBtn').on('click', function(e) {
        e.preventDefault();
        // If dropdown is available, show it; otherwise use default format
        if ($('#exportFormatMenu').is(':visible')) {
            // Dropdown will handle the click
            return;
        }
        exportAnalysis('json'); // Default format
    });
    
    // Handle format selection from dropdown
    $('#exportFormatMenu .dropdown-item').on('click', function(e) {
        e.preventDefault();
        const format = $(this).data('format');
        if (format) {
            exportAnalysis(format);
        }
    });
    
    $('#generateBackendChartBtn').on('click', function() {
        generateBackendChart();
    });
});

function loadAvailableFiles() {
    REDLINE.ui.showLoading('Loading available files...');
    
    REDLINE.api.get('/api/files')
        .then(response => {
            const select = $('#analysisFile');
            select.empty();
            select.append('<option value="">Select data file...</option>');
            
            if (response.files && response.files.length > 0) {
                response.files.forEach(file => {
                    // Validate file name before adding to dropdown
                    if (file.name && typeof file.name === 'string') {
                        const fileSize = file.size ? REDLINE.utils.formatFileSize(file.size) : 'Unknown size';
                        const safePath = file.path ? file.path : '';
                        select.append(`<option value="${file.name}" data-path="${safePath}">${file.name} (${fileSize})</option>`);
                    }
                });
            } else {
                select.append('<option value="" disabled>No files available</option>');
            }
            
            REDLINE.ui.hideLoading();
        })
        .catch(error => {
            REDLINE.ui.hideLoading();
            console.error('Error loading files:', error);
            const errorMessage = error.message || error.error || 'Unknown error occurred';
            REDLINE.ui.showToast('Error loading files: ' + errorMessage, 'error');
        });
}

function loadQuickStats(filename) {
    // Validate filename before making request
    if (!filename || typeof filename !== 'string') {
        $('#quickStats').html('<small class="text-danger">Invalid filename</small>');
        return;
    }
    
    // Resolve file path from selected option if available
    const opt = $('#analysisFile option:selected');
    const filePath = opt.data('path') || null;

    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    // Get quick stats via data loader to avoid missing legacy endpoints
    REDLINE.api.post('/data/load', { 
        filename: filename, 
        file_path: filePath,
        license_key: licenseKey
    })
        .then(response => {
            const statsHtml = `
                <div class="mb-2">
                    <strong>Rows:</strong> ${REDLINE.utils.formatNumber(response.total_rows || 0)}
                </div>
                <div class="mb-2">
                    <strong>Columns:</strong> ${response.columns ? response.columns.length : 'N/A'}
                </div>
                <div class="mb-2">
                    <strong>Columns:</strong>
                    <ul class="list-unstyled mt-1">
                        ${response.columns ? response.columns.slice(0, 5).map(col => `<li><small>• ${col}</small></li>`).join('') : ''}
                        ${response.columns && response.columns.length > 5 ? `<li><small>• ... and ${response.columns.length - 5} more</small></li>` : ''}
                    </ul>
                </div>
            `;
            $('#quickStats').html(statsHtml);
        })
        .catch(error => {
            console.log('Quick stats not available:', error);
            $('#quickStats').html('<small class="text-muted">Quick stats will be available after running analysis</small>');
        });
}

function runAnalysis() {
    const filename = $('#analysisFile').val();
    const analysisType = $('#analysisType').val();
    
    if (!filename || !analysisType) {
        REDLINE.ui.showToast('Please select both file and analysis type', 'error');
        return;
    }
    
    // Validate filename format - allow most common filename characters
    if (!filename || filename.length === 0 || filename.includes('..') || filename.includes('/') || filename.includes('\\')) {
        REDLINE.ui.showToast('Invalid filename format', 'error');
        return;
    }
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    if (!licenseKey) {
        REDLINE.ui.showToast('License key is required. Please register or enter your license key.', 'error');
        return;
    }
    
    REDLINE.ui.showLoading('Running analysis...');
    console.log('Running analysis with license key:', licenseKey.substring(0, 20) + '...');
    
    // Include file_path hint to support converted files in subdirectories
    const opt = $('#analysisFile option:selected');
    const filePath = opt.data('path') || null;
    const analysisData = {
        filename: filename,
        file_path: filePath,
        analysis_type: analysisType,
        license_key: licenseKey  // Include license key in request body
    };
    
    REDLINE.api.post('/analysis/analyze', analysisData)
        .then(response => {
            currentAnalysisData = response;
            displayAnalysisResults(response);
            REDLINE.ui.hideLoading();
            REDLINE.ui.showToast('Analysis completed successfully', 'success');
        })
        .catch(error => {
            REDLINE.ui.hideLoading();
            console.error('Analysis error:', error);
            console.error('Error type:', typeof error);
            console.error('Error keys:', Object.keys(error));
            
            // Try to extract error message in multiple ways
            let errorMessage = 'Unknown error occurred';
            if (error && typeof error === 'object') {
                errorMessage = error.message || error.error || error.toString() || 'Unknown error occurred';
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            
            REDLINE.ui.showToast('Error running analysis: ' + errorMessage, 'error');
        });
}

let chartInstances = {}; // Store chart instances for cleanup

function displayAnalysisResults(response) {
    const result = response.result;
    
    // Destroy existing charts
    Object.values(chartInstances).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    chartInstances = {};
    
    let resultsHtml = '';
    
    if (response.analysis_type === 'basic') {
        resultsHtml = displayBasicAnalysis(result);
    } else if (response.analysis_type === 'financial') {
        resultsHtml = displayFinancialAnalysis(result, response.filename);
    } else if (response.analysis_type === 'statistical') {
        resultsHtml = displayStatisticalAnalysis(result);
    } else if (response.analysis_type === 'correlation') {
        resultsHtml = displayCorrelationAnalysis(result);
    }
    
    $('#resultsContent').html(resultsHtml);
    $('#analysisResults').show();
    
    // Show/hide action buttons based on analysis type
    if (response.analysis_type === 'financial') {
        $('#generateBackendChartBtn').show().text('Generate Price Chart');
        $('#prepareMLDataBtn').show();
        $('#mlFeaturesGroup').show();
    } else if (response.analysis_type === 'correlation') {
        $('#generateBackendChartBtn').show().text('Generate Heatmap');
        $('#prepareMLDataBtn').show();
        $('#mlFeaturesGroup').show();
    } else if (response.analysis_type === 'statistical') {
        $('#generateBackendChartBtn').show().text('Generate Distribution Chart');
        $('#prepareMLDataBtn').show();
        $('#mlFeaturesGroup').show();
    } else {
        $('#generateBackendChartBtn').hide();
        $('#prepareMLDataBtn').hide();
        $('#mlFeaturesGroup').hide();
    }
    
    // Store current analysis response for button actions
    window.currentAnalysisResponse = response;
    
    // Initialize charts after HTML is rendered
    setTimeout(() => {
        if (response.analysis_type === 'financial') {
            loadPriceChart(response.filename, response.file_path);
        } else if (response.analysis_type === 'correlation') {
            createCorrelationChart(result);
        }
    }, 100);
}

function displayBasicAnalysis(result) {
    let html = '<h6>Basic Data Analysis</h6>';
    
    html += `
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>Dataset Shape</h6>
                        <p><strong>Rows:</strong> ${result.shape.rows}</p>
                        <p><strong>Columns:</strong> ${result.shape.columns}</p>
                        <p><strong>Memory Usage:</strong> ${REDLINE.utils.formatFileSize(result.memory_usage)}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6>Data Types</h6>
                        ${Object.entries(result.data_types).map(([col, dtype]) => 
                            `<p><strong>${col}:</strong> ${dtype}</p>`
                        ).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (Object.keys(result.numeric_summary).length > 0) {
        html += '<h6>Numeric Columns Summary</h6>';
        html += '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Column</th><th>Count</th><th>Mean</th><th>Std</th><th>Min</th><th>Max</th></tr></thead><tbody>';
        
        Object.entries(result.numeric_summary.count).forEach(([col, count]) => {
            const summary = result.numeric_summary;
            const formatNumber = (val) => {
                if (val === null || val === undefined) return 'N/A';
                if (typeof val !== 'number') return val;
                // Format large numbers with commas for readability
                if (Math.abs(val) >= 1000) {
                    return val.toLocaleString('en-US', {maximumFractionDigits: 2});
                }
                return val.toFixed(2);
            };
            html += `
                <tr>
                    <td>${col}</td>
                    <td>${count}</td>
                    <td>${formatNumber(summary.mean[col])}</td>
                    <td>${formatNumber(summary.std[col])}</td>
                    <td>${formatNumber(summary.min[col])}</td>
                    <td>${formatNumber(summary.max[col])}</td>
                </tr>
            `;
        });
        html += '</tbody></table></div>';
    }
    
    return html;
}

function displayFinancialAnalysis(result, filename) {
    let html = '<h6 class="mb-3" style="color: var(--text-primary);">Financial Analysis</h6>';
    
    // Add price chart canvas
    html += `
        <div class="card mb-3" style="background-color: var(--light-color); color: var(--text-primary);">
            <div class="card-body">
                <h6 style="color: var(--text-primary);">Price Trend Chart</h6>
                <canvas id="priceChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    `;
    
    if (result.price_analysis && Object.keys(result.price_analysis).length > 0) {
        html += `
            <div class="card mb-3" style="background-color: var(--light-color); color: var(--text-primary);">
                <div class="card-body">
                    <h6 style="color: var(--text-primary);">Price Analysis</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Current Price:</strong> ${result.price_analysis.current_price || 'N/A'}</p>
                            <p><strong>Min Price:</strong> ${result.price_analysis.price_range?.min || 'N/A'}</p>
                            <p><strong>Max Price:</strong> ${result.price_analysis.price_range?.max || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Price Change:</strong> ${result.price_analysis.price_change?.absolute || 'N/A'}</p>
                            <p><strong>Price Change %:</strong> ${result.price_analysis.price_change?.percentage?.toFixed(2) || 'N/A'}%</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (result.returns_analysis && Object.keys(result.returns_analysis).length > 0) {
        html += `
            <div class="card mb-3" style="background-color: var(--light-color); color: var(--text-primary);">
                <div class="card-body">
                    <h6 style="color: var(--text-primary);">Returns Analysis</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Mean Return:</strong> ${(result.returns_analysis.mean_return * 100).toFixed(2)}%</p>
                            <p><strong>Std Return:</strong> ${(result.returns_analysis.std_return * 100).toFixed(2)}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Return:</strong> ${result.returns_analysis.total_return?.toFixed(2) || 'N/A'}%</p>
                            <p><strong>Sharpe Ratio:</strong> ${result.returns_analysis.sharpe_ratio?.toFixed(2) || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    if (result.volatility_analysis && Object.keys(result.volatility_analysis).length > 0) {
        html += `
            <div class="card mb-3" style="background-color: var(--light-color); color: var(--text-primary);">
                <div class="card-body">
                    <h6 style="color: var(--text-primary);">Volatility Analysis</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Daily Volatility:</strong> ${(result.volatility_analysis.daily_volatility * 100).toFixed(2)}%</p>
                            <p><strong>Annualized Volatility:</strong> ${(result.volatility_analysis.annualized_volatility * 100).toFixed(2)}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Max Drawdown:</strong> ${result.volatility_analysis.max_drawdown?.toFixed(2) || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    return html;
}

function displayStatisticalAnalysis(result) {
    let html = '<h6 class="mb-3" style="color: var(--text-primary);">Statistical Analysis</h6>';
    
    // Summary information
    if (result.summary) {
        html += '<div class="alert alert-info" style="background-color: var(--light-color); color: var(--text-primary); border-left: 4px solid var(--info-color);">';
        html += `<p><strong>Dataset Summary:</strong></p>`;
        html += `<ul>`;
        html += `<li>Total Rows: ${result.summary.total_rows}</li>`;
        html += `<li>Total Columns: ${result.summary.total_columns}</li>`;
        html += `<li>Numeric Columns: ${result.summary.numeric_columns}</li>`;
        html += `</ul></div>`;
    }
    
    // Close price statistics (if available)
    if (result.close_price_stats) {
        html += '<h6 class="mb-3" style="color: var(--text-primary);">Close Price Statistics</h6>';
        html += '<div class="table-responsive"><table class="table table-sm" style="background-color: var(--light-color); color: var(--text-primary);">';
        html += '<thead style="background-color: var(--dark-color); color: var(--text-white);"><tr><th>Statistic</th><th>Value</th></tr></thead><tbody>';
        
        Object.entries(result.close_price_stats).forEach(([stat, value]) => {
            html += `<tr><td><strong>${stat}</strong></td><td>${value.toFixed(2)}</td></tr>`;
        });
        html += '</tbody></table></div>';
    }
    
    // Descriptive statistics
    if (result.descriptive_stats) {
        html += '<h6 class="mb-3" style="color: var(--text-primary);">Descriptive Statistics</h6>';
        html += '<div class="table-responsive"><table class="table table-sm" style="background-color: var(--light-color); color: var(--text-primary);">';
        html += '<thead style="background-color: var(--dark-color); color: var(--text-white);"><tr><th>Statistic</th>';
        
        // Add column headers
        const firstStat = Object.values(result.descriptive_stats)[0];
        if (firstStat && typeof firstStat === 'object') {
            Object.keys(firstStat).forEach(col => {
                // Fix: Handle undefined/null column names
                const displayCol = (col !== null && col !== undefined && col !== '') ? col : 'Column';
                html += `<th>${displayCol}</th>`;
            });
        }
        html += '</tr></thead><tbody>';
        
        // Add data rows
        Object.entries(result.descriptive_stats).forEach(([stat, values]) => {
            html += `<tr style="color: var(--text-primary);"><td><strong>${stat}</strong></td>`;
            if (typeof values === 'object') {
                Object.values(values).forEach(value => {
                    if (typeof value === 'number') {
                        // Format large numbers with commas for readability
                        if (Math.abs(value) >= 1000) {
                            html += `<td>${value.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>`;
                        } else {
                            html += `<td>${value.toFixed(2)}</td>`;
                        }
                    } else {
                        html += `<td>${value}</td>`;
                    }
                });
            } else {
                html += `<td>${values}</td>`;
            }
            html += '</tr>';
        });
        html += '</tbody></table></div>';
    }
    
    return html;
}

function displayCorrelationAnalysis(result) {
    let html = '<h6 class="mb-3" style="color: var(--text-primary);">Correlation Analysis</h6>';
    
    // Summary information
    if (result.summary) {
        html += '<div class="alert alert-info" style="background-color: var(--light-color); color: var(--text-primary); border-left: 4px solid var(--info-color);">';
        html += `<p><strong>Correlation Summary:</strong></p>`;
        html += `<ul>`;
        html += `<li>Total Numeric Columns: ${result.summary.total_numeric_columns}</li>`;
        // HTML-escape column names to prevent them being interpreted as HTML tags
        const escapedColumns = result.summary.columns_analyzed.map(col => 
            col.replace(/</g, '&lt;').replace(/>/g, '&gt;')
        );
        html += `<li>Columns Analyzed: ${escapedColumns.join(', ')}</li>`;
        html += `</ul></div>`;
    }
    
    // Add correlation heatmap chart
    if (result.correlation_matrix && Object.keys(result.correlation_matrix).length > 0) {
        html += `
            <div class="card mb-3" style="background-color: var(--light-color); color: var(--text-primary);">
                <div class="card-body">
                    <h6 style="color: var(--text-primary);">Correlation Heatmap</h6>
                    <canvas id="correlationChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        `;
    }
    
    // Correlation matrix
    if (result.correlation_matrix) {
        html += '<h6 class="mb-3" style="color: var(--text-primary);">Correlation Matrix</h6>';
        html += '<div class="table-responsive"><table class="table table-sm" style="background-color: var(--light-color); color: var(--text-primary);">';
        html += '<thead style="background-color: var(--dark-color); color: var(--text-white);"><tr><th>Column</th>';
        
        // Add column headers
        const firstRow = Object.values(result.correlation_matrix)[0];
        if (firstRow && typeof firstRow === 'object') {
            Object.keys(firstRow).forEach(col => {
                // Fix: Handle undefined/null column names
                const displayCol = (col !== null && col !== undefined && col !== '') ? col : 'Column';
                html += `<th>${displayCol}</th>`;
            });
        }
        html += '</tr></thead><tbody>';
        
        // Add data rows
        Object.entries(result.correlation_matrix).forEach(([col, correlations]) => {
            // Fix: Handle undefined/null column names
            const displayCol = (col !== null && col !== undefined && col !== '') ? col : 'Column';
            html += `<tr style="color: var(--text-primary);"><td><strong>${displayCol}</strong></td>`;
            if (typeof correlations === 'object') {
                Object.values(correlations).forEach(value => {
                    html += `<td>${typeof value === 'number' ? value.toFixed(3) : value}</td>`;
                });
            } else {
                html += `<td>${correlations}</td>`;
            }
            html += '</tr>';
        });
        html += '</tbody></table></div>';
    }
    
    return html;
}

function loadPriceChart(filename, filePath) {
    // Get sample price data for charting
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    REDLINE.api.post('/analysis/chart-data', {
        filename: filename,
        file_path: filePath,
        chart_type: 'price',
        license_key: licenseKey
    })
    .then(response => {
        if (response.data && response.data.length > 0) {
            createPriceChart(response.data, response.labels);
        }
    })
    .catch(error => {
        console.log('Chart data not available:', error);
    });
}

function createPriceChart(data, labels) {
    const canvas = document.getElementById('priceChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const chartData = {
        labels: labels || data.map((_, i) => i),
        datasets: [{
            label: 'Price',
            data: data,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
        }]
    };
    
    if (chartInstances.priceChart) {
        chartInstances.priceChart.destroy();
    }
    
    chartInstances.priceChart = chartHelper.createLineChart('priceChart', chartData, {
        plugins: {
            legend: { display: true }
        },
        scales: {
            y: { beginAtZero: false }
        }
    });
}

function createCorrelationChart(result) {
    const canvas = document.getElementById('correlationChart');
    if (!canvas || !result.correlation_matrix) return;
    
    // Convert correlation matrix to chart data
    const columns = Object.keys(result.correlation_matrix);
    if (columns.length < 2) return;
    
    const labels = columns;
    const datasets = columns.map((col, idx) => {
        const correlations = result.correlation_matrix[col];
        const data = columns.map(c => correlations[c] || 0);
        
        // Generate color based on index
        const hue = (idx * 360 / columns.length) % 360;
        return {
            label: col,
            data: data,
            backgroundColor: `hsla(${hue}, 70%, 50%, 0.6)`,
            borderColor: `hsl(${hue}, 70%, 50%)`,
            borderWidth: 1
        };
    });
    
    const ctx = canvas.getContext('2d');
    if (chartInstances.correlationChart) {
        chartInstances.correlationChart.destroy();
    }
    
    chartInstances.correlationChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { min: -1, max: 1, title: { display: true, text: 'Correlation' } },
                x: { title: { display: true, text: 'Columns' } }
            },
            plugins: {
                legend: { display: true, position: 'right' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(3);
                        }
                    }
                }
            }
        }
    });
}

function generateBackendChart() {
    if (!window.currentAnalysisResponse) {
        REDLINE.ui.showToast('No analysis data available', 'error');
        return;
    }
    
    const response = window.currentAnalysisResponse;
    const filename = response.filename;
    const filePath = response.file_path;
    const analysisType = response.analysis_type;
    
    REDLINE.ui.showLoading('Generating chart...');
    
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    let endpoint = '';
    let chartData = { filename: filename, file_path: filePath, license_key: licenseKey };
    
    if (analysisType === 'financial') {
        endpoint = '/analysis/price-chart';
    } else if (analysisType === 'correlation') {
        endpoint = '/analysis/correlation-heatmap';
    } else if (analysisType === 'statistical') {
        endpoint = '/analysis/distribution-chart';
    } else {
        REDLINE.ui.hideLoading();
        REDLINE.ui.showToast('Chart generation not available for this analysis type', 'error');
        return;
    }
    
    REDLINE.api.post(endpoint, chartData)
        .then(function(response) {
            REDLINE.ui.hideLoading();
            // Safari-compatible: Check response structure
            var imageData = response.image || (response.data && response.data.image) || null;
            if (imageData) {
                // Display chart in modal or inline
                displayBackendChart(imageData, analysisType);
            } else {
                // Debug: Log response structure
                console.log('Chart response structure:', response);
                REDLINE.ui.showToast('Chart generated but no image returned. Check console for details.', 'error');
            }
        })
        .catch(function(error) {
            REDLINE.ui.hideLoading();
            var errorMsg = error.message || error.error || 'Unknown error';
            console.error('Chart generation error:', error);
            REDLINE.ui.showToast('Error generating chart: ' + errorMsg, 'error');
        });
}

function displayBackendChart(imageData, analysisType) {
    const chartTitle = analysisType === 'financial' ? 'Price Chart' 
                        : analysisType === 'correlation' ? 'Correlation Heatmap'
                        : 'Distribution Chart';
    
    const chartHtml = `
        <div class="card mb-3" style="background-color: var(--light-color); color: var(--text-primary);">
            <div class="card-header">
                <h6 style="color: var(--text-primary);">${chartTitle} (Backend Generated)</h6>
            </div>
            <div class="card-body">
                <img src="${imageData}" class="img-fluid" alt="${chartTitle}" style="max-width: 100%; height: auto;">
            </div>
        </div>
    `;
    
    // Append to results or show in modal
    $('#resultsContent').prepend(chartHtml);
    REDLINE.ui.showToast('Chart generated successfully', 'success');
}

// ML functions moved to /ml/ tab

function exportAnalysis(format = null) {
    if (!currentAnalysisData) {
        REDLINE.ui.showToast('No analysis data to export', 'error');
        return;
    }
    
    // If format not provided, show selection dialog
    if (!format) {
        const formatOptions = ['json', 'csv', 'parquet', 'feather', 'duckdb', 'txt', 'npz', 'arrow'];
        const selectedFormat = prompt(`Enter export format:\n${formatOptions.join(', ')}`, 'json');
        if (!selectedFormat || !formatOptions.includes(selectedFormat.toLowerCase())) {
            REDLINE.ui.showToast('Invalid format selected', 'error');
            return;
        }
        format = selectedFormat.toLowerCase();
    }
    
    // Format display names
    const formatNames = {
        'json': 'JSON',
        'csv': 'CSV',
        'parquet': 'Parquet',
        'feather': 'Feather',
        'duckdb': 'DuckDB',
        'txt': 'TXT',
        'npz': 'NPZ/TensorFlow',
        'arrow': 'Arrow'
    };
    
    const baseFilename = `analysis_${currentAnalysisData.analysis_type}_${Date.now()}`;
    const filename = prompt(`Enter export filename for ${formatNames[format]} format (without extension):`, baseFilename);
    if (!filename) return;
    
    REDLINE.ui.showLoading(`Exporting analysis as ${formatNames[format]}...`);
    
    const exportData = {
        analysis_result: currentAnalysisData.result,
        filename: filename,
        format: format.toLowerCase()
    };
    
    REDLINE.api.post('/analysis/export-analysis', exportData)
        .then(response => {
            REDLINE.ui.hideLoading();
            REDLINE.ui.showToast(`Analysis exported successfully: ${response.export_filename}`, 'success');
        })
        .catch(error => {
            REDLINE.ui.hideLoading();
            const errorMsg = error.response?.data?.error || error.message || 'Unknown error';
            REDLINE.ui.showToast('Error exporting analysis: ' + errorMsg, 'error');
        });
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Data View - Single File{% endblock %}

{% block page_title %}Data View - Single File{% endblock %}
{% block page_subtitle %}View and manage your financial data files{% endblock %}

{% block extra_css %}
<style>
    /* Navbar and dropdowns should be above all content */
    .navbar {
        z-index: 1030 !important;
    }
    
    .dropdown-menu {
        z-index: 1050 !important;
    }
    
    /* Match multi-view CSS template exactly */
    .file-selector {
        background-color: var(--light-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        color: var(--text-primary);
    }
    
    .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--light-color);
        color: var(--text-primary);
        position: relative;
        z-index: 2;
    }
    
    .file-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .file-list::-webkit-scrollbar-track {
        background: var(--light-color);
        border-radius: 4px;
    }
    
    .file-list::-webkit-scrollbar-thumb {
        background: var(--secondary-color);
        border-radius: 4px;
    }
    
    .file-list::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
    }
    
    .file-item {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
        position: relative;
        z-index: 3;
        min-height: 50px;
    }
    
    .file-item:hover {
        background-color: var(--secondary-color);
        color: var(--text-white);
    }
    
    .file-item.selected {
        background-color: var(--info-color);
        color: var(--text-white);
        border-left: 4px solid var(--info-color);
    }
    
    .file-info {
        flex: 1;
        font-size: 14px;
        min-width: 0;
        overflow: hidden;
        position: relative;
        z-index: 3;
    }
    
    .file-name {
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        display: block;
        margin-bottom: 2px;
    }
    
    .file-size {
        color: var(--text-muted);
        font-size: 12px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        display: block;
    }
    
    .data-display-area {
        background: var(--light-color);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        min-height: 500px;
    }
    
    .dataset-container {
        margin-bottom: 30px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .dataset-header {
        background: var(--light-color);
        color: var(--text-primary);
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .dataset-title {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .dataset-info {
        color: var(--text-muted);
        font-size: 14px;
        margin: 0;
    }
    
    .dataset-content {
        padding: 0;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    
    /* Virtual scrolling styles */
    .virtual-scroll-container {
        height: 500px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background-color: var(--light-color);
        margin-bottom: 20px;
    }
    
    .virtual-scroll-header, .virtual-scroll-footer {
        padding: 10px 15px;
        background-color: var(--dark-color);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--text-white);
    }
    
    .virtual-scroll-footer {
        border-top: 1px solid var(--border-color);
        border-bottom: none;
    }
    
    .virtual-scroll-viewport {
        flex-grow: 1;
        overflow-y: auto;
        position: relative;
    }
    
    .virtual-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }
    
    .virtual-table thead th {
        position: sticky;
        top: 0;
        background-color: var(--dark-color);
        color: var(--text-white);
        z-index: 1;
        padding: 0.75rem;
        font-weight: 600;
    }
    
    .pagination-info {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .table th {
        background-color: var(--dark-color) !important;
        color: var(--text-white) !important;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
        border-color: var(--border-color) !important;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .no-data-message {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
        font-style: italic;
    }
    
    /* Data info - match multi-view styling */
    .data-info {
        background-color: var(--dark-color) !important;
        color: var(--text-white) !important;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }
    
    .data-info h6 {
        font-weight: 600;
        color: var(--text-white) !important;
        margin: 0;
    }
    
    .data-info p {
        color: var(--text-white) !important;
        margin: 0;
        font-size: 14px;
    }
    
    /* Ensure table headers have proper contrast */
    .table thead.table-dark th,
    thead.table-dark th {
        background-color: var(--dark-color) !important;
        color: var(--text-white) !important;
    }
    
    /* Fallback for dark theme where dark-color might be light - use black background */
    body.theme-dark .table thead.table-dark th,
    body.theme-dark thead.table-dark th {
        background-color: #000000 !important;
        color: #ffffff !important;
    }
    
    thead {
        display: table-header-group !important;
        visibility: visible !important;
    }
    
    thead.table-dark {
        display: table-header-group !important;
        visibility: visible !important;
    }
    
    .modal-content {
        background-color: var(--light-color);
        color: var(--text-primary);
    }
    
    .modal-header {
        border-bottom-color: var(--border-color);
    }
    
    .modal-footer {
        border-top-color: var(--border-color);
    }
    
    .form-select, .form-control {
        background-color: var(--light-color) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-color) !important;
    }
    
    .form-select:focus, .form-control:focus {
        background-color: var(--light-color) !important;
        color: var(--text-primary) !important;
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 0.2rem color-mix(in srgb, var(--primary-color) 25%, transparent);
    }
    
    .form-check-input {
        background-color: var(--light-color) !important;
        border-color: var(--border-color) !important;
        cursor: pointer !important;
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
    }
    
    .form-check-input:not(:disabled):not([readonly]) {
        cursor: pointer !important;
    }
    
    .form-select:not(:disabled):not([readonly]) {
        cursor: pointer !important;
    }
    
    .form-label, .form-check-label {
        cursor: pointer !important;
        color: var(--text-primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="/data/" class="btn btn-outline-primary active">Single File View</a>
                <a href="/data/multi" class="btn btn-outline-primary">Multi-File View</a>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- File Selector Panel - Match multi-view exactly -->
        <div class="col-md-4">
            <div class="file-selector">
                <h5 class="mb-3">üìÅ Select File to Load</h5>
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshFileList()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="file-list" id="fileList">
                    <div class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading files...</span>
                        </div>
                        <p class="mt-2 mb-0">Loading file list...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Display Area - Match multi-view exactly -->
        <div class="col-md-8">
            <div class="data-display-area">
                <h5 class="mb-3">üìä Single File Data View</h5>
                <div class="mb-3 d-flex align-items-center gap-2">
                    <!-- Date Format Selector - Always Visible -->
                    <div class="input-group" style="width: auto;">
                        <label class="input-group-text" for="dateFormatSelect" style="margin-bottom: 0;">
                            <i class="fas fa-calendar-alt me-1"></i>Date Format:
                        </label>
                        <select id="dateFormatSelect" class="form-select" style="width: auto;">
                            <option value="auto">Auto (YYYY-MM-DD)</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                            <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                            <option value="YYYY/MM/DD">YYYY/MM/DD</option>
                            <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                            <option value="MM-DD-YYYY">MM-DD-YYYY</option>
                            <option value="raw">Raw (No Formatting)</option>
                        </select>
                    </div>
                    <!-- Column Names Editor Button -->
                    <button class="btn btn-sm btn-outline-info" onclick="showColumnEditor()" title="Edit column names" id="editColumnsBtn">
                        <i class="fas fa-edit"></i> Edit Columns
                    </button>
                </div>
                <div id="dataDisplay">
                    <div class="no-data-message">
                        <i class="fas fa-database fa-3x mb-3"></i>
                        <h6>No file loaded</h6>
                        <p>Click on a file from the left panel to view data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables - attach to window to ensure global scope
window.currentFile = null;
window.currentData = null;
window.currentColumns = null;
window.currentPage = 1;
window.pageSize = 500;
window.virtualScrollTable = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tkinter-style data view loaded');
    refreshFileList();
    
    // Load saved date format preference
    const savedDateFormat = localStorage.getItem('redline-date-format') || 'auto';
    const dateFormatSelect = document.getElementById('dateFormatSelect');
    if (dateFormatSelect) {
        dateFormatSelect.value = savedDateFormat;
        
        // Date format change handler
        dateFormatSelect.addEventListener('change', function() {
            const selectedFormat = this.value;
            localStorage.setItem('redline-date-format', selectedFormat);
            console.log('Date format changed to:', selectedFormat);
            
            // Re-render table if data is already loaded
            if (window.currentData && window.currentData.length > 0) {
                console.log('Re-rendering table with new date format');
                displayDataTable({
                    filename: window.currentFile || 'Current file',
                    columns: window.currentColumns,
                    data: window.currentData,
                    total_rows: window.currentData.length
                });
            }
        });
    }
});

// Refresh file list (like tkinter refresh)
function refreshFileList() {
    console.log('Refreshing file list...');
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    const fileListDiv = document.getElementById('fileList');
    fileListDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading files...</div>';
    
    fetch('/api/files', {
        method: 'GET',
        headers: licenseKey ? { 'X-License-Key': licenseKey } : {}
    })
        .then(response => {
            // Check if response is OK
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `HTTP ${response.status}: ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Files loaded:', data.files ? data.files.length : 0);
            if (data.files && Array.isArray(data.files)) {
                displayFileList(data.files);
            } else {
                console.warn('Invalid response format:', data);
                displayFileList([]);
            }
        })
        .catch(error => {
            console.error('Error loading files:', error);
            const errorMsg = error.message || 'Unknown error occurred';
            fileListDiv.innerHTML = `
                <div class="text-center text-danger p-3">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <div><strong>Error loading files</strong></div>
                    <small class="text-muted">${errorMsg}</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadFileList()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>
            `;
        });
}

// Display file list - match multi-view structure exactly
function displayFileList(files) {
    const fileListDiv = document.getElementById('fileList');
    
    if (files.length === 0) {
        fileListDiv.innerHTML = '<div class="text-center p-3 text-muted">No files found</div>';
        return;
    }
    
    let html = '';
    files.forEach(file => {
        const fileSize = formatFileSize(file.size || 0);
        const modifiedDate = new Date(file.modified * 1000).toLocaleDateString();
        const isSelected = window.currentFile === file.name;
        
        html += `
            <div class="file-item ${isSelected ? 'selected' : ''}" data-filename="${file.name}" onclick="loadFileData('${file.name}')">
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize} ‚Ä¢ ${modifiedDate}</div>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFile('${file.name}', event)" title="Delete file" style="flex-shrink: 0;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    
    fileListDiv.innerHTML = html;
}

// Delete file
async function deleteFile(filename, event) {
    if (event) event.stopPropagation();
    
    if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to delete files.');
        return;
    }
    
    try {
        const response = await fetch(`/api/files/${encodeURIComponent(filename)}`, {
            method: 'DELETE',
            headers: {
                'X-License-Key': licenseKey
            }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || data.message || `HTTP ${response.status}`);
        }
        
        // Show success message
        console.log('File deleted successfully:', filename);
        
        // Refresh file list
        refreshFileList();
        
        // If the deleted file was currently loaded, clear the display
        if (window.currentFile === filename) {
            window.currentFile = null;
            window.currentData = null;
            document.getElementById('dataDisplay').innerHTML = `
                <div class="no-data-message">
                    <i class="fas fa-database fa-3x mb-3"></i>
                    <h6>No file loaded</h6>
                    <p>Click on a file from the left panel to view data</p>
                </div>
            `;
            document.getElementById('dataActions').style.display = 'none';
        }
        
        // Show toast notification if available
        if (typeof window.showToast === 'function') {
            window.showToast(`File "${filename}" deleted successfully`, 'success');
        } else {
            alert(`File "${filename}" deleted successfully`);
        }
        
    } catch (error) {
        console.error('Error deleting file:', error);
        alert(`Error deleting file: ${error.message}`);
    }
}

// Load file data (like tkinter refresh_data)
function loadFileData(filename, page = 1) {
    console.log('Loading data for file:', filename, 'page:', page);
    
    // Reset page if loading new file
    if (window.currentFile !== filename) {
        window.currentPage = 1;
        window.currentFile = filename;
    } else {
        window.currentPage = page;
    }
    
    // Update selected file - match multi-view structure
    document.querySelectorAll('.file-item').forEach(item => {
        item.classList.remove('selected');
    });
    document.querySelectorAll(`[data-filename="${filename}"]`).forEach(item => {
        item.classList.add('selected');
    });
    
    // Show loading spinner
    const dataDisplay = document.getElementById('dataDisplay');
    dataDisplay.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading ${filename}...</p>
        </div>
    `;
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        dataDisplay.innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i> License key is required. Please register or enter your license key.
            </div>
        `;
        return;
    }
    
    // Load data with pagination
    fetch('/data/load', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-License-Key': licenseKey
        },
        body: JSON.stringify({ 
            filename: filename,
            license_key: licenseKey,
            page: page,
            per_page: window.pageSize || 500
        })
    })
    .then(response => {
        // Always parse JSON first
        return response.json().then(data => {
            // Check HTTP status and response structure
            if (!response.ok) {
                // HTTP error (4xx, 5xx)
                const errorMsg = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
                throw new Error(errorMsg);
            }
            
            // Check for error in response body (even if HTTP status is 200)
            if (data.error || data.code) {
                throw new Error(data.error || data.message || 'Unknown error');
            }
            
            // Validate response structure - must have columns or data
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid response format: response is not an object');
            }
            
            // Ensure columns array exists
            if (!data.columns || !Array.isArray(data.columns)) {
                console.warn('Response missing columns array, attempting to extract:', data);
                // Try to extract columns from data if available
                if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                    data.columns = Object.keys(data.data[0]);
                    console.log('Extracted columns from data:', data.columns);
                } else {
                    data.columns = [];
                    console.warn('No columns found and no data to extract from');
                }
            }
            
            // Ensure total_rows exists
            if (data.total_rows === undefined || data.total_rows === null) {
                data.total_rows = (data.data && Array.isArray(data.data)) ? data.data.length : 0;
            }
            
            // Ensure filename exists
            if (!data.filename) {
                data.filename = filename;
            }
            
            // Ensure data array exists
            if (!data.data || !Array.isArray(data.data)) {
                data.data = [];
            }
            
                // Safe logging - all checks done above
                console.log('Data loaded successfully:', {
                    filename: data.filename,
                    total_rows: data.total_rows,
                    column_count: (data.columns && Array.isArray(data.columns)) ? data.columns.length : 0,
                    columns: data.columns || [],
                    data_rows: (data.data && Array.isArray(data.data)) ? data.data.length : 0
                });
                
                // Debug: Log the actual columns array
                console.log('Columns array:', data.columns);
                console.log('Columns array type:', typeof data.columns, 'Is array:', Array.isArray(data.columns));
                console.log('Columns array length:', data.columns ? data.columns.length : 0);
                console.log('First row keys:', data.data && data.data.length > 0 ? Object.keys(data.data[0]) : 'No data');
                console.log('Calling displayDataTable with data:', {
                    hasColumns: !!data.columns,
                    columnsLength: data.columns ? data.columns.length : 0,
                    hasData: !!data.data,
                    dataLength: data.data ? data.data.length : 0
                });
            
                window.currentFile = filename;
                window.currentData = data.data;
                window.currentColumns = data.columns;  // Store columns for date format changes
                displayDataTable(data);
                
        });
    })
    .catch(error => {
        console.error('Error loading data:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack
        });
        
        const dataDisplay = document.getElementById('dataDisplay');
        if (dataDisplay) {
            let errorMessage = error.message || 'Unknown error occurred';
            
            // Provide helpful error messages
            if (errorMessage.includes('License') || errorMessage.includes('license')) {
                errorMessage = 'License key required or invalid. Please check your license key.';
            } else if (errorMessage.includes('not found') || errorMessage.includes('404')) {
                errorMessage = 'File not found. Please check the filename.';
            }
            
            // Enhanced error display with helpful information
            let errorDetails = '';
            if (errorMessage.includes('File not found')) {
                errorDetails = `
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Searched locations:</strong><br>
                            ‚Ä¢ data/${filename}<br>
                            ‚Ä¢ data/downloaded/${filename}<br>
                            ‚Ä¢ data/stooq/${filename}<br>
                            ‚Ä¢ data/converted/**/${filename}<br>
                        </small>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Tip:</strong> Make sure the file exists in one of these directories.
                            You can download files using the Download tab.
                        </small>
                    </div>
                `;
            }
            
            dataDisplay.innerHTML = `
                <div class="text-center text-danger p-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h6>Error Loading Data</h6>
                    <p><strong>File:</strong> ${filename}</p>
                    <p>${errorMessage}</p>
                    ${errorDetails}
                    <small class="text-muted d-block mt-3">Check browser console for details</small>
                </div>
            `;
        } else {
            console.error('Data display container not found!');
        }
    });
}

// Listen for theme changes and re-render table if needed
$(document).on('themeChanged', function(event, theme) {
    // If we have a current file loaded, re-render it with new theme colors
    if (window.currentFile && window.currentData) {
        console.log('Theme changed to:', theme, '- re-rendering table with new colors');
        // Re-render the table with updated colors
        displayDataTable({
            filename: window.currentFile,
            columns: window.currentColumns || (window.currentData.length > 0 ? Object.keys(window.currentData[0]) : []),
            data: window.currentData,
            total_rows: window.currentData.length
        });
    }
});

// Display data table (like tkinter data_tree)
function displayDataTable(data) {
    console.log('displayDataTable called with:', data);
    console.log('displayDataTable - data.columns:', data.columns);
    console.log('displayDataTable - data.data:', data.data ? data.data.length : 0, 'rows');
    
    const dataDisplay = document.getElementById('dataDisplay');
    if (!dataDisplay) {
        console.error('Data display container not found');
        return;
    }

    // Clear the display first to ensure old headers are removed
    dataDisplay.innerHTML = '';

    // Validate data structure
    if (!data) {
        console.error('displayDataTable: No data received');
        dataDisplay.innerHTML = '<div class="text-center text-danger">No data received</div>';
        return;
    }
    
    // Ensure columns array exists - always extract fresh columns from data
    console.log('displayDataTable: Checking columns. data.columns:', data.columns, 'Type:', typeof data.columns, 'Is array:', Array.isArray(data.columns));
    
    // Always extract columns from the actual data to ensure they're current
    let columnsToUse = [];
    if (data.columns && Array.isArray(data.columns) && data.columns.length > 0) {
        // Use provided columns but verify they match the data
        columnsToUse = data.columns;
        console.log('displayDataTable: Using provided columns:', columnsToUse);
        
        // Verify columns match data keys
        if (data.data && data.data.length > 0) {
            const dataKeys = Object.keys(data.data[0]);
            const missingInData = columnsToUse.filter(col => !dataKeys.includes(col));
            const missingInColumns = dataKeys.filter(key => !columnsToUse.includes(key));
            
            if (missingInData.length > 0 || missingInColumns.length > 0) {
                console.warn('displayDataTable: Column mismatch detected. Missing in data:', missingInData, 'Missing in columns:', missingInColumns);
                // Use data keys as source of truth
                columnsToUse = dataKeys;
                console.log('displayDataTable: Updated to use data keys:', columnsToUse);
            }
        }
    } else if (data.data && Array.isArray(data.data) && data.data.length > 0) {
        // Extract columns from first row
        columnsToUse = Object.keys(data.data[0]);
        console.log('displayDataTable: Extracted columns from first row:', columnsToUse);
    } else {
        columnsToUse = [];
        console.warn('displayDataTable: No data to extract columns from');
    }
    
    // Update data.columns to match what we're actually using
    data.columns = columnsToUse;
    
    // Ensure total_rows exists
    const totalRows = data.total_rows !== undefined ? data.total_rows : (data.data ? data.data.length : 0);
    const filename = data.filename || 'Unknown file';
    
    // Ensure columns is always an array before accessing length
    const columnCount = (data.columns && Array.isArray(data.columns)) ? data.columns.length : 0;
    console.log('displayDataTable: Final columnCount:', columnCount, 'columns:', data.columns);
    
    // Detect if file is merged (check filename for "merged" pattern)
    const isMergedFile = filename.toLowerCase().includes('merged');
    
    // Determine display method: virtual scrolling for merged files or files >10k rows
    const useVirtualScrolling = isMergedFile || totalRows > 10000;
    
    // Declare totalPages at function scope for use in event handlers
    let totalPages = 1;
    
    // Data info - use theme colors
    let html = `
        <div class="data-info">
            <h6>üìÑ ${filename}</h6>
            <p class="mb-0"><strong>Rows:</strong> ${totalRows} | <strong>Columns:</strong> ${columnCount}</p>
            ${useVirtualScrolling ? '<p class="mb-0"><small><i class="fas fa-info-circle"></i> Using virtual scrolling for optimal performance</small></p>' : ''}
        </div>
    `;
    
    if (useVirtualScrolling) {
        // Use virtual scrolling for merged files or large files
        html += '<div id="virtualScrollContainer"></div>';
        dataDisplay.innerHTML = html;
        
        // Check if VirtualScrollTable is available
        if (typeof VirtualScrollTable === 'undefined' && typeof window.VirtualScrollTable === 'undefined') {
            console.error('VirtualScrollTable is not available. Falling back to pagination.');
            // Fall back to regular pagination
            useVirtualScrolling = false;
            // Re-render with pagination
            displayDataTable(data);
            return;
        }
        
        // Initialize virtual scroll table
        const container = $('#virtualScrollContainer');
        if (window.virtualScrollTable) {
            window.virtualScrollTable.destroy();
        }
        
        // Use window.VirtualScrollTable (should be set by the script)
        if (!window.VirtualScrollTable) {
            console.error('window.VirtualScrollTable is not available. Falling back to pagination.');
            useVirtualScrolling = false;
            displayDataTable(data);
            return;
        }
        
        window.virtualScrollTable = new window.VirtualScrollTable(container, {
            rowHeight: 30,
            visibleRows: 20,
            buffer: 5,
            pageSize: 500
        });
        
        // Load data from API with pagination
        const licenseKey = (typeof window.getLicenseKey === 'function') 
            ? window.getLicenseKey() 
            : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
        
        window.virtualScrollTable.loadDataFromAPI(`/data/load`, {
            filename: filename,
            license_key: licenseKey
        });
        
    } else if (data.data && data.data.length > 0 && columnCount > 0) {
        // Use pagination for regular files (<10k rows)
        const currentPage = window.currentPage || 1;
        const pageSize = window.pageSize || 500;
        const startIdx = (currentPage - 1) * pageSize;
        const endIdx = Math.min(startIdx + pageSize, data.data.length);
        totalPages = Math.ceil(totalRows / pageSize);  // Update function-scope variable
        const pageData = data.data.slice(startIdx, endIdx);
        // Create table with proper Bootstrap styling
        html += '<div class="table-responsive" style="overflow-x: auto;">';
        html += '<table class="table table-striped table-hover table-sm" style="border-collapse: collapse; width: 100%;">';
        
        // Headers - use columnsToUse that was determined at function start
        console.log('Creating table headers. Columns:', columnsToUse, 'Column count:', columnCount);
        
        // columnsToUse is already determined at the start of the function
        // This ensures we always use the correct, up-to-date columns
        
        // Get computed CSS variable values for proper contrast
        // Read from body element which has the theme class applied
        const bodyStyle = getComputedStyle(document.body);
        
        // Get actual computed values from body (which has theme class)
        let headerBgColor = bodyStyle.getPropertyValue('--dark-color').trim();
        let headerTextColor = bodyStyle.getPropertyValue('--text-white').trim();
        let borderColor = bodyStyle.getPropertyValue('--border-color').trim();
        
        // Check if we're in dark theme
        const isDarkTheme = document.body.classList.contains('theme-dark') || 
                           document.body.classList.contains('dark') ||
                           (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        // In dark theme, --dark-color is actually light (#f9fafb), so we need a dark color for headers
        // For headers, we always want dark/black background with white text for contrast
        // Use a standard dark color that works for all themes
        if (isDarkTheme) {
            // Dark theme: use black background for headers (not the light --dark-color value)
            headerBgColor = '#000000'; // Pure black for dark mode headers
        } else {
            // Light themes: use the theme's dark-color, but ensure it's dark
            if (!headerBgColor || headerBgColor === '' || headerBgColor === '#fff' || headerBgColor === '#ffffff' || headerBgColor === '#f9fafb') {
                headerBgColor = '#212529'; // Bootstrap dark
            }
        }
        
        // Always use white text for headers for maximum contrast
        if (!headerTextColor || headerTextColor === '' || headerTextColor === '#000' || headerTextColor === '#000000') {
            headerTextColor = '#ffffff';
        }
        
        // Fallback for border color
        if (!borderColor || borderColor === '') {
            borderColor = isDarkTheme ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
        }
        
        console.log('Using header colors - bg:', headerBgColor, 'text:', headerTextColor, 'isDarkTheme:', isDarkTheme);
        
        // HTML escape function to prevent < > from being interpreted as HTML tags
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Use Bootstrap table-dark with computed colors to ensure visibility
        html += `<thead class="table-dark"><tr>`;
        if (columnsToUse.length > 0) {
            columnsToUse.forEach((col, index) => {
                // Fix: Handle undefined/null column names and HTML escape them
                const displayCol = (col !== null && col !== undefined && col !== '') ? String(col) : `Column_${index + 1}`;
                const escapedCol = escapeHtml(displayCol);  // Escape HTML to prevent < > from being interpreted as tags
                console.log(`Adding header ${index}: "${displayCol}" (escaped: "${escapedCol}")`);
                // Use computed color values (not CSS variables) in inline styles for proper rendering
                html += `<th scope="col" style="background-color: ${headerBgColor} !important; color: ${headerTextColor} !important; padding: 0.75rem !important; font-weight: 600 !important; border: 1px solid ${borderColor} !important;">${escapedCol}</th>`;
            });
        } else {
            console.error('No columns available to display!');
            html += `<th scope="col" style="background-color: ${headerBgColor} !important; color: ${headerTextColor} !important;">No Columns</th>`;
        }
        html += '</tr></thead>';
        
        // Data rows - display actual values
        html += '<tbody>';
        // Use the same columns array for data rows
        const columnsForRows = columnsToUse.length > 0 ? columnsToUse : (data.columns || []);
        pageData.forEach((row, index) => {
            html += '<tr>';
            columnsForRows.forEach(col => {
                const value = row[col];
                let formattedValue = value;
                
                // Check if this is a time column first
                const isTimeColumn = col && (
                    col.toLowerCase().includes('time') ||
                    col === '<TIME>' ||
                    col === 'TIME'
                );
                
                if (isTimeColumn && typeof formatTimeValue === 'function') {
                    // Format time values (HHMMSS -> HH:MM:SS)
                    formattedValue = formatTimeValue(value, col);
                } else if (typeof formatDateValue === 'function') {
                    // Format date values and numeric values properly
                    formattedValue = formatDateValue(value, col);
                }
                let displayValue = '';
                if (formattedValue === null || formattedValue === undefined || formattedValue === '') {
                    displayValue = '';
                } else if (typeof formattedValue === 'number') {
                    // Format numbers with appropriate precision
                    displayValue = Number(formattedValue).toLocaleString();
                } else {
                    displayValue = String(formattedValue);
                }
                html += `<td>${displayValue}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
        
        // Pagination controls
        if (totalPages > 1) {
            html += `
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span class="mx-3">
                            Page ${currentPage} of ${totalPages} (Showing ${startIdx + 1}-${endIdx} of ${totalRows} rows)
                        </span>
                        <button class="btn btn-sm btn-outline-primary" id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            `;
        } else if (totalRows > pageSize) {
            html += `<p class="text-muted mt-2">Showing all ${totalRows} rows</p>`;
        }
    } else {
        html += '<div class="text-center text-muted">No data found in file</div>';
    }
    
    dataDisplay.innerHTML = html;
    
    // Bind pagination event handlers for regular files
    if (!useVirtualScrolling && totalPages > 1) {
        const calculatedTotalPages = totalPages;  // Capture for closure
        $('#prevPageBtn').on('click', function() {
            if (window.currentPage > 1) {
                window.currentPage--;
                loadFileData(filename, window.currentPage);
            }
        });
        
        $('#nextPageBtn').on('click', function() {
            if (window.currentPage < calculatedTotalPages) {
                window.currentPage++;
                loadFileData(filename, window.currentPage);
            }
        });
    }
}

// formatDateValue() is now loaded from redline/web/static/js/date-formatter.js
// No need to define it here - it's available globally from base.html

// Clean data (remove duplicates, handle missing values)
var cleanedData = null;


// Show column editor modal
function showColumnEditor() {
    if (!window.currentColumns || window.currentColumns.length === 0) {
        alert('Please load a file first to edit column names.');
        return;
    }
    
    // Create modal dynamically
    const modalHtml = `
        <div class="modal fade" id="columnEditorModal" tabindex="-1" aria-labelledby="columnEditorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: var(--light-color); color: var(--text-primary);">
                        <h5 class="modal-title" id="columnEditorModalLabel">
                            <i class="fas fa-edit me-2"></i>Edit Column Names
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="background-color: var(--light-color); color: var(--text-primary);">
                        <p class="text-muted">Edit column names below. Changes will be applied to the displayed data.</p>
                        <div id="columnEditorList" class="list-group">
                            ${window.currentColumns.map((col, index) => `
                                <div class="list-group-item d-flex align-items-center">
                                    <label class="form-label mb-0 me-2" style="min-width: 150px;">Column ${index + 1}:</label>
                                    <input type="text" class="form-control column-name-input" data-original="${col}" value="${col}" data-index="${index}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer" style="background-color: var(--light-color); color: var(--text-primary);">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="applyColumnNames()">Apply Changes</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('columnEditorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('columnEditorModal'));
    modal.show();
    
    // Clean up on hide
    document.getElementById('columnEditorModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Apply column name changes
function applyColumnNames() {
    const inputs = document.querySelectorAll('.column-name-input');
    const newColumns = [];
    const columnMapping = {};
    
    inputs.forEach(input => {
        const original = input.getAttribute('data-original');
        const newName = input.value.trim() || original;
        const index = parseInt(input.getAttribute('data-index'));
        
        newColumns[index] = newName;
        if (original !== newName) {
            columnMapping[original] = newName;
        }
    });
    
    // Update global columns
    window.currentColumns = newColumns;
    
    // Update data with new column names
    if (window.currentData && window.currentData.length > 0) {
        const updatedData = window.currentData.map(row => {
            const newRow = {};
            Object.keys(row).forEach(oldKey => {
                const newKey = columnMapping[oldKey] || oldKey;
                newRow[newKey] = row[oldKey];
            });
            return newRow;
        });
        
        window.currentData = updatedData;
        
        // Re-render table
        displayDataTable({
            filename: window.currentFile || 'Current file',
            columns: window.currentColumns,
            data: window.currentData,
            total_rows: window.currentData.length
        });
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('columnEditorModal'));
    if (modal) {
        modal.hide();
    }
    
    if (typeof window.showToast === 'function') {
        window.showToast('Column names updated successfully', 'success');
    } else {
        alert('Column names updated successfully');
    }
}

// Format file size (like tkinter)
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}

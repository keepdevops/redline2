{% extends "base.html" %}

{% block title %}Data View - Single File{% endblock %}

{% block page_title %}Data View - Single File{% endblock %}
{% block page_subtitle %}View and manage your financial data files{% endblock %}

{% block extra_css %}
<style>
        /* Fix for overlapping widgets */
        body {
            position: relative;
            z-index: 1;
        }
        
        .container-fluid {
            position: relative;
            z-index: 1;
        }
        
        .row {
            position: relative;
            z-index: 1;
        }
        
        .card {
            position: relative;
            z-index: 2;
            margin-bottom: 20px;
        }
        
        .file-list-item {
            cursor: pointer;
            padding: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
            z-index: 3;
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        .file-list-item:hover {
            background-color: var(--secondary-color);
            color: var(--text-white);
        }
        .file-list-item.selected {
            background-color: var(--primary-color);
            color: var(--text-white);
        }
        .data-table {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 3;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
            position: relative;
            z-index: 3;
            color: var(--text-primary);
        }
        .data-info {
            background-color: var(--light-color) !important;
            color: var(--text-primary) !important;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            position: relative;
            z-index: 3;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .table th {
            background-color: #1e293b !important;
            color: #ffffff !important;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            display: table-cell !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        thead {
            display: table-header-group !important;
            visibility: visible !important;
        }
        thead.table-dark {
            display: table-header-group !important;
            visibility: visible !important;
        }
        .modal-content {
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        .modal-header {
            border-bottom-color: var(--border-color);
        }
        .modal-footer {
            border-top-color: var(--border-color);
        }
        .form-select, .form-control {
            background-color: var(--light-color) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        .form-select:focus, .form-control:focus {
            background-color: var(--light-color) !important;
            color: var(--text-primary) !important;
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25) !important;
        }
        .form-check-input {
            background-color: var(--light-color) !important;
            border-color: var(--border-color) !important;
            cursor: pointer !important;
        }
        .form-check-input:checked {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .form-check-input:not(:disabled):not([readonly]) {
            cursor: pointer !important;
        }
        .form-select:not(:disabled):not([readonly]) {
            cursor: pointer !important;
        }
        .form-label, .form-check-label {
            cursor: pointer !important;
            color: var(--text-primary) !important;
        }
        .table td {
            vertical-align: middle;
            position: relative;
            z-index: 1;
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            z-index: 3;
        }
        
        /* Ensure proper stacking context */
        .card {
            background-color: var(--light-color);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .card-body {
            position: relative;
            z-index: 3;
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        
        .card-header {
            position: relative;
            z-index: 4;
            background-color: var(--light-color);
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }
        
        /* Data info should use light background, not dark */
        .data-info {
            background-color: var(--light-color) !important;
            color: var(--text-primary) !important;
        }
        
        /* Fix for any floating elements */
        .btn-group {
            position: relative;
            z-index: 5;
        }
        
        /* Ensure data display doesn't overlap */
        #dataDisplay {
            position: relative;
            z-index: 3;
            min-height: 200px;
        }
        
        #fileList {
            position: relative;
            z-index: 3;
            min-height: 200px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="/data/" class="btn btn-outline-primary active">Single File View</a>
                <a href="/data/multi" class="btn btn-outline-primary">Multi-File View</a>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- File List Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìÅ Files</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshFileList()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="fileList">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Loading files...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Display Panel -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìä Data View</h5>
                    <div class="d-flex align-items-center gap-2">
                        <!-- Date Format Selector - Always Visible -->
                        <div class="input-group" style="width: auto;">
                            <label class="input-group-text" for="dateFormatSelect" style="margin-bottom: 0;">
                                <i class="fas fa-calendar-alt me-1"></i>Date Format:
                            </label>
                            <select id="dateFormatSelect" class="form-select" style="width: auto;">
                                <option value="auto">Auto (YYYY-MM-DD)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY/MM/DD">YYYY/MM/DD</option>
                                <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                <option value="MM-DD-YYYY">MM-DD-YYYY</option>
                                <option value="raw">Raw (No Formatting)</option>
                            </select>
                        </div>
                        <!-- Column Names Editor Button -->
                        <button class="btn btn-sm btn-outline-info" onclick="showColumnEditor()" title="Edit column names" id="editColumnsBtn">
                            <i class="fas fa-edit"></i> Edit Columns
                        </button>
                        <div id="dataActions" style="display: none;">
                            <button class="btn btn-sm btn-outline-primary" onclick="showCleanDataModal()" title="Clean data with configurable options" id="cleanDataBtn">
                                <i class="fas fa-broom"></i> Clean Data
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="saveCleanedData()" title="Save cleaned data to file" style="display: none;" id="saveCleanedBtn">
                                <i class="fas fa-save"></i> Save Cleaned
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="dataDisplay">
                        <div class="text-center text-muted">
                            <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                            <p>Click on a file to load its data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clean Data Modal -->
<div class="modal fade" id="cleanDataModal" tabindex="-1" aria-labelledby="cleanDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--light-color); color: var(--text-primary);">
                <h5 class="modal-title" id="cleanDataModalLabel">
                    <i class="fas fa-broom me-2"></i>Clean Data Options
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: var(--light-color); color: var(--text-primary);">
                <form id="cleanDataForm">
                    <!-- Remove Duplicates -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="removeDuplicates" checked style="cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;">
                            <label class="form-check-label" for="removeDuplicates" style="cursor: pointer !important;">
                                <strong>Remove Duplicate Rows</strong>
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            Removes rows that are exact duplicates. If ticker and timestamp columns exist, duplicates are detected based on those columns.
                        </small>
                    </div>
                    
                    <!-- Handle Missing Values -->
                    <div class="mb-3">
                        <label for="handleMissing" class="form-label">
                            <strong>Handle Missing Values</strong>
                        </label>
                        <select class="form-select" id="handleMissing" style="cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important; background-color: #ffffff !important; color: #000000 !important; border-color: var(--border-color) !important;">
                            <option value="drop" selected>Drop rows with missing values</option>
                            <option value="forward_fill">Forward fill (use previous value)</option>
                            <option value="backward_fill">Backward fill (use next value)</option>
                            <option value="none">Don't handle missing values</option>
                        </select>
                        <small class="form-text text-muted">
                            <strong>Drop:</strong> Removes rows with missing values in ticker, timestamp, or close columns<br>
                            <strong>Forward Fill:</strong> Fills missing values with the previous row's value<br>
                            <strong>Backward Fill:</strong> Fills missing values with the next row's value<br>
                            <strong>None:</strong> Leaves missing values as-is
                        </small>
                    </div>
                    
                    <!-- Additional Options -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Additional Options</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cleanColumnNames" checked style="cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;">
                            <label class="form-check-label" for="cleanColumnNames" style="cursor: pointer !important;">
                                Clean column names (remove unnamed/empty columns)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background-color: var(--light-color); border-top-color: var(--border-color);">
                <button type="button" class="btn btn-secondary" onclick="closeCleanDataModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="cleanDataWithOptions()">
                    <i class="fas fa-broom me-2"></i>Clean Data
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables - attach to window to ensure global scope
window.currentFile = null;
window.currentData = null;
window.currentColumns = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tkinter-style data view loaded');
    refreshFileList();
    
    // Load saved date format preference
    const savedDateFormat = localStorage.getItem('redline-date-format') || 'auto';
    const dateFormatSelect = document.getElementById('dateFormatSelect');
    if (dateFormatSelect) {
        dateFormatSelect.value = savedDateFormat;
        
        // Date format change handler
        dateFormatSelect.addEventListener('change', function() {
            const selectedFormat = this.value;
            localStorage.setItem('redline-date-format', selectedFormat);
            console.log('Date format changed to:', selectedFormat);
            
            // Re-render table if data is already loaded
            if (window.currentData && window.currentData.length > 0) {
                console.log('Re-rendering table with new date format');
                displayDataTable({
                    filename: window.currentFile || 'Current file',
                    columns: window.currentColumns,
                    data: window.currentData,
                    total_rows: window.currentData.length
                });
            }
        });
    }
});

// Refresh file list (like tkinter refresh)
function refreshFileList() {
    console.log('Refreshing file list...');
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    const fileListDiv = document.getElementById('fileList');
    fileListDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading files...</div>';
    
    fetch('/api/files', {
        method: 'GET',
        headers: licenseKey ? { 'X-License-Key': licenseKey } : {}
    })
        .then(response => {
            // Check if response is OK
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `HTTP ${response.status}: ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Files loaded:', data.files ? data.files.length : 0);
            if (data.files && Array.isArray(data.files)) {
                displayFileList(data.files);
            } else {
                console.warn('Invalid response format:', data);
                displayFileList([]);
            }
        })
        .catch(error => {
            console.error('Error loading files:', error);
            const errorMsg = error.message || 'Unknown error occurred';
            fileListDiv.innerHTML = `
                <div class="text-center text-danger p-3">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <div><strong>Error loading files</strong></div>
                    <small class="text-muted">${errorMsg}</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadFileList()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>
            `;
        });
}

// Display file list (like tkinter file listbox)
function displayFileList(files) {
    const fileListDiv = document.getElementById('fileList');
    
    if (files.length === 0) {
        fileListDiv.innerHTML = '<div class="text-center text-muted">No files found</div>';
        return;
    }
    
    let html = '';
    files.forEach(file => {
        const fileSize = formatFileSize(file.size || 0);
        const modifiedDate = new Date(file.modified * 1000).toLocaleDateString();
        
        html += `
            <div class="file-list-item d-flex justify-content-between align-items-center" onclick="event.stopPropagation();">
                <div class="flex-grow-1" onclick="loadFileData('${file.name}')" style="cursor: pointer;">
                    <div class="fw-bold">${file.name}</div>
                    <small class="text-muted">${fileSize} ‚Ä¢ ${modifiedDate}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFile('${file.name}', event)" title="Delete file">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    
    fileListDiv.innerHTML = html;
}

// Delete file
async function deleteFile(filename, event) {
    if (event) event.stopPropagation();
    
    if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to delete files.');
        return;
    }
    
    try {
        const response = await fetch(`/api/files/${encodeURIComponent(filename)}`, {
            method: 'DELETE',
            headers: {
                'X-License-Key': licenseKey
            }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || data.message || `HTTP ${response.status}`);
        }
        
        // Show success message
        console.log('File deleted successfully:', filename);
        
        // Refresh file list
        refreshFileList();
        
        // If the deleted file was currently loaded, clear the display
        if (window.currentFile === filename) {
            window.currentFile = null;
            window.currentData = null;
            document.getElementById('dataDisplay').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                    <p>Click on a file to load its data</p>
                </div>
            `;
            document.getElementById('dataActions').style.display = 'none';
        }
        
        // Show toast notification if available
        if (typeof window.showToast === 'function') {
            window.showToast(`File "${filename}" deleted successfully`, 'success');
        } else {
            alert(`File "${filename}" deleted successfully`);
        }
        
    } catch (error) {
        console.error('Error deleting file:', error);
        alert(`Error deleting file: ${error.message}`);
    }
}

// Load file data (like tkinter refresh_data)
function loadFileData(filename) {
    console.log('Loading data for file:', filename);
    
    // Update selected file
    document.querySelectorAll('.file-list-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.target.closest('.file-list-item').classList.add('selected');
    
    // Show loading spinner
    const dataDisplay = document.getElementById('dataDisplay');
    dataDisplay.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading ${filename}...</p>
        </div>
    `;
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        dataDisplay.innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i> License key is required. Please register or enter your license key.
            </div>
        `;
        return;
    }
    
    // Load data
    fetch('/data/load', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-License-Key': licenseKey
        },
        body: JSON.stringify({ 
            filename: filename,
            license_key: licenseKey
        })
    })
    .then(response => {
        // Always parse JSON first
        return response.json().then(data => {
            // Check HTTP status and response structure
            if (!response.ok) {
                // HTTP error (4xx, 5xx)
                const errorMsg = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
                throw new Error(errorMsg);
            }
            
            // Check for error in response body (even if HTTP status is 200)
            if (data.error || data.code) {
                throw new Error(data.error || data.message || 'Unknown error');
            }
            
            // Validate response structure - must have columns or data
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid response format: response is not an object');
            }
            
            // Ensure columns array exists
            if (!data.columns || !Array.isArray(data.columns)) {
                console.warn('Response missing columns array, attempting to extract:', data);
                // Try to extract columns from data if available
                if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                    data.columns = Object.keys(data.data[0]);
                    console.log('Extracted columns from data:', data.columns);
                } else {
                    data.columns = [];
                    console.warn('No columns found and no data to extract from');
                }
            }
            
            // Ensure total_rows exists
            if (data.total_rows === undefined || data.total_rows === null) {
                data.total_rows = (data.data && Array.isArray(data.data)) ? data.data.length : 0;
            }
            
            // Ensure filename exists
            if (!data.filename) {
                data.filename = filename;
            }
            
            // Ensure data array exists
            if (!data.data || !Array.isArray(data.data)) {
                data.data = [];
            }
            
                // Safe logging - all checks done above
                console.log('Data loaded successfully:', {
                    filename: data.filename,
                    total_rows: data.total_rows,
                    column_count: (data.columns && Array.isArray(data.columns)) ? data.columns.length : 0,
                    columns: data.columns || [],
                    data_rows: (data.data && Array.isArray(data.data)) ? data.data.length : 0
                });
                
                // Debug: Log the actual columns array
                console.log('Columns array:', data.columns);
                console.log('Columns array type:', typeof data.columns, 'Is array:', Array.isArray(data.columns));
                console.log('Columns array length:', data.columns ? data.columns.length : 0);
                console.log('First row keys:', data.data && data.data.length > 0 ? Object.keys(data.data[0]) : 'No data');
                console.log('Calling displayDataTable with data:', {
                    hasColumns: !!data.columns,
                    columnsLength: data.columns ? data.columns.length : 0,
                    hasData: !!data.data,
                    dataLength: data.data ? data.data.length : 0
                });
            
                window.currentFile = filename;
                window.currentData = data.data;
                window.currentColumns = data.columns;  // Store columns for date format changes
                displayDataTable(data);
                
                // Show data actions buttons with delay to ensure DOM is ready
                setTimeout(() => {
                    const dataActionsEl = document.getElementById('dataActions');
                    const cleanDataBtn = document.getElementById('cleanDataBtn');
                    
                    console.log('Attempting to show elements:', {
                        dataActionsEl: !!dataActionsEl,
                        cleanDataBtn: !!cleanDataBtn
                    });
                    
                    if (dataActionsEl) {
                        // Force display with multiple methods
                        dataActionsEl.removeAttribute('style');
                        dataActionsEl.style.cssText = 'display: flex !important; visibility: visible !important;';
                        dataActionsEl.style.display = 'flex';
                        dataActionsEl.style.visibility = 'visible';
                        dataActionsEl.classList.remove('d-none');
                        console.log('‚úÖ dataActionsEl shown, computed display:', window.getComputedStyle(dataActionsEl).display);
                    } else {
                        console.error('‚ùå dataActionsEl not found!');
                    }
                    
                    if (cleanDataBtn) {
                        cleanDataBtn.disabled = false;
                        cleanDataBtn.style.pointerEvents = 'auto';
                        cleanDataBtn.style.opacity = '1';
                        cleanDataBtn.style.cursor = 'pointer';
                        console.log('‚úÖ cleanDataBtn enabled');
                    }
                    
                    const saveCleanedBtn = document.getElementById('saveCleanedBtn');
                    if (saveCleanedBtn) {
                        saveCleanedBtn.style.display = 'none'; // Hide save button until cleaned
                    }
                    
                    console.log('‚úÖ All elements processed');
                }, 100);
        });
    })
    .catch(error => {
        console.error('Error loading data:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack
        });
        
        const dataDisplay = document.getElementById('dataDisplay');
        if (dataDisplay) {
            let errorMessage = error.message || 'Unknown error occurred';
            
            // Provide helpful error messages
            if (errorMessage.includes('License') || errorMessage.includes('license')) {
                errorMessage = 'License key required or invalid. Please check your license key.';
            } else if (errorMessage.includes('not found') || errorMessage.includes('404')) {
                errorMessage = 'File not found. Please check the filename.';
            }
            
            // Enhanced error display with helpful information
            let errorDetails = '';
            if (errorMessage.includes('File not found')) {
                errorDetails = `
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Searched locations:</strong><br>
                            ‚Ä¢ data/${filename}<br>
                            ‚Ä¢ data/downloaded/${filename}<br>
                            ‚Ä¢ data/stooq/${filename}<br>
                            ‚Ä¢ data/converted/**/${filename}<br>
                        </small>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Tip:</strong> Make sure the file exists in one of these directories.
                            You can download files using the Download tab.
                        </small>
                    </div>
                `;
            }
            
            dataDisplay.innerHTML = `
                <div class="text-center text-danger p-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h6>Error Loading Data</h6>
                    <p><strong>File:</strong> ${filename}</p>
                    <p>${errorMessage}</p>
                    ${errorDetails}
                    <small class="text-muted d-block mt-3">Check browser console for details</small>
                </div>
            `;
        } else {
            console.error('Data display container not found!');
        }
    });
}

// Display data table (like tkinter data_tree)
function displayDataTable(data) {
    console.log('displayDataTable called with:', data);
    console.log('displayDataTable - data.columns:', data.columns);
    console.log('displayDataTable - data.data:', data.data ? data.data.length : 0, 'rows');
    
    const dataDisplay = document.getElementById('dataDisplay');
    if (!dataDisplay) {
        console.error('Data display container not found');
        return;
    }

    // Validate data structure
    if (!data) {
        console.error('displayDataTable: No data received');
        dataDisplay.innerHTML = '<div class="text-center text-danger">No data received</div>';
        return;
    }
    
    // Ensure columns array exists
    console.log('displayDataTable: Checking columns. data.columns:', data.columns, 'Type:', typeof data.columns, 'Is array:', Array.isArray(data.columns));
    if (!data.columns || !Array.isArray(data.columns)) {
        console.log('displayDataTable: Columns missing or not array, attempting extraction');
        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
            // Extract columns from first row
            data.columns = Object.keys(data.data[0]);
            console.log('displayDataTable: Extracted columns from first row:', data.columns);
        } else {
            data.columns = [];
            console.warn('displayDataTable: No data to extract columns from');
        }
    } else {
        console.log('displayDataTable: Using existing columns array:', data.columns);
    }
    
    // Ensure total_rows exists
    const totalRows = data.total_rows !== undefined ? data.total_rows : (data.data ? data.data.length : 0);
    const filename = data.filename || 'Unknown file';
    
    // Ensure columns is always an array before accessing length
    const columnCount = (data.columns && Array.isArray(data.columns)) ? data.columns.length : 0;
    console.log('displayDataTable: Final columnCount:', columnCount, 'columns:', data.columns);
    
    // Data info
    let html = `
        <div class="data-info">
            <h6>üìÑ ${filename}</h6>
            <p class="mb-0"><strong>Rows:</strong> ${totalRows} | <strong>Columns:</strong> ${columnCount}</p>
        </div>
    `;
    
    if (data.data && data.data.length > 0 && columnCount > 0) {
        // Create table with proper Bootstrap styling
        html += '<div class="table-responsive" style="overflow-x: auto;">';
        html += '<table class="table table-striped table-hover table-sm" style="border-collapse: collapse; width: 100%;">';
        
        // Headers - use actual column names
        console.log('Creating table headers. Columns:', data.columns, 'Column count:', columnCount);
        
        // Determine columns to use
        let columnsToUse = [];
        if (data.columns && Array.isArray(data.columns) && data.columns.length > 0) {
            columnsToUse = data.columns;
            console.log('Using columns from data.columns:', columnsToUse);
        } else if (data.data && data.data.length > 0) {
            // Fallback: extract columns from first row
            columnsToUse = Object.keys(data.data[0]);
            console.log('Extracted columns from first row:', columnsToUse);
        } else {
            console.warn('No columns found and no data to extract from');
        }
        
        // Use CSS variables for theme-aware colors
        const root = getComputedStyle(document.documentElement);
        const darkColor = root.getPropertyValue('--dark-color').trim() || '#1e293b';
        const whiteColor = root.getPropertyValue('--text-white').trim() || '#ffffff';
        console.log('Using theme colors - dark:', darkColor, 'white:', whiteColor);
        
        // HTML escape function to prevent < > from being interpreted as HTML tags
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        html += `<thead class="table-dark" style="display: table-header-group !important; visibility: visible !important; opacity: 1 !important; height: auto !important; min-height: 40px !important; background-color: ${darkColor} !important;"><tr style="display: table-row !important;">`;
        if (columnsToUse.length > 0) {
            columnsToUse.forEach((col, index) => {
                // Fix: Handle undefined/null column names and HTML escape them
                const displayCol = (col !== null && col !== undefined && col !== '') ? String(col) : `Column_${index + 1}`;
                const escapedCol = escapeHtml(displayCol);  // Escape HTML to prevent < > from being interpreted as tags
                console.log(`Adding header ${index}: "${displayCol}" (escaped: "${escapedCol}") with background: ${darkColor}, color: ${whiteColor}`);
                html += `<th scope="col" style="background-color: ${darkColor} !important; color: ${whiteColor} !important; padding: 0.75rem !important; font-weight: 600 !important; display: table-cell !important; visibility: visible !important; opacity: 1 !important; border: 1px solid rgba(255,255,255,0.2) !important; min-height: 40px !important; height: auto !important; text-align: left !important; white-space: nowrap !important;">${escapedCol}</th>`;
            });
        } else {
            console.error('No columns available to display!');
            html += `<th scope="col" style="background-color: ${darkColor} !important; color: ${whiteColor} !important; display: table-cell !important; visibility: visible !important;">No Columns</th>`;
        }
        html += '</tr></thead>';
        
        // Data rows - display actual values
        html += '<tbody>';
        // Use the same columns array for data rows
        const columnsForRows = columnsToUse.length > 0 ? columnsToUse : (data.columns || []);
        data.data.slice(0, 100).forEach((row, index) => { // Limit to 100 rows like tkinter
            html += '<tr>';
            columnsForRows.forEach(col => {
                const value = row[col];
                // Format date values and numeric values properly
                const formattedValue = formatDateValue(value, col);
                let displayValue = '';
                if (formattedValue === null || formattedValue === undefined || formattedValue === '') {
                    displayValue = '';
                } else if (typeof formattedValue === 'number') {
                    // Format numbers with appropriate precision
                    displayValue = Number(formattedValue).toLocaleString();
                } else {
                    displayValue = String(formattedValue);
                }
                html += `<td>${displayValue}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
        
        if (data.data.length > 100) {
            html += `<p class="text-muted mt-2">Showing first 100 of ${data.data.length} rows</p>`;
        }
    } else {
        html += '<div class="text-center text-muted">No data found in file</div>';
    }
    
    dataDisplay.innerHTML = html;
}

// formatDateValue() is now loaded from redline/web/static/js/date-formatter.js
// No need to define it here - it's available globally from base.html

// Clean data (remove duplicates, handle missing values)
var cleanedData = null;

// Show clean data modal with options
function showCleanDataModal() {
    console.log('showCleanDataModal called');
    if (!window.currentData || !window.currentFile) {
        alert('Please load a file first.');
        return;
    }
    
    // Get form controls and ensure they are enabled BEFORE showing modal
    const removeDuplicates = document.getElementById('removeDuplicates');
    const handleMissing = document.getElementById('handleMissing');
    const cleanColumnNames = document.getElementById('cleanColumnNames');
    
    console.log('Form controls found:', {
        removeDuplicates: !!removeDuplicates,
        handleMissing: !!handleMissing,
        cleanColumnNames: !!cleanColumnNames
    });
    
    if (removeDuplicates) {
        removeDuplicates.disabled = false;
        removeDuplicates.removeAttribute('readonly');
        removeDuplicates.removeAttribute('style');
        removeDuplicates.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;');
        console.log('Enabled removeDuplicates');
    }
    if (handleMissing) {
        handleMissing.disabled = false;
        handleMissing.removeAttribute('readonly');
        handleMissing.removeAttribute('style');
        handleMissing.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important; background-color: #ffffff !important; color: #000000 !important;');
        console.log('Enabled handleMissing');
    }
    if (cleanColumnNames) {
        cleanColumnNames.disabled = false;
        cleanColumnNames.removeAttribute('readonly');
        cleanColumnNames.removeAttribute('style');
        cleanColumnNames.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;');
        console.log('Enabled cleanColumnNames');
    }
    
    // Show modal - try Bootstrap 5 first, then fallback to jQuery
    const modalElement = document.getElementById('cleanDataModal');
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
        modal.show();
        
        // Ensure form controls are enabled after modal shows
        modalElement.addEventListener('shown.bs.modal', function() {
            console.log('Modal shown (Bootstrap 5), enabling controls');
            setTimeout(() => {
                if (removeDuplicates) {
                    removeDuplicates.disabled = false;
                    removeDuplicates.removeAttribute('readonly');
                    removeDuplicates.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;');
                    console.log('‚úÖ removeDuplicates enabled in modal');
                }
                if (handleMissing) {
                    handleMissing.disabled = false;
                    handleMissing.removeAttribute('readonly');
                    handleMissing.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important; background-color: #ffffff !important; color: #000000 !important;');
                    console.log('‚úÖ handleMissing enabled in modal');
                }
                if (cleanColumnNames) {
                    cleanColumnNames.disabled = false;
                    cleanColumnNames.removeAttribute('readonly');
                    cleanColumnNames.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;');
                    console.log('‚úÖ cleanColumnNames enabled in modal');
                }
            }, 200);
        }, { once: true });
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
        $(modalElement).modal({
            backdrop: true,
            keyboard: true,
            show: true
        });
        $(modalElement).on('shown.bs.modal', function() {
            console.log('Modal shown (jQuery), enabling controls');
            setTimeout(() => {
                if (removeDuplicates) {
                    removeDuplicates.disabled = false;
                    removeDuplicates.removeAttribute('readonly');
                    removeDuplicates.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;');
                }
                if (handleMissing) {
                    handleMissing.disabled = false;
                    handleMissing.removeAttribute('readonly');
                    handleMissing.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important; background-color: #ffffff !important; color: #000000 !important;');
                }
                if (cleanColumnNames) {
                    cleanColumnNames.disabled = false;
                    cleanColumnNames.removeAttribute('readonly');
                    cleanColumnNames.setAttribute('style', 'cursor: pointer !important; pointer-events: auto !important; opacity: 1 !important;');
                }
            }, 200);
        });
    } else {
        // Fallback: show modal manually
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'cleanDataModalBackdrop';
        document.body.appendChild(backdrop);
    }
}

// Clean data with user-selected options
async function cleanDataWithOptions() {
    if (!window.currentData || !window.currentFile) {
        alert('Please load a file first.');
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to clean data.');
        return;
    }
    
    // Get options from form
    const removeDuplicates = document.getElementById('removeDuplicates').checked;
    const handleMissing = document.getElementById('handleMissing').value;
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('cleanDataModal'));
    if (modal) {
        modal.hide();
    }
    
    // Show loading
    const dataDisplay = document.getElementById('dataDisplay');
    const originalContent = dataDisplay.innerHTML;
    dataDisplay.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cleaning data...</span>
            </div>
            <p class="mt-2">Cleaning data...</p>
            <small class="text-muted">
                ${removeDuplicates ? 'Removing duplicates...' : ''} 
                ${handleMissing !== 'none' ? `Handling missing values (${handleMissing})...` : ''}
            </small>
        </div>
    `;
    
    try {
        const response = await fetch('/data/clean', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({
                filename: window.currentFile,
                remove_duplicates: removeDuplicates,
                handle_missing: handleMissing // Options: 'drop', 'forward_fill', 'backward_fill', 'none'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || result.message || `HTTP ${response.status}`);
        }
        
        // Store cleaned data
        cleanedData = result.data;
        
        // Display cleaned data
        displayDataTable({
            filename: result.filename || window.currentFile + ' (cleaned)',
            columns: result.columns || Object.keys(cleanedData[0] || {}),
            data: cleanedData,
            total_rows: result.total_rows || cleanedData.length
        });
        
        // Show save button
        document.getElementById('saveCleanedBtn').style.display = 'inline-block';
        
        // Show stats
        const stats = result.stats || {};
        let statsMsg = `Data cleaned successfully!\n\n`;
        statsMsg += `Original rows: ${result.original_rows || 'N/A'}\n`;
        statsMsg += `Final rows: ${result.total_rows || cleanedData.length}\n`;
        if (stats.duplicates_removed !== undefined && stats.duplicates_removed > 0) {
            statsMsg += `Duplicates removed: ${stats.duplicates_removed}\n`;
        }
        if (stats.missing_handled !== undefined && stats.missing_handled > 0) {
            statsMsg += `Missing values handled: ${stats.missing_handled}\n`;
        }
        statsMsg += `\nOptions used:\n`;
        statsMsg += `- Remove duplicates: ${removeDuplicates ? 'Yes' : 'No'}\n`;
        statsMsg += `- Handle missing: ${handleMissing}`;
        
        if (typeof window.showToast === 'function') {
            window.showToast('Data cleaned successfully', 'success');
        } else {
            alert(statsMsg);
        }
        
        console.log('Cleaning stats:', stats);
        console.log('Options used:', { remove_duplicates: removeDuplicates, handle_missing: handleMissing });
        
    } catch (error) {
        console.error('Error cleaning data:', error);
        dataDisplay.innerHTML = originalContent;
        alert(`Error cleaning data: ${error.message}`);
    }
}

// Save cleaned data
async function saveCleanedData() {
    if (!cleanedData || !window.currentFile) {
        alert('No cleaned data to save. Please clean the data first.');
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to save data.');
        return;
    }
    
    // Generate cleaned filename
    const originalName = window.currentFile.replace(/\.[^/.]+$/, '');
    const extension = window.currentFile.match(/\.[^/.]+$/)?.[0] || '.json';
    const cleanedFilename = `${originalName}_cleaned${extension}`;
    
    try {
        const response = await fetch('/data/save-cleaned', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({
                filename: cleanedFilename,
                data: cleanedData,
                columns: Object.keys(cleanedData[0] || {})
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || result.message || `HTTP ${response.status}`);
        }
        
        // Refresh file list
        refreshFileList();
        
        if (typeof window.showToast === 'function') {
            window.showToast(`Cleaned data saved as "${cleanedFilename}"`, 'success');
        } else {
            alert(`Cleaned data saved as "${cleanedFilename}"`);
        }
        
    } catch (error) {
        console.error('Error saving cleaned data:', error);
        alert(`Error saving cleaned data: ${error.message}`);
    }
}

// Show column editor modal
function showColumnEditor() {
    if (!window.currentColumns || window.currentColumns.length === 0) {
        alert('Please load a file first to edit column names.');
        return;
    }
    
    // Create modal dynamically
    const modalHtml = `
        <div class="modal fade" id="columnEditorModal" tabindex="-1" aria-labelledby="columnEditorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: var(--light-color); color: var(--text-primary);">
                        <h5 class="modal-title" id="columnEditorModalLabel">
                            <i class="fas fa-edit me-2"></i>Edit Column Names
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="background-color: var(--light-color); color: var(--text-primary);">
                        <p class="text-muted">Edit column names below. Changes will be applied to the displayed data.</p>
                        <div id="columnEditorList" class="list-group">
                            ${window.currentColumns.map((col, index) => `
                                <div class="list-group-item d-flex align-items-center">
                                    <label class="form-label mb-0 me-2" style="min-width: 150px;">Column ${index + 1}:</label>
                                    <input type="text" class="form-control column-name-input" data-original="${col}" value="${col}" data-index="${index}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer" style="background-color: var(--light-color); color: var(--text-primary);">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="applyColumnNames()">Apply Changes</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('columnEditorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('columnEditorModal'));
    modal.show();
    
    // Clean up on hide
    document.getElementById('columnEditorModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Apply column name changes
function applyColumnNames() {
    const inputs = document.querySelectorAll('.column-name-input');
    const newColumns = [];
    const columnMapping = {};
    
    inputs.forEach(input => {
        const original = input.getAttribute('data-original');
        const newName = input.value.trim() || original;
        const index = parseInt(input.getAttribute('data-index'));
        
        newColumns[index] = newName;
        if (original !== newName) {
            columnMapping[original] = newName;
        }
    });
    
    // Update global columns
    window.currentColumns = newColumns;
    
    // Update data with new column names
    if (window.currentData && window.currentData.length > 0) {
        const updatedData = window.currentData.map(row => {
            const newRow = {};
            Object.keys(row).forEach(oldKey => {
                const newKey = columnMapping[oldKey] || oldKey;
                newRow[newKey] = row[oldKey];
            });
            return newRow;
        });
        
        window.currentData = updatedData;
        
        // Re-render table
        displayDataTable({
            filename: window.currentFile || 'Current file',
            columns: window.currentColumns,
            data: window.currentData,
            total_rows: window.currentData.length
        });
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('columnEditorModal'));
    if (modal) {
        modal.hide();
    }
    
    if (typeof window.showToast === 'function') {
        window.showToast('Column names updated successfully', 'success');
    } else {
        alert('Column names updated successfully');
    }
}

// Format file size (like tkinter)
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}

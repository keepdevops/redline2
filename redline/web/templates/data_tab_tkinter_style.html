{% extends "base.html" %}

{% block title %}Data View - Single File{% endblock %}

{% block page_title %}Data View - Single File{% endblock %}
{% block page_subtitle %}View and manage your financial data files{% endblock %}

{% block extra_css %}
<style>
        /* Fix for overlapping widgets */
        body {
            position: relative;
            z-index: 1;
        }
        
        .container-fluid {
            position: relative;
            z-index: 1;
        }
        
        .row {
            position: relative;
            z-index: 1;
        }
        
        .card {
            position: relative;
            z-index: 2;
            margin-bottom: 20px;
        }
        
        .file-list-item {
            cursor: pointer;
            padding: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
            z-index: 3;
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        .file-list-item:hover {
            background-color: var(--secondary-color);
            color: var(--text-white);
        }
        .file-list-item.selected {
            background-color: var(--primary-color);
            color: var(--text-white);
        }
        .data-table {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 3;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
            position: relative;
            z-index: 3;
            color: var(--text-primary);
        }
        .data-info {
            background-color: var(--light-color);
            color: var(--text-primary);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            position: relative;
            z-index: 3;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .table th {
            background-color: var(--dark-color) !important;
            color: var(--text-white) !important;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table td {
            vertical-align: middle;
            position: relative;
            z-index: 1;
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            z-index: 3;
        }
        
        /* Ensure proper stacking context */
        .card {
            background-color: var(--light-color);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .card-body {
            position: relative;
            z-index: 3;
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        
        .card-header {
            position: relative;
            z-index: 4;
            background-color: var(--light-color);
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }
        
        /* Dark mode support */
        body.theme-dark .card,
        body.theme-dark .card-body,
        body.theme-dark .card-header {
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        
        body.theme-dark .table td {
            background-color: var(--light-color);
            color: var(--text-primary);
        }
        
        body.theme-dark .file-list-item {
            background-color: var(--light-color);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        body.theme-dark .data-info {
            background-color: var(--dark-color);
            color: var(--text-white);
        }
        
        /* Fix for any floating elements */
        .btn-group {
            position: relative;
            z-index: 5;
        }
        
        /* Ensure data display doesn't overlap */
        #dataDisplay {
            position: relative;
            z-index: 3;
            min-height: 200px;
        }
        
        #fileList {
            position: relative;
            z-index: 3;
            min-height: 200px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="/data/" class="btn btn-outline-primary active">Single File View</a>
                <a href="/data/multi" class="btn btn-outline-primary">Multi-File View</a>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- File List Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìÅ Files</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshFileList()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="fileList">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Loading files...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Display Panel -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìä Data View</h5>
                    <div id="dataActions" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary" onclick="cleanData()" title="Clean data (remove duplicates, handle missing values)">
                            <i class="fas fa-broom"></i> Clean Data
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="saveCleanedData()" title="Save cleaned data to file" style="display: none;" id="saveCleanedBtn">
                            <i class="fas fa-save"></i> Save Cleaned
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="dataDisplay">
                        <div class="text-center text-muted">
                            <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                            <p>Click on a file to load its data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables - attach to window to ensure global scope
window.currentFile = null;
window.currentData = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Tkinter-style data view loaded');
    refreshFileList();
});

// Refresh file list (like tkinter refresh)
function refreshFileList() {
    console.log('Refreshing file list...');
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    const fileListDiv = document.getElementById('fileList');
    fileListDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading files...</div>';
    
    fetch('/api/files', {
        method: 'GET',
        headers: licenseKey ? { 'X-License-Key': licenseKey } : {}
    })
        .then(response => {
            // Check if response is OK
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `HTTP ${response.status}: ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Files loaded:', data.files ? data.files.length : 0);
            if (data.files && Array.isArray(data.files)) {
                displayFileList(data.files);
            } else {
                console.warn('Invalid response format:', data);
                displayFileList([]);
            }
        })
        .catch(error => {
            console.error('Error loading files:', error);
            const errorMsg = error.message || 'Unknown error occurred';
            fileListDiv.innerHTML = `
                <div class="text-center text-danger p-3">
                    <i class="fas fa-exclamation-triangle mb-2"></i>
                    <div><strong>Error loading files</strong></div>
                    <small class="text-muted">${errorMsg}</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="loadFileList()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>
            `;
        });
}

// Display file list (like tkinter file listbox)
function displayFileList(files) {
    const fileListDiv = document.getElementById('fileList');
    
    if (files.length === 0) {
        fileListDiv.innerHTML = '<div class="text-center text-muted">No files found</div>';
        return;
    }
    
    let html = '';
    files.forEach(file => {
        const fileSize = formatFileSize(file.size || 0);
        const modifiedDate = new Date(file.modified * 1000).toLocaleDateString();
        
        html += `
            <div class="file-list-item d-flex justify-content-between align-items-center" onclick="event.stopPropagation();">
                <div class="flex-grow-1" onclick="loadFileData('${file.name}')" style="cursor: pointer;">
                    <div class="fw-bold">${file.name}</div>
                    <small class="text-muted">${fileSize} ‚Ä¢ ${modifiedDate}</small>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFile('${file.name}', event)" title="Delete file">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    });
    
    fileListDiv.innerHTML = html;
}

// Delete file
async function deleteFile(filename, event) {
    if (event) event.stopPropagation();
    
    if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to delete files.');
        return;
    }
    
    try {
        const response = await fetch(`/api/files/${encodeURIComponent(filename)}`, {
            method: 'DELETE',
            headers: {
                'X-License-Key': licenseKey
            }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || data.message || `HTTP ${response.status}`);
        }
        
        // Show success message
        console.log('File deleted successfully:', filename);
        
        // Refresh file list
        refreshFileList();
        
        // If the deleted file was currently loaded, clear the display
        if (window.currentFile === filename) {
            window.currentFile = null;
            window.currentData = null;
            document.getElementById('dataDisplay').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-mouse-pointer fa-2x mb-3"></i>
                    <p>Click on a file to load its data</p>
                </div>
            `;
            document.getElementById('dataActions').style.display = 'none';
        }
        
        // Show toast notification if available
        if (typeof window.showToast === 'function') {
            window.showToast(`File "${filename}" deleted successfully`, 'success');
        } else {
            alert(`File "${filename}" deleted successfully`);
        }
        
    } catch (error) {
        console.error('Error deleting file:', error);
        alert(`Error deleting file: ${error.message}`);
    }
}

// Load file data (like tkinter refresh_data)
function loadFileData(filename) {
    console.log('Loading data for file:', filename);
    
    // Update selected file
    document.querySelectorAll('.file-list-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.target.closest('.file-list-item').classList.add('selected');
    
    // Show loading spinner
    const dataDisplay = document.getElementById('dataDisplay');
    dataDisplay.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading ${filename}...</p>
        </div>
    `;
    
    // Get license key - use global function if available, otherwise fallback
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        console.error('No license key found!');
        dataDisplay.innerHTML = `
            <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle"></i> License key is required. Please register or enter your license key.
            </div>
        `;
        return;
    }
    
    // Load data
    fetch('/data/load', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-License-Key': licenseKey
        },
        body: JSON.stringify({ 
            filename: filename,
            license_key: licenseKey
        })
    })
    .then(response => {
        // Always parse JSON first
        return response.json().then(data => {
            // Check HTTP status and response structure
            if (!response.ok) {
                // HTTP error (4xx, 5xx)
                const errorMsg = data.error || data.message || `HTTP ${response.status}: ${response.statusText}`;
                throw new Error(errorMsg);
            }
            
            // Check for error in response body (even if HTTP status is 200)
            if (data.error || data.code) {
                throw new Error(data.error || data.message || 'Unknown error');
            }
            
            // Validate response structure - must have columns or data
            if (!data || typeof data !== 'object') {
                throw new Error('Invalid response format: response is not an object');
            }
            
            // Ensure columns array exists
            if (!data.columns || !Array.isArray(data.columns)) {
                console.warn('Response missing columns array, attempting to extract:', data);
                // Try to extract columns from data if available
                if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                    data.columns = Object.keys(data.data[0]);
                    console.log('Extracted columns from data:', data.columns);
                } else {
                    data.columns = [];
                    console.warn('No columns found and no data to extract from');
                }
            }
            
            // Ensure total_rows exists
            if (data.total_rows === undefined || data.total_rows === null) {
                data.total_rows = (data.data && Array.isArray(data.data)) ? data.data.length : 0;
            }
            
            // Ensure filename exists
            if (!data.filename) {
                data.filename = filename;
            }
            
            // Ensure data array exists
            if (!data.data || !Array.isArray(data.data)) {
                data.data = [];
            }
            
            // Safe logging - all checks done above
            console.log('Data loaded successfully:', {
                filename: data.filename,
                total_rows: data.total_rows,
                column_count: (data.columns && Array.isArray(data.columns)) ? data.columns.length : 0,
                columns: data.columns || [],
                data_rows: (data.data && Array.isArray(data.data)) ? data.data.length : 0
            });
            
                window.currentFile = filename;
                window.currentData = data.data;
                displayDataTable(data);
                
                // Show data actions buttons
                document.getElementById('dataActions').style.display = 'block';
                document.getElementById('saveCleanedBtn').style.display = 'none'; // Hide save button until cleaned
        });
    })
    .catch(error => {
        console.error('Error loading data:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack
        });
        
        const dataDisplay = document.getElementById('dataDisplay');
        if (dataDisplay) {
            let errorMessage = error.message || 'Unknown error occurred';
            
            // Provide helpful error messages
            if (errorMessage.includes('License') || errorMessage.includes('license')) {
                errorMessage = 'License key required or invalid. Please check your license key.';
            } else if (errorMessage.includes('not found') || errorMessage.includes('404')) {
                errorMessage = 'File not found. Please check the filename.';
            }
            
            // Enhanced error display with helpful information
            let errorDetails = '';
            if (errorMessage.includes('File not found')) {
                errorDetails = `
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Searched locations:</strong><br>
                            ‚Ä¢ data/${filename}<br>
                            ‚Ä¢ data/downloaded/${filename}<br>
                            ‚Ä¢ data/stooq/${filename}<br>
                            ‚Ä¢ data/converted/**/${filename}<br>
                        </small>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <strong>Tip:</strong> Make sure the file exists in one of these directories.
                            You can download files using the Download tab.
                        </small>
                    </div>
                `;
            }
            
            dataDisplay.innerHTML = `
                <div class="text-center text-danger p-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h6>Error Loading Data</h6>
                    <p><strong>File:</strong> ${filename}</p>
                    <p>${errorMessage}</p>
                    ${errorDetails}
                    <small class="text-muted d-block mt-3">Check browser console for details</small>
                </div>
            `;
        } else {
            console.error('Data display container not found!');
        }
    });
}

// Display data table (like tkinter data_tree)
function displayDataTable(data) {
    const dataDisplay = document.getElementById('dataDisplay');
    if (!dataDisplay) {
        console.error('Data display container not found');
        return;
    }
    
    // Validate data structure
    if (!data) {
        dataDisplay.innerHTML = '<div class="text-center text-danger">No data received</div>';
        return;
    }
    
    // Ensure columns array exists
    if (!data.columns || !Array.isArray(data.columns)) {
        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
            // Extract columns from first row
            data.columns = Object.keys(data.data[0]);
        } else {
            data.columns = [];
        }
    }
    
    // Ensure total_rows exists
    const totalRows = data.total_rows !== undefined ? data.total_rows : (data.data ? data.data.length : 0);
    const filename = data.filename || 'Unknown file';
    
    // Ensure columns is always an array before accessing length
    const columnCount = (data.columns && Array.isArray(data.columns)) ? data.columns.length : 0;
    
    // Data info
    let html = `
        <div class="data-info">
            <h6>üìÑ ${filename}</h6>
            <p class="mb-0"><strong>Rows:</strong> ${totalRows} | <strong>Columns:</strong> ${columnCount}</p>
        </div>
    `;
    
    if (data.data && data.data.length > 0 && columnCount > 0) {
        // Create table with proper Bootstrap styling
        html += '<div class="table-responsive">';
        html += '<table class="table table-striped table-hover table-sm">';
        
        // Headers - use actual column names
        html += '<thead class="table-dark"><tr>';
        data.columns.forEach(col => {
            // Fix: Handle undefined/null column names
            const displayCol = (col !== null && col !== undefined && col !== '') ? col : 'Column';
            html += `<th scope="col">${displayCol}</th>`;
        });
        html += '</tr></thead>';
        
        // Data rows - display actual values
        html += '<tbody>';
        data.data.slice(0, 100).forEach((row, index) => { // Limit to 100 rows like tkinter
            html += '<tr>';
            data.columns.forEach(col => {
                const value = row[col];
                // Format numeric values properly
                let displayValue = '';
                if (value === null || value === undefined) {
                    displayValue = '';
                } else if (typeof value === 'number') {
                    // Format numbers with appropriate precision
                    displayValue = Number(value).toLocaleString();
                } else {
                    displayValue = String(value);
                }
                html += `<td>${displayValue}</td>`;
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '</div>';
        
        if (data.data.length > 100) {
            html += `<p class="text-muted mt-2">Showing first 100 of ${data.data.length} rows</p>`;
        }
    } else {
        html += '<div class="text-center text-muted">No data found in file</div>';
    }
    
    dataDisplay.innerHTML = html;
}

// Clean data (remove duplicates, handle missing values)
var cleanedData = null;

async function cleanData() {
    if (!window.currentData || !window.currentFile) {
        alert('Please load a file first.');
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to clean data.');
        return;
    }
    
    // Show loading
    const dataDisplay = document.getElementById('dataDisplay');
    const originalContent = dataDisplay.innerHTML;
    dataDisplay.innerHTML = `
        <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cleaning data...</span>
            </div>
            <p class="mt-2">Cleaning data...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/data/clean', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({
                filename: window.currentFile,
                remove_duplicates: true,
                handle_missing: 'drop' // Options: 'drop', 'forward_fill', 'backward_fill'
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || result.message || `HTTP ${response.status}`);
        }
        
        // Store cleaned data
        cleanedData = result.data;
        
        // Display cleaned data
        displayDataTable({
            filename: result.filename || window.currentFile + ' (cleaned)',
            columns: result.columns || Object.keys(cleanedData[0] || {}),
            data: cleanedData,
            total_rows: result.total_rows || cleanedData.length
        });
        
        // Show save button
        document.getElementById('saveCleanedBtn').style.display = 'inline-block';
        
        // Show stats
        const stats = result.stats || {};
        let statsMsg = `Data cleaned successfully!\n\n`;
        if (stats.duplicates_removed) {
            statsMsg += `Duplicates removed: ${stats.duplicates_removed}\n`;
        }
        if (stats.missing_handled) {
            statsMsg += `Missing values handled: ${stats.missing_handled}\n`;
        }
        statsMsg += `Total rows: ${result.total_rows || cleanedData.length}`;
        
        if (typeof window.showToast === 'function') {
            window.showToast('Data cleaned successfully', 'success');
        } else {
            alert(statsMsg);
        }
        
    } catch (error) {
        console.error('Error cleaning data:', error);
        dataDisplay.innerHTML = originalContent;
        alert(`Error cleaning data: ${error.message}`);
    }
}

// Save cleaned data
async function saveCleanedData() {
    if (!cleanedData || !window.currentFile) {
        alert('No cleaned data to save. Please clean the data first.');
        return;
    }
    
    // Get license key
    const licenseKey = (typeof window.getLicenseKey === 'function') 
        ? window.getLicenseKey() 
        : (localStorage.getItem('redline_license_key') || window.REDLINE_LICENSE_KEY);
    
    if (!licenseKey) {
        alert('License key is required to save data.');
        return;
    }
    
    // Generate cleaned filename
    const originalName = window.currentFile.replace(/\.[^/.]+$/, '');
    const extension = window.currentFile.match(/\.[^/.]+$/)?.[0] || '.json';
    const cleanedFilename = `${originalName}_cleaned${extension}`;
    
    try {
        const response = await fetch('/data/save-cleaned', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-License-Key': licenseKey
            },
            body: JSON.stringify({
                filename: cleanedFilename,
                data: cleanedData,
                columns: Object.keys(cleanedData[0] || {})
            })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || result.message || `HTTP ${response.status}`);
        }
        
        // Refresh file list
        refreshFileList();
        
        if (typeof window.showToast === 'function') {
            window.showToast(`Cleaned data saved as "${cleanedFilename}"`, 'success');
        } else {
            alert(`Cleaned data saved as "${cleanedFilename}"`);
        }
        
    } catch (error) {
        console.error('Error saving cleaned data:', error);
        alert(`Error saving cleaned data: ${error.message}`);
    }
}

// Format file size (like tkinter)
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
</script>
{% endblock %}

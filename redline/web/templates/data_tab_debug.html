{% extends "base.html" %}

{% block title %}Data Tab Debug - REDLINE{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Data Tab Debug</h2>
            
            <!-- Debug Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Debug Information</h5>
                </div>
                <div class="card-body">
                    <div id="debug-info">
                        <p>Loading debug information...</p>
                    </div>
                </div>
            </div>
            
            <!-- File Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>File Selection</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="fileSelect" class="form-label">Select File:</label>
                        <select id="fileSelect" class="form-select">
                            <option value="">Loading files...</option>
                        </select>
                    </div>
                    <button id="loadFabtn" class="btn btn-primary">Load File</button>
                    <button id="refreshBtn" class="btn btn-secondary">Refresh Files</button>
                </div>
            </div>
            
            <!-- Results -->
            <div class="card">
                <div class="card-header">
                    <h5>Results</h5>
                </div>
                <div class="card-body">
                    <div id="results">
                        <p>No data loaded yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Debug page loaded');
    
    // Test API call immediately
    testApiCall();
    
    // Load files
    loadFiles();
    
    // Event handlers
    $('#loadFabtn').click(function() {
        const selectedFile = $('#fileSelect').val();
        if (selectedFile) {
            loadFile(selectedFile);
        }
    });
    
    $('#refreshBtn').click(function() {
        loadFiles();
    });
});

function testApiCall() {
    console.log('Testing API call...');
    $.ajax({
        url: '/api/files',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log('API call successful:', response);
            $('#debug-info').html(`
                <p><strong>API Status:</strong> Success</p>
                <p><strong>Files Found:</strong> ${response.files ? response.files.length : 0}</p>
                <p><strong>Response:</strong> <pre>${JSON.stringify(response, null, 2)}</pre></p>
            `);
        },
        error: function(xhr, status, error) {
            console.error('API call failed:', error);
            $('#debug-info').html(`
                <p><strong>API Status:</strong> Error</p>
                <p><strong>Error:</strong> ${error}</p>
                <p><strong>Status:</strong> ${status}</p>
                <p><strong>Response:</strong> ${xhr.responseText}</p>
            `);
        }
    });
}

function loadFiles() {
    console.log('Loading files...');
    $.ajax({
        url: '/api/files',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log('Files loaded:', response);
            const select = $('#fileSelect');
            select.empty();
            select.append('<option value="">Select a file...</option>');
            
            if (response.files && response.files.length > 0) {
                response.files.forEach(function(file) {
                    select.append(`<option value="${file.name}">${file.name}</option>`);
                });
            } else {
                select.append('<option value="">No files found</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading files:', error);
            $('#fileSelect').html('<option value="">Error loading files</option>');
        }
    });
}

function loadFile(filename) {
    console.log('Loading file:', filename);
    $('#results').html('<p>Loading file data...</p>');
    
    $.ajax({
        url: '/data/load',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ filename: filename }),
        dataType: 'json',
        success: function(response) {
            console.log('File loaded:', response);
            $('#results').html(`
                <p><strong>File:</strong> ${response.filename}</p>
                <p><strong>Rows:</strong> ${response.total_rows}</p>
                <p><strong>Columns:</strong> ${response.columns ? response.columns.length : 0}</p>
                <p><strong>Columns:</strong> ${response.columns ? response.columns.join(', ') : 'None'}</p>
                <p><strong>First 3 rows:</strong></p>
                <pre>${JSON.stringify(response.data ? response.data.slice(0, 3) : [], null, 2)}</pre>
            `);
        },
        error: function(xhr, status, error) {
            console.error('Error loading file:', error);
            $('#results').html(`<p class="text-danger">Error loading file: ${error}</p>`);
        }
    });
}
</script>
{% endblock %}
